<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>معالج الأسئلة</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.css" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
        <style>
        /* --- Basic Setup --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            /* MODIFIED: Changed font to Tajawal and added a base line-height */
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px; color: #333;
            display: flex; align-items: center; justify-content: center;
        }
        /* --- Main Container --- */
        .container {
            width: 100%; max-width: 1600px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden;
        }
        /* --- Header --- */
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white; padding: 30px; text-align: center; position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); position: relative; z-index: 1; }
        .header p { font-size: 1.2em; opacity: 0.9; position: relative; z-index: 1; }
        .ai-badge {
            position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px; border-radius: 20px; font-size: 0.9em; backdrop-filter: blur(10px);
        }
        /* --- Content Layout --- */
        .content {
            padding: 40px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px;
        }
        .panel {
            background: #f8fafc; border-radius: 15px; padding: 25px; border: 2px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; display: flex; flex-direction: column;
        }
        .panel:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .panel h3 { color: #4f46e5; margin-bottom: 20px; font-size: 1.3em; display: flex; align-items: center; gap: 10px; }
        .question-type-selector {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;
        }
        .q-type-btn { padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; background-color: #fff; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 600; color: #475569; text-align: center; }
        .q-type-btn:hover { background-color: #f1f5f9; border-color: #cbd5e1; }
        .q-type-btn.active { background-color: #e0e7ff; border-color: #4f46e5; color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .input-section textarea, .edit-textarea {
            /* MODIFIED: Font, size, and line-height for better readability */
            width: 100%; min-height: 250px; padding: 20px; border: 2px solid #e5e7eb; border-radius: 15px;
            font-size: 16px; 
            line-height: 1.7; 
            resize: vertical; transition: all 0.3s ease;
            background: #fdfdff; 
            font-family: 'Tajawal', monospace; 
            margin-bottom: 10px;
        }
        .input-section textarea:focus, .edit-textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .api-key-section { margin-top: 15px; }
        .api-key-section input, .api-key-section select {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; margin-bottom: 10px;
        }
        .api-key-section input:focus, .api-key-section select:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .controls .btn { flex-grow: 1; }
        .btn {
            padding: 15px 20px; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn:hover:before { left: 100%; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 2px solid #d1d5db; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; border-color: #9ca3af; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-ai { background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%); color: white; }
        .btn-ai:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3); }
        .json-output {
            background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 12px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.4; overflow-x: auto; white-space: pre-wrap; max-height: 500px; overflow-y: auto; border: 1px solid #334155; flex-grow: 1; margin-top: 15px;
        }
        .json-output .key { color: #60a5fa; } .json-output .string { color: #34d399; } .json-output .number { color: #fbbf24; }
        .json-output .boolean { color: #f87171; } .json-output .null { color: #a78bfa; }
        .analysis-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .analysis-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9em; }
        .analysis-item:last-child { border-bottom: none; }
        .confidence-bar { width: 100px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); border-radius: 4px; transition: width 0.5s ease-in-out; }
        #questionsPreview { flex-grow: 1; overflow-y: auto; max-height: 70vh; }
        .question-preview { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); animation: fadeIn 0.5s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .question-actions { position: absolute; top: 10px; left: 10px; display: none; gap: 8px; z-index: 10; }
        .question-preview:hover .question-actions { display: flex; }
        .action-btn { background: rgba(249, 250, 251, 0.8); border: 1px solid #d1d5db; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; backdrop-filter: blur(2px); }
        .action-btn:hover { background: #4f46e5; border-color: #4f46e5; color: white; transform: scale(1.1); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #e5e7eb; }
        .validation-warning {
            position: absolute;
            top: 15px;
            left: 50px;
            font-size: 1.2em;
            cursor: help;
        }
        .question-preview h4, .question-preview .statement-preview { color: #374151; margin-bottom: 10px; font-size: 1.1em; line-height: 1.5; }
        .part-preview { border-top: 2px dashed #a5b4fc; margin-top: 15px; padding-top: 15px; }
        .part-preview h5 { color: #4338ca; font-size: 1em; margin-bottom: 8px; }
        .question-type-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px; }
        .type-mcq { background: #dbeafe; color: #1e40af; } .type-mrq { background: #e0e7ff; color: #3730a3; } .type-matching { background: #e0e7ff; color: #3730a3; }
        .type-gapText { background: #d1fae5; color: #065f46; } .type-string { background: #fef3c7; color: #92400e; }
        .type-frq { background: #fce7f3; color: #be185d; } .type-frq_ai { background: #fce7f3; color: #be185d; }
        .type-oq { background: #fef9c3; color: #854d0e; } .type-input_box { background: #f3e8ff; color: #6b21a8; } .type-unknown { background: #fee2e2; color: #991b1b; }
        .choice-item { padding: 8px 15px; margin: 5px 0; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .part-preview[data-interactive="true"] .choice-item { cursor: pointer; }
        .part-preview[data-interactive="true"] .choice-item:hover { background: #f3f4f6; border-color: #4f46e5; }
        .choice-item.correct { background: #dcfce7; border-color: #16a34a; color: #15803d; font-weight: bold; }
        .choice-item.correct::before { content: '✔ '; color: #15803d; }
        .matching-preview { display: flex; gap: 20px; }
        .matching-column { flex: 1; }
        .matching-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
        .gapped-text-answers { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; }
        .gapped-text-answers strong { color: #4f46e5; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); }
        .stat-card h4 { color: #4f46e5; margin-bottom: 10px; font-size: 0.9em; }
        .stat-card span { font-size: 2em; font-weight: bold; color: #1f2937; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        .btn .spinner { width: 20px; height: 20px; margin: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .message { padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); animation: slideIn 0.5s ease, fadeOut 0.5s ease 3.5s forwards; font-weight: 500; min-width: 300px; text-align: center; position: relative; }
        .message.error { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .message.success { background: #dcfce7; color: #065f46; border: 1px solid #a7f3d0; }
        .message.warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .message .close-x { position: absolute; top: 6px; left: 8px; cursor: pointer; font-weight: bold; opacity: .6; }
        @keyframes slideIn { from { transform: translateY(-50px) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }
        #csvModalBg, #aiTemplateModalBg, #subjectTemplateModalBg, #generationModalBg {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25); z-index: 3000; align-items: center; justify-content: center;
        }
        #csvModal, #aiTemplateModal, #subjectTemplateModal {
            background: white; border-radius: 16px; max-width: 1200px; width: 95vw; padding: 32px 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); position: relative; min-height: 600px; min-width: 900px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #csvModal .hot-container, #aiTemplateModal .hot-container { margin-bottom: 18px; width: 100%; }
        #csvModal .btn, #aiTemplateModal .btn, #subjectTemplateModal .btn { min-width: 120px; }
        #csvModal .csv-warning { color: #dc2626; font-weight: bold; margin-bottom: 10px; }
        
        math-field {
            border: 1px solid #ddd; padding: 2px 5px; border-radius: 4px; font-size: 1.1em; 
            display: inline-block; background: #f9f9f9;
            min-width: 20px;
            vertical-align: -0.25em;
        }
        math-field:focus-within {
            background-color: #eef2ff;
            box-shadow: 0 0 0 2px #4f46e5;
            outline: none;
        }

        /* === START: NEW JUSTIFICATION & READABILITY STYLES === */
        /* This selector targets the <p> tags generated by the script inside the preview areas */
        .LexicalTheme__paragraph {
            text-align: justify;
            line-height: 1.75; /* Increased for better readability */
            margin-bottom: 0.5em; /* Adds a little space between paragraphs */
        }
        /* === END: NEW JUSTIFICATION & READABILITY STYLES === */

        /* --- Tags Modal --- */
        #tagsModal {
            display: none;
            position: fixed;
            top: 150px;
            left: 150px;
            width: 380px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 4000;
            border: 1px solid #ccc;
        }
        #tagsModalHeader {
            padding: 12px 15px;
            cursor: move;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #475569;
        }
        #tags-modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
            line-height: 1;
        }
        #tagsModalBody {
            padding: 15px;
        }
        .tags-section h4 {
            font-size: 1em;
            color: #4f46e5;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e0e7ff;
        }
        .tags-grid {
             display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .tag-btn {
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .tag-btn:hover {
            background: #e0e7ff;
            border-color: #4f46e5;
            color: #4f46e5;
        }
        
        /* --- Generation Modal --- */
        #generationModal {
            background: white; border-radius: 16px; max-width: 1200px; width: 95vw; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); position: relative; 
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .generation-header {
            padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;
        }
        .generation-header h2 { color: #4f46e5; }
        .generation-content {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;
            padding: 1.5rem; overflow-y: auto;
        }
        .generation-column h4 { margin-bottom: 1rem; color: #4338ca; }
        .generation-footer {
            padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; text-align: left;
        }
        #gen-image-drop-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 2rem; text-align: center;
            color: #64748b; cursor: pointer; transition: all 0.2s ease;
        }
        #gen-image-drop-zone.dragover { background: #eef2ff; border-color: #4f46e5; }
        #gen-image-preview { margin-top: 1rem; max-width: 100%; max-height: 150px; border-radius: 8px; }
        .gen-q-type-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .gen-q-type-row label { font-weight: 500; }
        .gen-q-type-row input { width: 60px; padding: 5px 8px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; }
        #gen-multi-part-types { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; margin-top: 5px; }


        @media (max-width: 1200px) { .content { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            body { padding: 10px; } .content { grid-template-columns: 1fr; padding: 20px; }
            .header h1 { font-size: 2em; } .header p { font-size: 1em; }
            .controls { flex-direction: column; } .btn { width: 100%; } .question-type-selector { grid-template-columns: 1fr 1fr; }
            .generation-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="messageContainer" class="message-container"></div>
    <div class="container">
        <div class="header">
            <div class="ai-badge">🤖 AI Powered</div>
            <h1 id="main-title">🚀 محول الأسئلة الذكي المتطور</h1>
            <p id="main-subtitle">حوّل نصوص الأسئلة إلى صيغة JSON متقدمة بضغطة زر</p>
        </div>
        <div class="content">
                        <div class="panel">
                <h3 id="panel-title-1"><span style="font-size: 1.5em; line-height: 1;">①</span> اختر نوع السؤال (للنص البسيط)</h3>
                <div id="questionTypeSelector" class="question-type-selector"></div>
                <h3 id="panel-title-2" style="margin-top: 20px;"><span style="font-size: 1.5em; line-height: 1;">②</span> أدخل النص</h3>
                <div class="input-section">
                    <textarea id="questionInput" placeholder="أدخل محتوى السؤال هنا...
سيتم تجاهل أي بيانات وصفية مثل id أو language (ما عدا type الذي سيضاف تلقائيًا).
استخدم الوسوم مثل @STEM و @CHOICES لتحديد أجزاء السؤال.
افصل بين كل سؤال بـ ---
"></textarea>
                </div>
                <div class="api-key-section">
                    <select id="aiProviderSelect">
                        <option value="gemini" selected>Google Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                    <div id="gemini-key-container">
                        <input type="password" id="geminiApiKey" placeholder="🔑 أدخل مفتاح Gemini API هنا">
                    </div>
                    <div id="openai-key-container" style="display: none;">
                        <input type="password" id="openaiApiKey" placeholder="🔑 أدخل مفتاح OpenAI API هنا">
                    </div>
                </div>
                <div class="controls">
                    <button id="generate-questions-btn" class="btn btn-primary" aria-label="توليد أسئلة">🚀 توليد أسئلة</button>
                    <button id="smart-analyze-btn" class="btn btn-primary" aria-label="تحليل ذكي">🤖 تحليل ذكي</button>
                </div>
                 <div class="controls">
                    <button id="clean-format-btn" class="btn btn-secondary" aria-label="تنظيف وتنسيق">✨ تنظيف وتنسيق</button>
                    <button id="aiEnhanceBtn" class="btn btn-ai" aria-label="تحسين بالذكاء الاصطناعي">💎 تحسين بالـ AI</button>
                </div>
                <div class="controls">
                    <button id="convert-json-btn" class="btn btn-success" aria-label="تحويل إلى JSON">🔄 تحويل لـ JSON</button>
                    <button id="customizeBtn" class="btn btn-secondary" aria-label="تخصيص">⚙️ تخصيص</button>
                    <button id="tagsBtn" class="btn btn-secondary" aria-label="إدراج وسم">🏷️ Tags</button>
                    <button id="clear-all-btn" class="btn btn-secondary" aria-label="مسح الكل">🗑️ مسح الكل</button>
                    <button id="langSwitchBtn" class="btn btn-warning" aria-label="تبديل اللغة">🌐 English</button>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loading-text">جاري التحليل...</p>
                </div>
            </div>
                        <div class="panel">
                <h3 id="panel-title-3">🔍 تحليل ومخرجات</h3>
                <div class="analysis-section" id="analysisSection">
                    <div class="analysis-item"><span id="analysis-label-1">جودة الكشف:</span><div class="confidence-bar"><div id="detectionQuality" class="confidence-fill" style="width: 0%"></div></div></div>
                    <div class="analysis-item"><span id="analysis-label-2">دقة التصنيف:</span><div class="confidence-bar"><div id="classificationAccuracy" class="confidence-fill" style="width: 0%"></div></div></div>
                    <div class="analysis-item"><span id="analysis-label-3">اكتمال البيانات:</span><div class="confidence-bar"><div id="dataCompleteness" class="confidence-fill" style="width: 0%"></div></div></div>
                </div>
                <div class="stats" id="stats">
                    <div class="stat-card"><h4 id="stats-label-1">إجمالي الأسئلة</h4><span id="totalQuestions">0</span></div>
                    <div class="stat-card"><h4 id="stats-label-2">معدل الثقة</h4><span id="confidenceScore">0%</span></div>
                </div>
                <div class="json-output" id="jsonOutput" style="display: none;"></div>
                <div class="controls" style="margin-top: auto;">
                    <button id="copyBtn" class="btn btn-secondary" disabled aria-label="نسخ JSON">📋 نسخ JSON</button>
                    <button id="downloadBtn" class="btn btn-warning" disabled aria-label="تحميل JSON">💾 تحميل</button>
                    <button id="downloadZipBtn" class="btn btn-warning" disabled aria-label="تحميل ZIP">🗜️ تحميل كـ ZIP</button>
                    <button id="csvBtn" class="btn btn-secondary" disabled aria-label="CSV">📄 CSV</button>
                </div>
            </div>
                        <div class="panel">
                <h3 id="panel-title-4">👁️ معاينة الأسئلة</h3>
                <div id="questionsPreview">
                    <div id="preview-placeholder" style="text-align: center; color: #6b7280; padding: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                        <p>ستظهر معاينة الأسئلة هنا بعد التحليل</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div id="customizeModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;" role="dialog" aria-modal="true" aria-labelledby="customize-title">
        <div style="background:white; border-radius:16px; max-width:400px; width:90vw; padding:32px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.15); position:relative;">
            <button id="customize-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="customize-title" style="text-align:center; margin-bottom:24px; color:#4f46e5;">تخصيص الإعدادات</h2>
            <div style="margin-bottom:18px;">
                <label for="categorySelect" style="font-weight:bold;">Category</label>
                <select id="categorySelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="lesson" selected>lesson</option>
                    <option value="exam">exam</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="directionSelect" style="font-weight:bold;">اتجاه الترتيب (OQ)</label>
                <select id="directionSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="vertical" selected>Vertical (عمودي)</option>
                    <option value="horizontal">Horizontal (أفقي)</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="langSelect" style="font-weight:bold;">Lang</label>
                <select id="langSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="ar" selected>ar</option>
                    <option value="en">en</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="countrySelect" style="font-weight:bold;">Country</label>
                <select id="countrySelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="eg" selected>eg</option>
                    <option value="sa">sa</option>
                    <option value="ae">ae</option>
                    <option value="kw">kw</option>
                    <option value="qa">qa</option>
                    <option value="bh">bh</option>
                    <option value="om">om</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="sourceIdSelect" style="font-weight:bold;">Source ID (Name)</label>
                <select id="sourceIdSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="qa">qa</option>
                    <option value="bh">bh</option>
                    <option value="om">om</option>
                </select>
            </div>
            <div style="margin-bottom:24px;">
                <label for="dialectSelect" style="font-weight:bold;">Dialect</label>
                <select id="dialectSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="Modern_standard" selected>Modern_standard</option>
                </select>
            </div>
            <button id="aiTemplateBtn" class="btn btn-secondary" style="width:100%; margin-top: 10px;">AI Template ID</button>
            <button id="subjectTemplateBtn" class="btn btn-secondary" style="width:100%; margin-top: 10px;">Subject Template ID</button>
            <button id="customize-save-btn" class="btn btn-primary" style="width:100%; margin-top: 10px;">حفظ</button>
        </div>
    </div>
        <div id="tagsModal">
        <div id="tagsModalHeader">
            <span>إدراج وسم (Tag)</span>
            <button id="tags-modal-close-btn" aria-label="إغلاق">×</button>
        </div>
        <div id="tagsModalBody">
             <div class="tags-section" id="templates-section">
                <h4>إدراج قالب جاهز</h4>
                <div class="tags-grid"></div>
            </div>
            <div class="tags-section" id="tags-section">
                <h4>إدراج وسم</h4>
                <div class="tags-grid"></div>
            </div>
        </div>
    </div>
        <div id="generationModalBg">
        <div id="generationModal">
            <div class="generation-header">
                <h2>🚀 توليد أسئلة بالذكاء الاصطناعي</h2>
            </div>
            <div class="generation-content">
                <div class="generation-column">
                    <h4>① أدخل المحتوى</h4>
                    <textarea id="gen-text-input" placeholder="الصق محتوى الدرس هنا..." style="width:100%; height: 200px; border-radius: 8px; border: 1px solid #d1d5db; padding: 10px; margin-bottom: 1rem;"></textarea>
                    <input type="file" id="gen-image-input" accept="image/*" style="display:none;">
                    <div id="gen-image-drop-zone">
                        <p>اسحب وأفلت صورة هنا، أو انقر للاختيار</p>
                        <img id="gen-image-preview" style="display:none;">
                    </div>
                </div>
                <div class="generation-column">
                    <h4>② حدد الإعدادات</h4>
                    <div id="gen-q-types-container"></div>
                    <hr style="margin: 1rem 0;">
                    <div class="gen-q-type-row">
                        <label for="gen-multi-part-count">سؤال متعدد الأجزاء</label>
                        <input type="number" id="gen-multi-part-count" min="0" value="0">
                    </div>
                    <input type="text" id="gen-multi-part-types" placeholder="أنواع الأجزاء (مثال: mcq, string)">
                    <hr style="margin: 1rem 0;">
                    <h4>③ (اختياري) أضف توجيهات خاصة</h4>
                    <textarea id="gen-custom-prompt" placeholder="مثال: ركز على المفاهيم الرئيسية، اجعل الأسئلة للمرحلة الإعدادية..." style="width:100%; height: 100px; border-radius: 8px; border: 1px solid #d1d5db; padding: 10px;"></textarea>
                </div>
            </div>
            <div class="generation-footer">
                <button id="modal-generate-btn" class="btn btn-primary">توليد الأسئلة</button>
                <button id="modal-cancel-btn" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>
        <div id="csvModalBg" role="dialog" aria-modal="true" aria-labelledby="csv-title">
        <div id="csvModal">
            <button id="csv-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="csv-title" style="text-align:center; margin-bottom:18px; color:#4f46e5;">CSV Editor</h2>
            <div class="csv-warning" id="csvWarning" style="display:none;"></div>
            <div id="hotTable" class="hot-container"></div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                <button id="csv-save-btn" class="btn btn-success">💾 حفظ</button>
                <button id="csv-close-btn" class="btn btn-secondary">❌ إغلاق</button>
            </div>
        </div>
    </div>
        <div id="aiTemplateModalBg" role="dialog" aria-modal="true" aria-labelledby="ai-template-title">
        <div id="aiTemplateModal">
            <button id="ai-template-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="ai-template-title" style="text-align:center; margin-bottom:18px; color:#4f46e5;">Set AI Template IDs</h2>
            <div id="hotAiTemplateTable" class="hot-container"></div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                <button id="ai-template-save-btn" class="btn btn-success">💾 حفظ</button>
                <button id="ai-template-close-btn" class="btn btn-secondary">❌ إغلاق</button>
            </div>
        </div>
    </div>
        <div id="subjectTemplateModalBg" role="dialog" aria-modal="true" aria-labelledby="subject-template-title">
        <div id="subjectTemplateModal">
            <button id="subject-template-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="subject-template-title" style="text-align:center; margin-bottom:18px; color:#4f46e5;">اختر المادة لتطبيق Template ID</h2>
            <div style="margin-bottom: 20px;">
                <label for="subjectSelect" style="font-weight:bold; display:block; margin-bottom:10px;">المادة / Subject:</label>
                <select id="subjectSelect" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e5e7eb; font-size:14px;">
                    <option value="">-- اختر المادة --</option>
                    <option value="الأحياء">الأحياء</option>
                    <option value="الرياضيات">الرياضيات</option>
                    <option value="العلوم">العلوم</option>
                    <option value="العلوم المتكاملة">العلوم المتكاملة</option>
                    <option value="الفيزياء">الفيزياء</option>
                    <option value="الكيمياء">الكيمياء</option>
                    <option value="اللغة العربية">اللغة العربية</option>
                    <option value="اكتشف">اكتشف</option>
                    <option value="التاريخ">التاريخ</option>
                    <option value="الجغرافيا">الجغرافيا</option>
                    <option value="الدراسات الاجتماعية">الدراسات الاجتماعية</option>
                    <option value="الفلسفة والمنطق">الفلسفة والمنطق</option>
                    <option value="علم النفس والاجتماع">علم النفس والاجتماع</option>
                    <option value="Biologie">Biologie</option>
                    <option value="Biology">Biology</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Connect Plus">Connect Plus</option>
                    <option value="Discover">Discover</option>
                    <option value="English">English</option>
                    <option value="Integrated Science">Integrated Science</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Physics">Physics</option>
                    <option value="Science">Science</option>
                    <option value="Sciences">Sciences</option>
                </select>
            </div>
            <div id="subjectQuestionsPreview" style="margin-bottom:20px; max-height:300px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:15px; background:#f8fafc;">
                <p style="text-align:center; color:#6b7280;">ستظهر الأسئلة المؤهلة هنا بعد اختيار المادة</p>
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                <button id="subject-template-save-btn" class="btn btn-success">💾 تطبيق</button>
                <button id="subject-template-close-btn" class="btn btn-secondary">❌ إغلاق</button>
            </div>
        </div>
    </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.js"></script>
    <script src="https://unpkg.com/mathlive"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        class AIQuestionConverter {
            // Source ID data
            sourceIdData = [
                { source_id: 314104834603, name: 'abdelrahman.taha@nagwa.com' }, { source_id: 743127867978, name: 'abdelrahman.toraya@nagwa.com' },
                    { source_id: 915157263490, name: 'ahmed.abdullah@nagwa.com' }, { source_id: 582103718642, name: 'ahmed.mansour@nagwa.com' },
                    { source_id: 852152386193, name: 'amal.abdelwahaab@nagwa.com' }, { source_id: 363101910619, name: 'amira.ahmad@nagwa.com' },
                    { source_id: 969141357647, name: 'amira.mohsen@nagwa.com' }, { source_id: 495183190468, name: 'aya.elshaheny@nagwa.com' },
                    { source_id: 734172083271, name: 'eman.farouk@nagwa.com' }, { source_id: 186142928704, name: 'abdalrahman.mohamed@nagwa.com' },
                    { source_id: 670149460968, name: 'abdellatif.meshref@nagwa.com' }, { source_id: 798193794391, name: 'abdullah.omar@nagwa.com' },
                    { source_id: 320146508191, name: 'ahmed.abdelghaffar@nagwa.com' }, { source_id: 568172629218, name: 'ahmed.ginidi@nagwa.com' },
                    { source_id: 939194952908, name: 'ahmed.magraalneel@nagwa.com' }, { source_id: 904175235414, name: 'ahmed.mohamed@nagwa.com' },
                    { source_id: 813189691358, name: 'ahmed.ragab@nagwa.com' }, { source_id: 309107619576, name: 'ahmed.rahmy@nagwa.com' },
                    { source_id: 198132915098, name: 'ahmed.shoeib@nagwa.com' }, { source_id: 810104279180, name: 'alaa.elgallab@nagwa.com' },
                    { source_id: 976157364031, name: 'alessandra.battistelli@nagwa.com' }, { source_id: 367187313289, name: 'alex.collins@nagwa.com' },
                    { source_id: 962123745478, name: 'alzahraa.elsayed@nagwa.com' }, { source_id: 630126405463, name: 'amanda.winn@nagwa.com' },
                    { source_id: 387160951260, name: 'amany.hassan@nagwa.com' }, { source_id: 567182705230, name: 'amira.doghaiem@nagwa.com' },
                    { source_id: 658131209030, name: 'amira.elsaady@nagwa.com' }, { source_id: 753136182320, name: 'amira.rashad@nagwa.com' },
                    { source_id: 540175279150, name: 'amr.abdelhakim@nagwa.com' }, { source_id: 660341756260, name: 'amr.khattab@nagwa.com' },
                    { source_id: 456170383670, name: 'amr.sobhy@nagwa.com' }, { source_id: 802165404853, name: 'amy.obrien@nagwa.com' },
                    { source_id: 498148235147, name: 'andre.pegeron@nagwa.com' }, { source_id: 938189854643, name: 'andrew.catanese@nagwa.com' },
                    { source_id: 978107247356, name: 'anita.piatek@nagwa.com' }, { source_id: 168170145619, name: 'anna.gilbert@nagwa.com' },
                    { source_id: 810178027057, name: 'anne-claire.dupuis@nagwa.com' }, { source_id: 389194237254, name: 'aryeh.krischer@nagwa.com' },
                    { source_id: 360528767742, name: 'ashraf.omara@nagwa.com' }, { source_id: 583151471710, name: 'aya.emam@nagwa.com' },
                    { source_id: 789171397037, name: 'aya.khaled@nagwa.com' }, { source_id: 438153757180, name: 'aya.mohamed@nagwa.com' },
                    { source_id: 939153820125, name: 'bailey.miller@nagwa.com' }, { source_id: 819120860581, name: 'beejal.parbhoo@nagwa.com' },
                    { source_id: 314185910980, name: 'benjamin.milnes@nagwa.com' }, { source_id: 680128161730, name: 'cara.sullivan@nagwa.com' },
                    { source_id: 285176950135, name: 'catherine.carney@nagwa.com' }, { source_id: 236136940914, name: 'claire.piochon@nagwa.com' },
                    { source_id: 380156798067, name: 'dahlia.hesham@nagwa.com' }, { source_id: 304840675231, name: 'dalia.frag@nagwa.com' },
                    { source_id: 197107685076, name: 'dalia.saber@nagwa.com' }, { source_id: 934103738395, name: 'damien.jefferies@nagwa.com' },
                    { source_id: 907175717841, name: 'dan.brittain@nagwa.com' }, { source_id: 576123059865, name: 'darius.garewal@nagwa.com' },
                    { source_id: 127168617029, name: 'david.arnold@nagwa.com' }, { source_id: 818145323631, name: 'debasmita.ojha@nagwa.com' },
                    { source_id: 136138626589, name: 'debra.karhson@nagwa.com' }, { source_id: 762127275840, name: 'diaa.ashraf@nagwa.com' },
                    { source_id: 350120505319, name: 'digby.chappell@nagwa.com' }, { source_id: 348191246181, name: 'ed.burdette@nagwa.com' },
                    { source_id: 732174681402, name: 'eman.abdelhamid@nagwa.com' }, { source_id: 878162694042, name: 'eman.muhammad@nagwa.com' },
                    { source_id: 428175626765, name: 'eman.salah@nagwa.com' }, { source_id: 604185853180, name: 'emily.moseley@nagwa.com' },
                    { source_id: 535120818246, name: 'emily.taylor@nagwa.com' }, { source_id: 316138139028, name: 'enas.elmohammady@nagwa.com' },
                    { source_id: 259124985854, name: 'enas.elsobhy@nagwa.com' }, { source_id: 804149018179, name: 'fallon.simpson@nagwa.com' },
                    { source_id: 673102459730, name: 'fathia.sobhi@nagwa.com' }, { source_id: 636163252185, name: 'fatma.mahmoud@nagwa.com' },
                    { source_id: 897154523715, name: 'flavia.hodel@nagwa.com' }, { source_id: 214123842049, name: 'francesca.childs@nagwa.com' },
                    { source_id: 658191560261, name: 'gabriel.martin@nagwa.com' }, { source_id: 905156363236, name: 'gabrielle.malo@nagwa.com' },
                    { source_id: 703145379267, name: 'ehab.mahmud@nagwa.com' }, { source_id: 328158489094, name: 'ahmed.sayed@nagwa.com' },
                    { source_id: 808120576893, name: 'fatma.roshdy@nagwa.com' }, { source_id: 914130708535, name: 'geraldine.bourgeon@nagwa.com' },
                    { source_id: 309176585370, name: 'ghada.osam@nagwa.com' }, { source_id: 404123129714, name: 'ghadeer.mostafa@nagwa.com' },
                    { source_id: 819145047216, name: 'dina.ali@nagwa.com' }, { source_id: 894176946498, name: 'amira.elkholy@nagwa.com' },
                    { source_id: 175196786128, name: 'ahmed.sabra@nagwa.com' }, { source_id: 719130548578, name: 'fatema.samy@nagwa.com' },
                    { source_id: 318148214878, name: 'ahmed.salem@nagwa.com' }, { source_id: 937145789737, name: 'esraa.shahien@nagwa.com' },
                    { source_id: 746172148370, name: 'aya.shaaban@nagwa.com' }, { source_id: 965154318280, name: 'aya.eltwancy@nagwa.com' },
                    { source_id: 326106398487, name: 'eman.omar@nagwa.com' }, { source_id: 365138267632, name: 'ahmed.raafat@nagwa.com' },
                    { source_id: 708176801247, name: 'alaa.emary@nagwa.com' }, { source_id: 212194986282, name: 'ahmed.elbanna@nagwa.com' },
                    { source_id: 317150941798, name: 'amaal.abdelaziz@nagwa.com' }, { source_id: 803134190189, name: 'bedour.zahran@nagwa.com' },
                    { source_id: 643164068106, name: 'aya.abulmagd@nagwa.com' }, { source_id: 337614157860, name: 'ayat.tamim@nagwa.com' },
                    { source_id: 474164583535, name: 'abeer.fouad@nagwa.com' }, { source_id: 387162583986, name: 'ahmed.medra@nagwa.com' },
                    { source_id: 120171982460, name: 'ahmed.alhefny@nagwa.com' }, { source_id: 895127097864, name: 'gordonjoel.meyer@nagwa.com' },
                    { source_id: 793186820985, name: 'graham.ely@nagwa.com' }, { source_id: 802176327015, name: 'hadeer.abdelhay@nagwa.com' },
                    { source_id: 752104714650, name: 'hala.nasouh@nagwa.com' }, { source_id: 619137128302, name: 'hanan.iesa@nagwa.com' },
                    { source_id: 208127196157, name: 'harry.shuttleworth@nagwa.com' }, { source_id: 915143059179, name: 'hasnaa.aitbaha@nagwa.com' },
                    { source_id: 960171705257, name: 'heather.drewett@nagwa.com' }, { source_id: 564148628625, name: 'heather.jezorek@nagwa.com' },
                    { source_id: 142147919414, name: 'heba.elsherif@nagwa.com' }, { source_id: 989145183086, name: 'heba.sadek@nagwa.com' },
                    { source_id: 742173813751, name: 'hisham.reda@nagwa.com' }, { source_id: 216170252391, name: 'hoda.shawky@nagwa.com' },
                    { source_id: 839103931392, name: 'hossam.mohamed@nagwa.com' }, { source_id: 579152932527, name: 'hussein.magdy@nagwa.com' },
                    { source_id: 254108313537, name: 'ibrahim.anwar@nagwa.com' }, { source_id: 286182381245, name: 'ibrahim.elbagoury@nagwa.com' },
                    { source_id: 504130932870, name: 'islam.magdy@nagwa.com' }, { source_id: 607194519759, name: 'israa.kotb@nagwa.com' },
                    { source_id: 329186759405, name: 'jaillan.elrafey@nagwa.com' }, { source_id: 718130607823, name: 'james.gudge@nagwa.com' },
                    { source_id: 452143830658, name: 'joseph.mcnulty@nagwa.com' }, { source_id: 436156380571, name: 'joylyn.weikum@nagwa.com' },
                    { source_id: 505104272417, name: 'julie.haviland@nagwa.com' }, { source_id: 264146849363, name: 'juliet.perry@nagwa.com' },
                    { source_id: 959157375383, name: 'kathryn.kingham@nagwa.com' }, { source_id: 415156093421, name: 'kelly.fringer@nagwa.com' },
                    { source_id: 745102051694, name: 'kerolis.shehata@nagwa.com' }, { source_id: 865190945914, name: 'khadija.abdelfattah@nagwa.com' },
                    { source_id: 462158197608, name: 'kylee.long@nagwa.com' }, { source_id: 910165421706, name: 'lara.amusan@nagwa.com' },
                    { source_id: 918190346401, name: 'lauren.mcnaughten@nagwa.com' }, { source_id: 147146249089, name: 'levi.klankowski@nagwa.com' },
                    { source_id: 703150291949, name: 'lloyd.connellan@nagwa.com' }, { source_id: 832103128745, name: 'luke.hatfield@nagwa.com' },
                    { source_id: 495128347429, name: 'mae.saafan@nagwa.com' }, { source_id: 839134018180, name: 'maha.abdelmoneim@nagwa.com' },
                    { source_id: 427148783504, name: 'mahmoud.mohammed@nagwa.com' }, { source_id: 324187235816, name: 'mahmoud.salheen@nagwa.com' },
                    { source_id: 642163674058, name: 'mai.farouk@nagwa.com' }, { source_id: 498157574297, name: 'marcus.taylor@nagwa.com' },
                    { source_id: 169159894032, name: 'mariam.khaled@nagwa.com' }, { source_id: 347130890658, name: 'mariam.tarek@nagwa.com' },
                    { source_id: 243159695028, name: 'marwa.shehata@nagwa.com' }, { source_id: 952120140364, name: 'marwa.taha@nagwa.com' },
                    { source_id: 518141904047, name: 'michael.halim@nagwa.com' }, { source_id: 674125024324, name: 'miriam.carterfraser@nagwa.com' },
                    { source_id: 495103549506, name: 'mirna.yasser@nagwa.com' }, { source_id: 635160624265, name: 'mohamad.gamal@nagwa.com' },
                    { source_id: 392124142656, name: 'mohamed.abdelrhman@nagwa.com' }, { source_id: 510124020952, name: 'mohamed.amin@nagwa.com' },
                    { source_id: 654169891374, name: 'mohamed.darwish@nagwa.com' }, { source_id: 215151528545, name: 'mohamed.ezzeldin@nagwa.com' },
                    { source_id: 407152960816, name: 'mohamed.fathy@nagwa.com' }, { source_id: 127196204513, name: 'mohamed.fawzy@nagwa.com' },
                    { source_id: 249159575865, name: 'mohamed.ibrahim@nagwa.com' }, { source_id: 872185621013, name: 'mohamed.khalil@nagwa.com' },
                    { source_id: 865187829357, name: 'mohamed.magdy@nagwa.com' }, { source_id: 930168206797, name: 'gehad.mahmoud@nagwa.com' },
                    { source_id: 709186750268, name: 'gerges.yousef@nagwa.com' }, { source_id: 619153120948, name: 'lamis.saeed@nagwa.com' },
                    { source_id: 408143460578, name: 'marwa.hany@nagwa.com' }, { source_id: 280127867580, name: 'ismaiel.gamaleldin@nagwa.com' },
                    { source_id: 583191979837, name: 'maram.khater@nagwa.com' }, { source_id: 736103401087, name: 'moaaz.hagag@nagwa.com' },
                    { source_id: 627181736159, name: 'mohamed.elwakeel@nagwa.com' }, { source_id: 136154282452, name: 'israa.abdelkarim@nagwa.com' },
                    { source_id: 376109834614, name: 'hanady.gamal@nagwa.com' }, { source_id: 135103962931, name: 'mohamed.nabil@nagwa.com' },
                    { source_id: 757140165893, name: 'mohamed.talaat@nagwa.com' }, { source_id: 318178172082, name: 'mohammed.ramadan@nagwa.com' },
                    { source_id: 973134316315, name: 'mohammed.kamal@nagwa.com' }, { source_id: 918161628616, name: 'mohamed.elshaka@nagwa.com' },
                    { source_id: 546129780836, name: 'mariam.kotb@nagwa.com' }, { source_id: 967191273406, name: 'mahinour.tawfik@nagwa.com' },
                    { source_id: 168190608585, name: 'mohmmad.qenawy@nagwa.com' }, { source_id: 215104534508, name: 'morgan.taveras@nagwa.com' },
                    { source_id: 594158694782, name: 'mostafa.abdelsabour@nagwa.com' }, { source_id: 736198678340, name: 'mostafa.mahmoud@nagwa.com' },
                    { source_id: 464168263468, name: 'magdy.younis@nagwa.com' }, { source_id: 959153294685, name: 'mohamed.mahmoudy@nagwa.com' },
                    { source_id: 747185926028, name: 'mariam.yahia@nagwa.com' }, { source_id: 757101691847, name: 'marina.zaki@nagwa.com' },
                    { source_id: 698165698458, name: 'heba.eltarabishy@nagwa.com' }, { source_id: 676130390838, name: 'hussein.mahmoud@nagwa.com' },
                    { source_id: 517162017961, name: 'marwah.ahmad.helaly@nagwa.com' }, { source_id: 345171316462, name: 'ghada.elashry@nagwa.com' },
                    { source_id: 368142801213, name: 'mahmoud.aboelmagd@nagwa.com' }, { source_id: 127196862036, name: 'mohammad.hossein@nagwa.com' },
                    { source_id: 617126437323, name: 'mohamed.eid@nagwa.com' }, { source_id: 985124920590, name: 'mazen.gad@nagwa.com' },
                    { source_id: 952139328620, name: 'kareem.nashat@nagwa.com' }, { source_id: 475149294140, name: 'gehan.khaled@nagwa.com' },
                    { source_id: 945145262849, name: 'marie.maccaig@nagwa.com' }, { source_id: 849836164084, name: 'muhammad.farouk@nagwa.com' },
                    { source_id: 752198519039, name: 'hend.abdelmalek@nagwa.com' }, { source_id: 504190958067, name: 'heba.ghoneim@nagwa.com' },
                    { source_id: 284108073840, name: 'mai.sherif@nagwa.com' }, { source_id: 709169689048, name: 'muhammad.hashem@nagwa.com' },
                    { source_id: 352171762824, name: 'nada.amr@nagwa.com' }, { source_id: 309190625604, name: 'nada.hassaneen@nagwa.com' },
                    { source_id: 905125258656, name: 'nada.kamal@nagwa.com' }, { source_id: 768169353638, name: 'nadin.hassan@nagwa.com' },
                    { source_id: 708195163726, name: 'namrata.olimattel@nagwa.com' }, { source_id: 109120608408, name: 'nancy.lotfy@nagwa.com' },
                    { source_id: 873140659245, name: 'naomi.holland@nagwa.com' }, { source_id: 214153025202, name: 'neveen.abdelhakim@nagwa.com' },
                    { source_id: 832128021242, name: 'noha.mostafa@nagwa.com' }, { source_id: 796130127979, name: 'nohayr.ali@nagwa.com' },
                    { source_id: 862191709297, name: 'nourhan.gamil@nagwa.com' }, { source_id: 987190350914, name: 'nourhan.younis@nagwa.com' },
                    { source_id: 519179193151, name: 'oliver.rigg@nagwa.com' }, { source_id: 427135275809, name: 'omar.elshazly@nagwa.com' },
                    { source_id: 39054475743, name: 'omnia.hussein@nagwa.com' }, { source_id: 595147048923, name: 'omnia.ibrahim@nagwa.com' },
                    { source_id: 953192613695, name: 'osama.abdelmoez@nagwa.com' }, { source_id: 584154879674, name: 'pam.jones@nagwa.com' },
                    { source_id: 472186274352, name: 'parth.gharfalkar@nagwa.com' }, { source_id: 254107473215, name: 'paul.wrangles@nagwa.com' },
                    { source_id: 134160965931, name: 'philippa.crick@nagwa.com' }, { source_id: 716138671536, name: 'rachel.george@nagwa.com' },
                    { source_id: 175101587891, name: 'rachel.oosthuizen@nagwa.com' }, { source_id: 32127148021, name: 'radwa.ali@nagwa.com' },
                    { source_id: 309164035618, name: 'rahma.tarek@nagwa.com' }, { source_id: 504132724329, name: 'rana.ashraf@nagwa.com' },
                    { source_id: 503159060958, name: 'rania.fahmy@nagwa.com' }, { source_id: 743136248085, name: 'rania.wahdan@nagwa.com' },
                    { source_id: 462158042576, name: 'rasha.mohsen@nagwa.com' }, { source_id: 758137924974, name: 'rebecca.corden@nagwa.com' },
                    { source_id: 658169564058, name: 'rebecca.keller@nagwa.com' }, { source_id: 236140486914, name: 'reham.elkholy@nagwa.com' },
                    { source_id: 580178428347, name: 'rhodri.jones@nagwa.com' }, { source_id: 579197481213, name: 'riham.saleh@nagwa.com' },
                    { source_id: 745172160404, name: 'robert.ellmore@nagwa.com' }, { source_id: 328140493832, name: 'robert.russell@nagwa.com' },
                    { source_id: 192145305197, name: 'sahar.samir@nagwa.com' }, { source_id: 690121534014, name: 'sally.christmas@nagwa.com' },
                    { source_id: 280146452943, name: 'sarah.farouk@nagwa.com' }, { source_id: 752109649258, name: 'sarah.garry@nagwa.com' },
                    { source_id: 946185974395, name: 'sean.lauber@nagwa.com' }, { source_id: 594168692017, name: 'seungly.oh@nagwa.com' },
                    { source_id: 847120158758, name: 'shaimaa.malek@nagwa.com' }, { source_id: 472182053407, name: 'shannon.monks@nagwa.com' },
                    { source_id: 360169565672, name: 'shereen.osman@nagwa.com' }, { source_id: 563153963712, name: 'sherif.khalil@nagwa.com' },
                    { source_id: 526108432725, name: 'simeon.every@nagwa.com' }, { source_id: 424167960140, name: 'sneha.krishnamurthy@nagwa.com' },
                    { source_id: 724163101078, name: 'sohaila.mohsen@nagwa.com' }, { source_id: 929179241308, name: 'stephen.currie@nagwa.com' },
                    { source_id: 302175157840, name: 'tarek.monir@nagwa.com' }, { source_id: 907139471258, name: 'tim.burnham@nagwa.com' },
                    { source_id: 145129517432, name: 'timothy.sit@nagwa.com' }, { source_id: 837194975726, name: 'usamah.khalid@nagwa.com' },
                    { source_id: 947175758914, name: 'wageih.soliman@nagwa.com' }, { source_id: 234143262138, name: 'warda.mokhtar@nagwa.com' },
                    { source_id: 269150537947, name: 'william.hornbrook@nagwa.com' }, { source_id: 179124692670, name: 'yara.abdelaal@nagwa.com' },
                    { source_id: 963156357525, name: 'yasmeen.elaraby@nagwa.com' }, { source_id: 738163182548, name: 'yasser.selim@nagwa.com' },
                    { source_id: 342147278040, name: 'youssef.abdelmaksoud@nagwa.com' }, { source_id: 468105976487, name: 'enas.mahdy@nagwa.com' },
                    { source_id: 485136431282, name: 'ahmed.hindawi@nagwa.com' }, { source_id: 602123625931, name: 'noha.abdelrazik@nagwa.com' },
                    { source_id: 987456719712, name: 'mohamed.abdelalem@nagwa.com' }, { source_id: 568105165059, name: 'sara.abdelaziz@nagwa.com' },
                    { source_id: 828137430379, name: 'shorouk.khaled@nagwa.com' }, { source_id: 608151093040, name: 'hagar.ali@nagwa.com' },
                    { source_id: 673139040161, name: 'neveen.helmy@nagwa.com' }, { source_id: 792180794127, name: 'fatma.sultan@nagwa.com' },
                    { source_id: 264184518383, name: 'andrew.kitchin@nagwa.com' }, { source_id: 268152904956, name: 'mohammed.saad@nagwa.com' },
                    { source_id: 354135052858, name: 'kamal.mostafa@nagwa.com' }, { source_id: 510159583735, name: 'mahmoud.elneweshy@nagwa.com' },
                    { source_id: 867159606861, name: 'rehab.fawzy@nagwa.com' }, { source_id: 270160860196, name: 'shereen.fouad@nagwa.com' },
                    { source_id: 537148319827, name: 'dalia.kamal@nagwa.com' }, { source_id: 705107850630, name: 'eman.salem@nagwa.com' },
                    { source_id: 249173189630, name: 'mohamed.emadeldin@nagwa.com' }, { source_id: 876179218756, name: 'basma.sherif@nagwa.com' },
                    { source_id: 105126414395, name: 'monia.elwakeel@nagwa.com' }, { source_id: 590173795378, name: 'sammar.zakaria@nagwa.com' },
                    { source_id: 190183287598, name: 'soha.nasreldin@nagwa.com' }, { source_id: 698648148076, name: 'sarah.hassan@nagwa.com' },
                    { source_id: 894168289463, name: 'nagwa.reda@nagwa.com' }, { source_id: 209168454958, name: 'ramy.magdy@nagwa.com' },
                    { source_id: 723147417356, name: 'sara.ramadan@nagwa.com' }, { source_id: 894128580787, name: 'yomna.bayoumi@nagwa.com' },
                    { source_id: 634194140283, name: 'samah.abdelfattah@nagwa.com' }, { source_id: 272128153864, name: 'mahmoud.elzomor@nagwa.com' },
                    { source_id: 618146184254, name: 'yara.sobhy@nagwa.com' }, { source_id: 364164635329, name: 'nourhan.saied@nagwa.com' },
                    { source_id: 710158723939, name: 'noha.ezzat@nagwa.com' }, { source_id: 439168676721, name: 'rasha.basha@nagwa.com' },
                    { source_id: 476107574235, name: 'rabie.eldoha@nagwa.com' }, { source_id: 698106520137, name: 'salma.zaki@nagwa.com' },
                    { source_id: 978128962893, name: 'nihal.essmat@nagwa.com' }, { source_id: 154106968213, name: 'zeina.elsheikh@nagwa.com' },
                    { source_id: 310134129623, name: 'reda.jebril@nagwa.com' }, { source_id: 927169194769, name: 'salma.hafez@nagwa.com' },
                    { source_id: 872103252787, name: 'heba.adel@nagwa.com' }, { source_id: 873179621316, name: 'samaa.eltanawy@nagwa.com' },
                    { source_id: 916174061960, name: 'sara.soliman@nagwa.com' }, { source_id: 853106948071, name: 'mohamed.tarek@nagwa.com' },
                    { source_id: 123456789012, name: 'fatma.habib@nagwa.com' }, { source_id: 258147369789, name: 'enas.mohamed@nagwa.com' },
                    { source_id: 259159095185, name: 'toka.aly@nagwa.com' }, { source_id: 760130128289, name: 'abdelazim.beidas@nagwa.com' },
                    { source_id: 415151639694, name: 'shaker.hamdi@nagwa.com' }, { source_id: 784191574927, name: 'ayman.elsibaie@nagwa.com' },
                    { source_id: 302194323261, name: 'abdelmonem.mohamed@nagwa.com' }, { source_id: 760174692735, name: 'alaa.ahmed@nagwa.com' },
                    { source_id: 148108285685, name: 'attya.attya@nagwa.com' }, { source_id: 429107598090, name: 'amr.ramadan@nagwa.com' },
                    { source_id: 593109319363, name: 'lobna.ahmed@nagwa.com' }, { source_id: 718176767987, name: 'khadija.saad@nagwa.com' },
                    { source_id: 340171769083, name: 'ayman.farag@nagwa.com' }, { source_id: 492194298907, name: 'abdelrahman.elsadek@nagwa.com' },
                    { source_id: 380165418413, name: 'khadija.muhammad@nagwa.com' }, { source_id: 325167372908, name: 'mohamed.hegazy@nagwa.com' },
                    { source_id: 647178381548, name: 'heba.mahmoud@nagwa.com' }, { source_id: 809182160679, name: 'nelly.nasser@nagwa.com' },
                    { source_id: 258164501610, name: 'amany.fergany@nagwa.com' }, { source_id: 928106378980, name: 'ehab.elgawady@nagwa.com' },
                    { source_id: 286128939638, name: 'aya.abdelrahman@nagwa.com' }, { source_id: 723194238792, name: 'hanan.saad@nagwa.com' },
                    { source_id: 785102157610, name: 'antwan.rizk@nagwa.com' }, { source_id: 689120234340, name: 'nouthayla.magdy@nagwa.com' },
                    { source_id: 367124216873, name: 'hossam.hassan@nagwa.com' }, { source_id: 359193429068, name: 'mohamed.sayed@nagwa.com' },
                    { source_id: 486193781754, name: 'mariam.zaki@nagwa.com' }, { source_id: 963149619723, name: 'moataz.mohamed@nagwa.com' },
                    { source_id: 805183060731, name: 'wafaa.yehia@nagwa.com' }, { source_id: 202162942982, name: 'ahmed.abdelmoniem@nagwa.com' },
                    { source_id: 183147396259, name: 'huda.twfik@nagwa.com' }, { source_id: 784103283656, name: 'marina.toma@nagwa.com' },
                    { source_id: 865150974316, name: 'hussam.salah@nagwa.com' }, { source_id: 125143418905, name: 'mohamed.sallam@nagwa.com' },
                    { source_id: 146124021718, name: 'mohamed.hamdi@nagwa.com' }, { source_id: 315163104517, name: 'rody.samy@nagwa.com' },
                    { source_id: 432131578531, name: 'ameer.omar@nagwa.com' }, { source_id: 480168626860, name: 'dina.amin@nagwa.com' },
                    { source_id: 637108501093, name: 'nora.mostafa@nagwa.com' }, { source_id: 364142760518, name: 'salma.tarek@nagwa.com' },
                    { source_id: 656186570875, name: 'nada.salama@nagwa.com' }, { source_id: 863140923782, name: 'zeinab.adel@nagwa.com' },
                    { source_id: 934195097582, name: 'hagar.elbatal@nagwa.com' }, { source_id: 0, name: 'hoda.ayoub@nagwa.com' },
                    { source_id: 424174364659, name: 'hadeer.hussein@nagwa.com' }, { source_id: 714152985297, name: 'ahmad.saeed@nagwa.com' },
                    { source_id: 548127510737, name: 'zeinab.nabih@nagwa.com' }, { source_id: 587170578520, name: 'huda.tawfik@nagwa.com' },
                    { source_id: 637157279691, name: 'mazen.emad@nagwa.com' }, { source_id: 570104968128, name: 'dina.kamal@nagwa.com' },
                    { source_id: 315135204893, name: 'kerolouse.franciess@nagwa.com' }, { source_id: 803172646718, name: 'rasha.bekhit@nagwa.com' },
                    { source_id: 360197039043, name: 'sofana.albahi@nagwa.com' }, { source_id: 715125986801, name: 'badr.oraby@nagwa.com' },
                    { source_id: 590189895847, name: 'madonna.milad@nagwa.com' }, { source_id: 105108603275, name: 'khaled.saeed@nagwa.com' },
                    { source_id: 857103641397, name: 'ahmed.shaarawy@nagwa.com' }, { source_id: 389176391532, name: 'mahmoud.elashry@nagwa.com' },
                    { source_id: 315135204892, name: 'shimaa.mahmoud@nagwa.com' }, { source_id: 973103243124, name: 'rehab.medhat@nagwa.com' },
                    { source_id: 958165085253, name: 'aya.gaber@nagwa.com' }, { source_id: 964126973921, name: 'nadine.raafat@nagwa.com' },
                    { source_id: 734130434960, name: 'ahmed.hatem@nagwa.com' }, { source_id: 174181235606, name: 'zeyad.aql@nagwa.com' },
                    { source_id: 412472830111, name: 'kawthar.mohamed@nagwa.com' }, { source_id: 320170709096, name: 'essam.omar@nagwa.com' },
                    { source_id: 760154814164, name: 'heba.youssef@nagwa.com' }, { source_id: 935140803730, name: 'ahmed.morsi@nagwa.com' },
                    { source_id: 853152057854, name: 'esther.villegasdelatorre@nagwa.com' }, { source_id: 746191310389, name: 'cds.tscript.sub.rev.1@nagwa.com' },
                    { source_id: 905187850275, name: 'heba.yehia@nagwa.com' }, { source_id: 939167341860, name: 'reem.metwally@nagwa.com' },
                    { source_id: 652137698435, name: 'hagar.mohsen@nagwa.com' }, { source_id: 878159013086, name: 'ahmed.ramadan@nagwa.com' },
                    { source_id: 120187615309, name: 'mohamed.younnes@nagwa.com' }, { source_id: 267176825827, name: 'mohamed.araby@nagwa.com' },
                    { source_id: 415190915306, name: 'ibrahim.ali@nagwa.com' }, { source_id: 160181941723, name: 'ameera.mohamed@nagwa.com' },
                    { source_id: 570464765580, name: 'mohamed.genaidy@nagwa.com' }, { source_id: 294102508567, name: 'asmaa.ahmed@nagwa.com' },
                    { source_id: 130196195493, name: 'mahmoud.sayed@nagwa.com' }, { source_id: 954134694753, name: 'hosam.kassem@nagwa.com' },
                    { source_id: 218127341740, name: 'sayed.mohamed@nagwa.com' }, { source_id: 687101641397, name: 'rahma.ashraf@nagwa.com' },
                    { source_id: 840193238059, name: 'ghada.elewa@nagwa.com' }, { source_id: 819178319024, name: 'monica.sidhom@nagwa.com' },
                    { source_id: 769164617401, name: 'mohammed.elsayed.ramadan@nagwa.com' }, { source_id: 670136979720, name: 'moaz.saleh@nagwa.com' },
                    { source_id: 593148528191, name: 'mohamed.hosny@nagwa.com' }, { source_id: 794169383606, name: 'mostafa.abdelhalim@nagwa.com' },
                    { source_id: 769145326739, name: 'nourhan.alaaeldin@nagwa.com' }, { source_id: 927109361075, name: 'nader.atef@nagwa.com' },
                    { source_id: 732107039548, name: 'mohamed.elhamouly@nagwa.com' }, { source_id: 424182093137, name: 'mostafa.alaa@nagwa.com' },
                    { source_id: 605173125053, name: 'eslam.mohamed@nagwa.com' }, { source_id: 856196980834, name: 'asmaa.yousry@nagwa.com' },
                    { source_id: 936185082745, name: 'zeinab.zaki@nagwa.com' }, { source_id: 180120387643, name: 'emily.postles@nagwa.com' },
                    { source_id: 616193818038, name: 'soria.ibrahim@nagwa.com' }, { source_id: 123450987654, name: 'amira.mohamed@nagwa.com' },
                    { source_id: 186162343817, name: 'eman.sawabi@nagwa.com' }, { source_id: 436193847890, name: 'hanaa.fouad@nagwa.com' },
                    { source_id: 603178979628, name: 'noha.mousa@nagwa.com' }, { source_id: 934148451632, name: 'hanna.hodgson@nagwa.com' },
                    { source_id: 418123749852, name: 'rebecca.clifton@nagwa.com' }, { source_id: 814149845184, name: 'ahmed.alaa@nagwa.com' },
                    { source_id: 879158194074, name: 'nour.bahgat@nagwa.com' }, { source_id: 478179147017, name: 'kerolous.amged@nagwa.com' },
                    { source_id: 740102957170, name: 'mohamed.elsayed@nagwa.com' }, { source_id: 923137697053, name: 'salma.farag@nagwa.com' },
                    { source_id: 628147168986, name: 'mostafa.taha@nagwa.com' }, { source_id: 496137370693, name: 'dsfsdfd@nagwa.com' },
                    { source_id: 692132635438, name: 'stephanie.mauro@nagwa.com' }, { source_id: 349139419030, name: 'gabriela.hallas@nagwa.com' },
                    { source_id: 972186956519, name: 'abdallah.hassan@nagwa.com' }, { source_id: 125162830402, name: 'ahmed.yahya@nagwa.com' },
                    { source_id: 393154181873, name: 'shrouk.samir@nagwa.com' }, { source_id: 705185973512, name: 'salma.hatem@nagwa.com' },
                    { source_id: 216143404140, name: 'aliaa.adel@nagwa.com' }, { source_id: 254108051897, name: 'tarek.sleem@nagwa.com' },
                    { source_id: 424185975219, name: 'marwa.mohie@nagwa.com' }, { source_id: 232192545124, name: 'erin.wilson@nagwa.com' },
                    { source_id: 805189370751, name: 'hend.elhusseiny@nagwa.com' }, { source_id: 484168062929, name: 'kamel.sayed@nagwa.com' },
                    { source_id: 809124795010, name: 'mohamed.abdelfattah@nagwa.com' }, { source_id: 807134254237, name: 'mohamed.mourad@nagwa.com' },
                    { source_id: 840195406328, name: 'radwa.sabry@nagwa.com' }, { source_id: 740123086282, name: 'sss@nagwa.com' },
                    { source_id: 931108264346, name: 'maii.sameh@nagwa.com' }, { source_id: 295197069742, name: 'madonna.metry@nagwa.com' },
                    { source_id: 174160521690, name: 'aya.medhat@nagwa.com' }, { source_id: 147184646738, name: 'taher.abdelhady@nagwa.com' },
                    { source_id: 635167537939, name: 'ahmed.abdellatif@nagwa.com' }, { source_id: 185102681686, name: 'mohamed.emam@nagwa.com' },
                    { source_id: 307125819138, name: 'shady.khaled@nagwa.com' }, { source_id: 753132639563, name: 'sameh.sadek@nagwa.com' },
                    { source_id: 737106793085, name: 'omar.essam@nagwa.com' }, { source_id: 743179752514, name: 'heba.ghazaly@nagwa.com' },
                    { source_id: 427130104357, name: 'nourelhoda.abdelaziz@nagwa.com' }, { source_id: 367182925949, name: 'zeinab.elshenawy@nagwa.com' },
                    { source_id: 963163430437, name: 'shady.donia@nagwa.com' }, { source_id: 145172635718, name: 'yasmine.nasr@nagwa.com' },
                    { source_id: 185198317034, name: 'sara.mohamed@nagwa.com' }, { source_id: 215178624531, name: 'rana.hassan@nagwa.com' },
                    { source_id: 626137830726, name: 'nourhan.hassan@nagwa.com' }, { source_id: 413176194352, name: 'noha.elghoniemy@nagwa.com' },
                    { source_id: 864123085261, name: 'salma.ayman@nagwa.com' }, { source_id: 375135763692, name: 'mohamed.ismail@nagwa.com' },
                    { source_id: 235120752920, name: 'joumana.farag@nagwa.com' }, { source_id: 986197167612, name: 'karima.mahmoud@nagwa.com' },
                    { source_id: 147104760597, name: 'rana.antar@nagwa.com' }, { source_id: 168124952185, name: 'alice.herridge@nagwa.com' },
                    { source_id: 679180375094, name: 'abdallah.mohamed@nagwa.com' }, { source_id: 725162564962, name: 'nicolo.bazzi@nagwa.com' },
                    { source_id: 509142545710, name: 'hebtollah.mosa@nagwa.com' }, { source_id: 694164363692, name: 'samar.bahaaeldin@nagwa.com' },
                    { source_id: 617180919760, name: 'nourhan.hashad@nagwa.com' }, { source_id: 137105142619, name: 'esraa.saeed@nagwa.com' },
                    { source_id: 942130798452, name: 'aiat.saied@nagwa.com' }, { source_id: 404194328764, name: 'mohamed.hedeya@nagwa.com' },
                    { source_id: 172130285640, name: 'mohamed.hani@nagwa.com' }, { source_id: 630190153019, name: 'howaida.saber@nagwa.com' },
                    { source_id: 289150706195, name: 'yomna.gameel@nagwa.com' }, { source_id: 653101624283, name: 'taher.abdelhadyddddd@nagwa.com' },
                    { source_id: 749135848015, name: 'ingi.radwan@nagwa.com' }, { source_id: 896129153294, name: 'doha.fahmy@nagwa.com' },
                    { source_id: 174152535791, name: 'radwa.muhammad@nagwa.com' }, { source_id: 673167025619, name: 'haytham.mahmoud@nagwa.com' },
                    { source_id: 564143962161, name: 'nour.elborno@nagwa.com' }, { source_id: 534107915239, name: 'noha.mokhtar@nagwa.com' },
                    { source_id: 604169348956, name: 'menna.hamdy@nagwa.com' }, { source_id: 424192489189, name: 'hady.nabil@nagwa.com' },
                    { source_id: 473181014731, name: 'ramy.farouk@nagwa.com' }, { source_id: 834104670309, name: 'medhat.ali@nagwa.com' },
                    { source_id: 475136389247, name: 'mohamed.ahmed.kamal@nagwa.com' }, { source_id: 592153108121, name: 'cds.tscript.qa.1@nagwa.com' },
                    { source_id: 456157376139, name: 'maria.martinez@nagwa.com' }, { source_id: 906195414769, name: 'ahmed.hamad@nagwa.com' },
                    { source_id: 458131045164, name: 'cds.tscript.ce.1@nagwa.com' }, { source_id: 825167819068, name: 'benedicte.barrett@nagwa.com' },
                    { source_id: 346102987238, name: 'amany.talaat@nagwa.com' }, { source_id: 534193284374, name: 'sara.gamal@nagwa.com' },
                    { source_id: 725149525389, name: 'israa.ibrahim@nagwa.com' }, { source_id: 570106179431, name: 'sara.badwy@nagwa.com' },
                    { source_id: 906134617686, name: 'menna.ayman@nagwa.com' }, { source_id: 168174573895, name: 'malak.aliwy@nagwa.com' },
                    { source_id: 835193040729, name: 'cds.tscript.rev.1@nagwa.com' }, { source_id: 262184039598, name: 'taha.hassan@nagwa.com' },
                    { source_id: 583147318469, name: 'abeer.abdelaziz@nagwa.com' }, { source_id: 304105618950, name: 'faten.sayed@nagwa.com' },
                    { source_id: 182136230818, name: 'mariam.ghonaim@nagwa.com' }, { source_id: 865190148085, name: 'menna.elsanhoury@nagwa.com' },
                    { source_id: 925171517156, name: 'lobna.adel@nagwa.com' }, { source_id: 523153132509, name: 'haya.khaled@nagwa.com' },
                    { source_id: 562196032364, name: 'sherry.sawires@nagwa.com' }, { source_id: 862172412125, name: 'mayar.fathy@nagwa.com' },
                    { source_id: 183197425670, name: 'mirna.atef@nagwa.com' }, { source_id: 494153106570, name: 'ibrahim.eldahan@nagwa.com' },
                    { source_id: 826154029457, name: 'eman.hamdi@nagwa.com' }, { source_id: 312126191387, name: 'aya.ramadan@nagwa.com' },
                    { source_id: 786124121423, name: 'test_dahan@nagwa.com' }, { source_id: 969143627625, name: 'sameh.elsayed@nagwa.com' },
                    { source_id: 746121902861, name: 'walid.rahoma@nagwa.com' }, { source_id: 418125715718, name: 'abdualeem.hosny@nagwa.com' },
                    { source_id: 896170732925, name: 'test@nagwa.com' }, { source_id: 796184759657, name: 'ahmed.dawoud@nagwa.com' },
                    { source_id: 865190276198, name: 'hussein.mostafa@nagwa.com' }, { source_id: 762197039686, name: 'eriene.samir@nagwa.com' },
                    { source_id: 168196964239, name: 'georgette.rizk@nagwa.com' }, { source_id: 798157985869, name: 'ahmed.tolba@nagwa.com' },
                    { source_id: 480146765805, name: 'rehab.atia@nagwa.com' }, { source_id: 293106707912, name: 'kyrillos.khairy@nagwa.com' },
                    { source_id: 549158576383, name: 'mohamed.elgharabawi@nagwa.com' }, { source_id: 135147615340, name: 'zaynab.abdulsattar@nagwa.com' },
                    { source_id: 759178931095, name: 'bouthyna.tarek@nagwa.com' }, { source_id: 238173260548, name: 'cds.system@nagwa.com' },
                    { source_id: 147127372052, name: 'khaled.ghaly@nagwa.com' }, { source_id: 540185395059, name: 'mariam.elaasser@nagwa.com' },
                    { source_id: 243194710465, name: 'aliaa.fikry@nagwa.com' }
            ];
            
            constructor() {
                // --- 1. CONFIGURATION ---
                this.config = Object.freeze({
                    api: {
                        geminiEndpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=',
                        openaiEndpoint: 'https://api.openai.com/v1/chat/completions'
                    },
                    defaults: {
                        country: 'eg',
                        category: 'lesson',
                        dialect: 'Modern_standard',
                        sourceId: 182136230818,
                        lang: 'ar',
                        direction: 'vertical' // Default direction for OQ
                    },
                    flags: {
                        convertArabicLatex: false
                    },
                    ARABIC_LATEX_MAP: {
                        "F(x)": "\\dotlessqaft (\\seen)", "Q'": "\\dotlessnoont \\prime", 'N': '\\tah', 'Z': '\\sadt',
                        'Q': '\\dotlessnoont', 'X': '\\seent', 'Y': '\\sadt', 'x': '\\seen', 'y': '\\sad',
                        'z': '\\ain', 'A': '\\alt{\\alef}', 'B': '\\beh', 'C': '\\jeemi', 'D': '\\dal',
                        'E': '\\hehi', 'F': '\\waw', 'M': '\\meem', 'n': '\\noon', 'K': '\\kaf',
                        'L': '\\lam', 's': '\\feh', 'O': '\\waw', 'R': '\\haht', 'r': '\\aint',
                    }
                });
                // --- 2. ENUMS & CONSTANTS ---
                this.QuestionType = Object.freeze({
                    MCQ: "mcq", MRQ: "mrq", STRING: "string", OQ: "oq", GAP_TEXT: "gapText",
                    MATCHING: "matching", INPUT_BOX: "input_box", FRQ: "frq", FRQ_AI: "frq_ai", UNKNOWN: "unknown"
                });
                this.Language = Object.freeze({ ARABIC: "ar", ENGLISH: "en" });
                // --- 3. UTILITIES ---
                this.logger = {
                    info: (message) => console.log(`[INFO] ✨: ${message}`),
                    warn: (message) => console.warn(`[WARN] ⚠️: ${message}`),
                    error: (message, errorObj = '') => console.error(`[ERROR] ❌: ${message}`, errorObj)
                };
                // --- 4. STATE INITIALIZATION ---
                this.questions = [];
                this.isAIProcessing = false;
                this.jsonForExport = '';
                this.activeQuestionType = this.QuestionType.MCQ; // Default for simple text
                this.userExplicitlySelectedType = false;
                this.customization = { ...this.config.defaults };
                this.apiKeys = { gemini: '', openai: '' };
                this.aiProvider = 'gemini';
                this.csvData = [];
                this.hotInstance = null;
                this.aiTemplateHotInstance = null;
                this.language = this.config.defaults.lang;
                this.aiAbortController = null;
                this.validationTimeout = null;
                this.autoSaveTimeout = null;
                this.uploadedImageBase64 = null;
                this.subjectTemplateMap = {
                    "الأحياء": "352108393701",
                    "الرياضيات": "357135867402",
                    "العلوم": "352108393701",
                    "العلوم المتكاملة": "352108393701",
                    "الفيزياء": "352108393701",
                    "الكيمياء": "352108393701",
                    "اللغة العربية": "248170436092",
                    "اكتشف": "248170436092",
                    "التاريخ": "750162567617",
                    "الجغرافيا": "257121690289",
                    "الدراسات الاجتماعية": "738178680941",
                    "الفلسفة والمنطق": "186183541809",
                    "علم النفس والاجتماع": "457197047804",
                    "Biologie": "352108393701",
                    "Biology": "352108393701",
                    "Chemistry": "352108393701",
                    "Connect Plus": "892167914601",
                    "Discover": "352108393701",
                    "English": "328173624946",
                    "Integrated Science": "352108393701",
                    "Mathematics": "357135867402",
                    "Physics": "352108393701",
                    "Science": "352108393701",
                    "Sciences": "352108393701"
                };
                // --- 5. APP BOOTSTRAP ---
                this.loadSettings();
                this.loadApiKeys();
                // FIX: Initialize question type configs BEFORE loading content that depends on it.
                this.renderQuestionTypeButtons();
                this.loadAutoSavedContent();
                this.populateTagsModal();
                this.populateGenerationModal();
                this.setActiveQuestionType(this.activeQuestionType);
                this.updateInterfaceLanguage();
                this.bindEvents();
                this._updateApiProviderUI();
                this.populateSourceIdDropdown();
                this.logger.info("Application initialized successfully.");
            }
            // Safe HTML setter (global sanitizer)
            setSafeHTML(el, html) {
                const safe = DOMPurify.sanitize(html, {
                    ALLOW_DATA_ATTR: true,
                    ALLOW_CUSTOM_ELEMENTS: true,
                    // ADD 'u' to allowed tags for underline
                    ADD_TAGS: ['math-field','span','p','div','strong','ul', 'u', 'li', 'h4', 'h5', 'br', 'b'],
                    ADD_ATTR: ['value','locale','lang','class','dir','style','data-node-type','data-node-variation', 'title', 'aria-label', 'data-question-id', 'data-part-index', 'data-field-type', 'data-choice-index', 'data-math-index', 'default-mode', 'data-tag', 'data-interactive']
                });
                el.innerHTML = safe;
            }
            setLoading(isLoading, textAr = 'جاري التحليل...', textEn = 'Analyzing...') {
                const loading = document.getElementById('loading');
                const loadingText = document.getElementById('loading-text');
                loading.style.display = isLoading ? 'block' : 'none';
                loadingText.textContent = this.language === this.Language.ARABIC ? textAr : textEn;
            }
            bindEvents() {
                document.getElementById('smart-analyze-btn').addEventListener('click', () => this.smartAnalyze());
                document.getElementById('clean-format-btn').addEventListener('click', () => this.cleanAndFormat());
                document.getElementById('aiEnhanceBtn').addEventListener('click', () => this.enhanceWithAI());
                document.getElementById('convert-json-btn').addEventListener('click', () => this.convertToJSON());
                document.getElementById('clear-all-btn').addEventListener('click', () => this.clearAll());
                document.getElementById('langSwitchBtn').addEventListener('click', () => this.toggleLanguage());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyJSON());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadJSON());
                document.getElementById('downloadZipBtn').addEventListener('click', () => this.downloadZip());
                document.getElementById('csvBtn').addEventListener('click', () => this.openCSVModal());
                document.getElementById('csv-modal-close-btn').addEventListener('click', () => this.closeCSVModal());
                document.getElementById('csv-save-btn').addEventListener('click', () => this.saveCSVData());
                document.getElementById('csv-close-btn').addEventListener('click', () => this.closeCSVModal());
                
                // API Provider and Keys
                document.getElementById('aiProviderSelect').addEventListener('change', (e) => this.setAIProvider(e.target.value));
                document.getElementById('geminiApiKey').addEventListener('input', (e) => this.saveApiKeys('gemini', e.target.value));
                document.getElementById('openaiApiKey').addEventListener('input', (e) => this.saveApiKeys('openai', e.target.value));
                
                // Customize Modal Events
                document.getElementById('customizeBtn').addEventListener('click', () => this.openCustomizeModal());
                document.getElementById('customize-modal-close-btn').addEventListener('click', () => this.closeCustomizeModal());
                document.getElementById('customize-save-btn').addEventListener('click', () => this.saveCustomization());
                document.getElementById('aiTemplateBtn').addEventListener('click', () => this.openAiTemplateModal());
                document.getElementById('subjectTemplateBtn').addEventListener('click', () => this.openSubjectTemplateModal());
                
                // Tags Modal Events
                document.getElementById('tagsBtn').addEventListener('click', () => this.toggleTagsModal());
                document.getElementById('tags-modal-close-btn').addEventListener('click', () => this.toggleTagsModal(false));
                this.makeModalDraggable();

                // Generation Modal Events
                document.getElementById('generate-questions-btn').addEventListener('click', () => this.openGenerationModal());
                document.getElementById('modal-cancel-btn').addEventListener('click', () => this.closeGenerationModal());
                document.getElementById('modal-generate-btn').addEventListener('click', () => this.generateQuestionsWithAI());
                this.setupImageDropZone();

                // Auto-Save and Live Validation Event
                document.getElementById('questionInput').addEventListener('input', () => {
                    clearTimeout(this.autoSaveTimeout);
                    this.autoSaveTimeout = setTimeout(() => this.autoSaveContent(), 1000);
                    
                    clearTimeout(this.validationTimeout);
                    this.validationTimeout = setTimeout(() => this.runLiveValidation(), 500);
                });

                // AI Template ID Modal Events
                document.getElementById('ai-template-modal-close-btn').addEventListener('click', () => this.closeAiTemplateModal());
                document.getElementById('ai-template-save-btn').addEventListener('click', () => this.saveAiTemplateData());
                document.getElementById('ai-template-close-btn').addEventListener('click', () => this.closeAiTemplateModal());

                // Subject Template ID Modal Events
                document.getElementById('subject-template-modal-close-btn').addEventListener('click', () => this.closeSubjectTemplateModal());
                document.getElementById('subject-template-save-btn').addEventListener('click', () => this.saveSubjectTemplateData());
                document.getElementById('subject-template-close-btn').addEventListener('click', () => this.closeSubjectTemplateModal());
                document.getElementById('subjectSelect').addEventListener('change', () => this.updateSubjectQuestionsPreview());

                // Modal ESC close
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (document.getElementById('csvModalBg').style.display === 'flex') this.closeCSVModal();
                        if (document.getElementById('customizeModal').style.display === 'flex') this.closeCustomizeModal();
                        if (document.getElementById('aiTemplateModalBg').style.display === 'flex') this.closeAiTemplateModal();
                        if (document.getElementById('subjectTemplateModalBg').style.display === 'flex') this.closeSubjectTemplateModal();
                        if (document.getElementById('tagsModal').style.display === 'block') this.toggleTagsModal(false);
                        if (document.getElementById('generationModalBg').style.display === 'flex') this.closeGenerationModal();
                    }
                });
                document.getElementById('questionsPreview').addEventListener('click', (event) => {
                    const actionTarget = event.target.closest('.action-btn, .btn-save-edit, .btn-cancel-edit');
                    if (actionTarget) {
                        const questionPreview = actionTarget.closest('.question-preview');
                        if (!questionPreview) return;
                        const questionId = questionPreview.dataset.id;
                        if (actionTarget.classList.contains('delete-btn')) this.deleteQuestion(questionId);
                        else if (actionTarget.classList.contains('edit-btn')) this.startEditQuestion(questionId);
                        else if (actionTarget.classList.contains('btn-save-edit')) this.saveEditQuestion(questionId);
                        else if (actionTarget.classList.contains('btn-cancel-edit')) this.cancelEditQuestion(questionId);
                        return;
                    }

                    const choiceTarget = event.target.closest('.choice-item');
                    const partPreview = event.target.closest('.part-preview');
                    if (choiceTarget && partPreview && partPreview.dataset.interactive === 'true') {
                         this.handleChoiceClick(choiceTarget);
                    }
                });
                
                document.getElementById('questionsPreview').addEventListener('input', (e) => {
                    if (e.target.tagName.toLowerCase() === 'math-field') {
                        this.handleMathFieldInput(e);
                    }
                });
            }
            renderQuestionTypeButtons() {
                const container = document.getElementById('questionTypeSelector');
                if (!container) return;
                container.innerHTML = '';
                const configs = {
                    [this.QuestionType.MCQ]: { label: 'MCQ', jsonType: 'mcq' },
                    [this.QuestionType.MRQ]: { label: 'MRQ', jsonType: 'mrq' },
                    [this.QuestionType.MATCHING]: { label: 'Matching', jsonType: 'matching' },
                    [this.QuestionType.GAP_TEXT]: { label: 'Gapped Text', jsonType: 'gapText' },
                    [this.QuestionType.STRING]: { label: 'String', jsonType: 'string' },
                    [this.QuestionType.FRQ]: { label: 'Free Response', jsonType: 'frq' },
                    [this.QuestionType.OQ]: { label: 'Ordering (OQ)', jsonType: 'oq' },
                    [this.QuestionType.FRQ_AI]: { label: 'FRQ (AI)', jsonType: 'frq_ai' },
                    [this.QuestionType.INPUT_BOX]: { label: 'Input Box', jsonType: 'input_box' },
                    [this.QuestionType.UNKNOWN]: { label: 'Unknown', jsonType: 'unknown' } // FIX: Added Unknown type
                };
                this.questionTypeConfigs = configs;
                for (const typeKey in configs) {
                    const config = configs[typeKey];
                    if (typeKey === this.QuestionType.UNKNOWN) continue; // Don't create a button for it
                    const button = document.createElement('button');
                    button.className = 'q-type-btn';
                    button.textContent = config.label;
                    button.dataset.type = typeKey;
                    button.onclick = () => this.setActiveQuestionType(typeKey);
                    container.appendChild(button);
                }
            }
            setActiveQuestionType(typeKey) {
    // --- بداية الجزء الجديد: منطق إلغاء التفعيل ---
    // التحقق مما إذا كان المستخدم يضغط على الزر النشط حاليًا بالفعل
    if (this.activeQuestionType === typeKey && this.userExplicitlySelectedType) {
        
        // إذا كان الأمر كذلك، قم بإلغاء تنشيطه والعودة إلى وضع "الكشف التلقائي"
        this.userExplicitlySelectedType = false;
        
        // إعادة التعيين إلى النوع الافتراضي للاتساق
        this.activeQuestionType = this.QuestionType.MCQ; 

        // إزالة فئة 'active' من جميع الأزرار ليعكس التغيير بصريًا
        document.querySelectorAll('.q-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        return; // الخروج من الدالة لأن مهمتنا انتهت هنا
    }
    // --- نهاية الجزء الجديد ---

    // الجزء القديم: يعمل عندما يتم الضغط على زر جديد
    this.userExplicitlySelectedType = true;
    this.activeQuestionType = typeKey;

    // تحديث النمط المرئي لجميع الأزرار
    document.querySelectorAll('.q-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === typeKey);
    });
}
            // ***************************************************************
            // ** ID & VALIDATION LOGIC **
            // ***************************************************************
            extractDummyIds(content) {
                const dummyIds = [];
                const blocks = content.split(/\n---\n/).filter(block => block.trim());
                blocks.forEach(block => {
                    const lines = block.trim().split('\n');
                    for (const line of lines) {
                        const match = line.match(/^id:\s*(new\w+)/);
                        if (match) { dummyIds.push(match[1]); break; }
                    }
                });
                return [...new Set(dummyIds)];
            }
            async promptForOfficialIds(dummyIds) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;`;
                    const dialog = document.createElement('div');
                    dialog.style.cssText = `background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);`;
                    const isAr = this.language === this.Language.ARABIC;
                    dialog.innerHTML = `
                        <h3 style="margin-bottom: 20px; color: #4f46e5;">${isAr ? `تم العثور على ${dummyIds.length} معرف وهمي` : `Found ${dummyIds.length} dummy IDs`}</h3>
                        <p style="margin-bottom: 20px;">${isAr ? 'الرجاء إدخال المعرفات الرسمية (12 رقم لكل معرف):' : 'Please enter official IDs (12 digits each):'}</p>
                        <div id="idInputs" style="margin-bottom: 20px;"></div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="cancelIds" class="btn btn-secondary">${isAr ? 'إلغاء' : 'Cancel'}</button>
                            <button id="confirmIds" class="btn btn-primary">${isAr ? 'تأكيد' : 'Confirm'}</button>
                        </div>
                    `;
                    const inputsContainer = dialog.querySelector('#idInputs');
                    dummyIds.forEach((dummyId, index) => {
                        const inputDiv = document.createElement('div');
                        inputDiv.style.cssText = 'margin-bottom: 15px; display: flex; align-items: center; gap: 10px;';
                        inputDiv.innerHTML = `<label style="min-width: 100px; font-weight: bold;">${dummyId}:</label>
                            <input type="text" id="officialId_${index}" placeholder="123456789012" maxlength="12" style="flex: 1; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">`;
                        inputsContainer.appendChild(inputDiv);
                    });
                    modal.appendChild(dialog);
                    document.body.appendChild(modal);
                    const cleanup = () => document.body.removeChild(modal);
                    dialog.querySelector('#confirmIds').onclick = () => {
                        const mapping = {}; let valid = true; const usedIds = new Set();
                        dummyIds.forEach((dummyId, index) => {
                            const input = document.getElementById(`officialId_${index}`);
                            const value = input.value.trim();
                            if (!/^\d{12}$/.test(value)) { input.style.borderColor = '#ef4444'; valid = false; }
                            else if (usedIds.has(value)) { input.style.borderColor = '#f59e0b'; valid = false; this.showMessage(isAr ? 'معرفات مكررة!' : 'Duplicate IDs!', 'error'); }
                            else { input.style.borderColor = '#10b981'; mapping[dummyId] = value; usedIds.add(value); }
                        });
                        if (valid) { cleanup(); resolve(mapping); }
                    };
                    dialog.querySelector('#cancelIds').onclick = () => { cleanup(); resolve(null); };
                });
            }
            // ***************************************************************
            // ** PARSING & AI LOGIC **
            // ***************************************************************
            buildAdvancedFormattingPrompt(rawText, forcedType = null) {
                const isArabic = this.language === this.Language.ARABIC;
                
                const examples = `
مثال MCQ (نجمة واحدة فقط):
type: mcq
@STEM
ما عاصمة فرنسا؟
@CHOICES
- لندن
* باريس
- مدريد
---
مثال صواب أم خطأ:
type: mcq
@STEM
هل باريس عاصمة فرنسا؟ صواب أم خطأ؟
@CHOICES
* صواب
- خطأ
---
مثال MRQ (أكثر من نجمة):
type: mrq
@STEM
اختر كل اللغات البرمجية:
@CHOICES
* Python
- HTML
* JavaScript
---
مثال Matching:
type: matching
@STEM
صل الدول بعواصمها:
@MATCHING_PAIRS
فرنسا | باريس
ألمانيا | برلين
---
مثال GapText:
type: gapText
@STEM
الكوكب @BLANK هو الأكبر وله @BLANK قمراً.
@GAPS
المشتري
79
---
مثال معادلة معقدة:
type: string
@STEM
أوجد حل النظام التالي:
\`\`
\\begin{cases} x+y=5 \\\\ x-y=1 \\end{cases}
\`\`
@ANSWER
x=3, y=2
`;
                let typeInstruction = '1.  **حدد نوع** كل سؤال بناءً على محتواه.'; // دي الجملة الافتراضية
if (forcedType && forcedType !== 'unknown') {
    typeInstruction = `مهمتك هي تنسيق النص التالي **كنوع سؤال ${forcedType}** بشكل إلزامي. لا تحاول تخمين أو اكتشاف أي نوع آخر.`;
}
                
                const basePromptAr = `
أنت أداة دقيقة لتحويل النصوص إلى تنسيق محدد. مهمتك الوحيدة هي تحديد أجزاء النص (السؤال، الاختيارات، الإجابة.. إلخ) ووضع الوسوم (Tags) المناسبة حولها.

**مهم جدًا: لا تقم بتغيير، أو تصحيح، أو إضافة، أو حذف أي جزء من النص الأصلي إطلاقًا.** حافظ على الكلمات والمحتوى الأصلي تمامًا كما هو. وظيفتك هي فقط تطبيق هيكل التنسيق المطلوب.

**التعليمات الأساسية:**
${typeInstruction}

2.  **أخرج كل سؤال بالتنسيق التالي دون أي تغيير في المحتوى:**
    -   سطر بيانات وصفية في الأعلى، مثال: \`type: mcq\`
    -   وسم \`@STEM\` لنص السؤال الرئيسي.
    -   وسوم المحتوى حسب نوع السؤال (\`@CHOICES\`, \`@MATCHING_PAIRS\`, \`@GAPS\`, \`@ANSWER\`).
    -   استخدم \`---\` للفصل بين كل سؤال وآخر.

**قواعد أنواع الأسئلة (مهم):**
-   **MCQ/MRQ:** استخدم \`*\` قبل الإجابة الصحيحة و \`-\` قبل الخاطئة. **MCQ** يجب أن يحتوي على نجمة واحدة فقط، بينما **MRQ** يمكن أن يحتوي على نجمة واحدة أو أكثر.
-   **أسئلة الصواب والخطأ:** الأسئلة التي تحتوي على "صواب أم خطأ"، "خطأ أم صواب"، "true or false"، "false or true" يجب تنسيقها كـ MCQ مع وضع "صواب" أو "True" كأول اختيار.
-   **Matching:** يجب أن تكون الأزواج في \`@MATCHING_PAIRS\` مفصولة بـ \`|\`.
-   **GapText:** استخدم \`@BLANK\` في نص السؤال لكل فجوة، وضع الإجابات بالترتيب في \`@GAPS\`.
-   **Input Box:** يجب أن تكون الإجابة في \`@ANSWER\` بصيغة \`القيمة | الوحدة\` أو \`القيمة\` فقط إذا لم تكن هناك وحدة.

**قواعد الرياضيات (مهمة للغاية ويجب اتباعها بدقة):**
-   **لا تقم أبدًا بتعديل** محتوى أو صيغة أي كود LaTeX.
-   **حوّل المحددات السطرية (inline):** أي نص محاط بـ \`\$...\$\` أو \`\\(...\\)\` يجب لفه بـ \`...\` (backtick فردية).
-   **حوّل المحددات العرض (display):** أي نص محاط بـ \`\$\$...\$\$\` أو \`\\[...\\]\` يجب لفه بـ \`\`...\`\` (backticks مزدوجة).
-   **حوّل البيئات المعقدة:** أي كتلة LaTeX تبدأ بـ \`\\begin{...}\` وتنتهي بـ \`\\end{...}\` يجب أن تُعامل **دائمًا** كمعادلة عرض وتُلف بـ \`\`...\`\` (backticks مزدوجة).

لا تخترع أي محتوى. اتبع القواعد بدقة.


**نماذج:**
${examples}

**النص المطلوب تحويله:**
${rawText}

**الناتج المنسق:**
`;
                const basePromptEn = `
You are an expert question formatter and a meticulous academic assistant. Your task is to convert unstructured text into a standardized, structured format.

**Core Instructions:**
1.  **Detect** every question in the text.
2.  **Auto-detect** the type for each question from: mcq, mrq, oq, gapText, matching, string, frq, frq_ai, input_box.
3.  **Format each question as follows:**
    -   A metadata line at the top, e.g., \`type: mcq\`
    -   A \`@STEM\` tag for the main question text.
    -   Content tags based on the question type (\`@CHOICES\`, \`@MATCHING_PAIRS\`, \`@GAPS\`, \`@ANSWER\`).
    -   Use \`---\` to separate each question.

**Question Type Rules (Important):**
-   **MCQ/MRQ:** Use \`*\` before a correct answer and \`-\` before an incorrect one. **MCQ** must have exactly one star, while **MRQ** can have one or more.
-   **True/False Questions:** Questions containing "true or false", "false or true", "صواب أم خطأ", "خطأ أم صواب" should be formatted as MCQ with "True" or "صواب" as the first choice.
-   **Matching:** Pairs under \`@MATCHING_PAIRS\` must be separated by \`|\`.
-   **GapText:** Use \`@BLANK\` in the stem for each gap, and place the ordered answers under \`@GAPS\`.
-   **Input Box:** The answer under \`@ANSWER\` should be in the format \`value | unit\` or just \`value\` if there is no unit.

**Mathematics Rules (Crucial and must be followed precisely):**
-   **Never modify** the content or syntax of any LaTeX code.
-   **Convert inline delimiters:** Any text surrounded by \`\$...\$\` or \`\\(...\\)\` must be wrapped with \`...\` (single backticks).
-   **Convert display delimiters:** Any text surrounded by \`\$\$...\$\$\` or \`\\[...\\]\` must be wrapped with \`\`...\`\` (double backticks).
-   **Convert complex environments:** Any LaTeX block that starts with \`\\begin{...}\` and ends with \`\\end{...}\` must **always** be treated as display math and wrapped with \`\`...\`\` (double backticks).

Do not invent any content. Follow the rules precisely.

**Examples:**
${examples}

**Input Text to Convert:**
${rawText}

**Formatted Output:**
`;
                return isArabic ? basePromptAr : basePromptEn;
            }
            cleanFormattedText(t) {
                if (!t) return '';
                let s = t.trim();
                const fence = s.match(/```[a-zA-Z0-9]*\s*\n([\s\S]*?)\n```/);
                if (fence) s = fence[1].trim();
                s = s.replace(/^\s*(Here's the formatted text:|إليك النص المُنسق:|The formatted text is:)\s*/gmi, '');
                s = s.replace(/\n{3,}/g, '\n\n');
                return s.trim();
            }
            
            convertDollarMathToBackticks(text) {
                if (!text) return text;
                return text
                    .replace(/\$\$([\s\S]*?)\$\$/g, '``$1``')
                    .replace(/\$([^\$\n]+?)\$/g, '`$1`')
                    .replace(/```math\s*\n([\s\S]*?)\n```/g, '``$1``')
                    .replace(/\\\(([\s\S]*?)\\\)/g, '`$1`');
            }
            
            autoDetectTypeFromContent(block) {
                const hasChoices = /@CHOICES/i.test(block);
                const hasAnswer = /@ANSWER/i.test(block);
                const hasGaps = /@GAPS/i.
