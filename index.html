<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>معالج الأسئلة </title>
    <!-- Handsontable CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Naskh+Arabic:wght@400..700&display=swap" rel="stylesheet">

    <style>
        /* --- Basic Setup --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Noto Naskh Arabic", 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #e51d74;
            min-height: 100vh; padding: 20px; color: #333;
            display: flex; align-items: center; justify-content: center;
        }
        /* --- Main Container --- */
        .container {
            width: 100%; max-width: 1600px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.98); border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); overflow: hidden;
        }
        /* --- Header --- */
        .header {
            background: #e51d74;
            color: white; padding: 30px; text-align: center; position: relative; overflow: hidden;
        }
        .header::before {
            content: ''; position: absolute; top: -50%; left: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3); position: relative; z-index: 1; }
        .header p { font-size: 1.2em; opacity: 0.9; position: relative; z-index: 1; text-align: justify; }
        .ai-badge {
            position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px; border-radius: 20px; font-size: 0.9em; backdrop-filter: blur(10px);
            text-align: justify; /* يمكن إضافته هنا إذا كانت الفقرة طويلة */
        }
        /* --- Content Layout --- */
        .content {
            padding: 40px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 30px;
        }
        .panel {
            background: #f8fafc; border-radius: 15px; padding: 25px; border: 2px solid #e2e8f0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; display: flex; flex-direction: column;
        }
        .panel:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .panel h3 { color: #4f46e5; margin-bottom: 20px; font-size: 1.3em; display: flex; align-items: center; gap: 10px; }
        .question-type-selector {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px;
        }
        .q-type-btn { padding: 10px; border: 2px solid #e2e8f0; border-radius: 10px; background-color: #fff; cursor: pointer; transition: all 0.2s ease-in-out; font-weight: 600; color: #475569; text-align: center; }
        .q-type-btn:hover { background-color: #f1f5f9; border-color: #cbd5e1; }
        .q-type-btn.active { background-color: #e0e7ff; border-color: #4f46e5; color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .input-section textarea, .edit-textarea {
            width: 100%; min-height: 250px; padding: 20px; border: 2px solid #e5e7eb; border-radius: 15px;
            font-size: 14px; line-height: 1.6; resize: vertical; transition: all 0.3s ease;
            background: white; margin-bottom: 10px;
            text-align: justify; /* أضف هذا السطر */
    direction: rtl; /* تأكد أن النص يكتب من اليمين لليسار مع المحاذاة */
        }
        .input-section textarea:focus, .edit-textarea:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .api-key-section { margin-top: 15px; }
        .api-key-section input, .api-key-section select {
            width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; transition: all 0.3s ease; margin-bottom: 10px;
        }
        .api-key-section input:focus, .api-key-section select:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .controls .btn { flex-grow: 1; }
        .btn {
            padding: 15px 20px; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;
            text-transform: uppercase; letter-spacing: 1px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition: left 0.5s; }
        .btn:hover:before { left: 100%; }
        .btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3); }
        .btn-secondary { background: #f3f4f6; color: #374151; border: 2px solid #d1d5db; }
        .btn-secondary:hover:not(:disabled) { background: #e5e7eb; border-color: #9ca3af; }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .btn-ai { background: linear-gradient(135deg, #ec4899 0%, #d946ef 100%); color: white; }
        .btn-ai:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(236, 72, 153, 0.3); }
        .json-output {
            background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 12px; font-family: 'Courier New', monospace;
            font-size: 13px; line-height: 1.4; overflow-x: auto; white-space: pre-wrap; max-height: 500px; overflow-y: auto; border: 1px solid #334155; flex-grow: 1; margin-top: 15px;
        }
        .json-output .key { color: #60a5fa; } .json-output .string { color: #34d399; } .json-output .number { color: #fbbf24; }
        .json-output .boolean { color: #f87171; } .json-output .null { color: #a78bfa; }
        .analysis-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
        .analysis-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f3f4f6; font-size: 0.9em; }
        .analysis-item:last-child { border-bottom: none; }
        .confidence-bar { width: 100px; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b, #10b981); border-radius: 4px; transition: width 0.5s ease-in-out; }
        #questionsPreview { flex-grow: 1; overflow-y: auto; max-height: 70vh; }
        .question-preview { background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); animation: fadeIn 0.5s ease; position: relative; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .question-actions { position: absolute; top: 10px; left: 10px; display: none; gap: 8px; z-index: 10; }
        .question-preview:hover .question-actions { display: flex; }
        .action-btn { background: rgba(249, 250, 251, 0.8); border: 1px solid #d1d5db; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; backdrop-filter: blur(2px); }
        .action-btn:hover { background: #4f46e5; border-color: #4f46e5; color: white; transform: scale(1.1); }
        .action-btn:disabled { opacity: 0.4; cursor: not-allowed; background: #e5e7eb; }
        .validation-warning {
            position: absolute;
            top: 15px;
            left: 50px;
            font-size: 1.2em;
            cursor: help;
        }
        .question-preview h4, .question-preview .statement-preview { color: #374151; margin-bottom: 10px; font-size: 1.1em; line-height: 1.6; text-align: justify; }
        .part-preview { border-top: 2px dashed #a5b4fc; margin-top: 15px; padding-top: 15px; }
        .part-preview h5 { color: #4338ca; font-size: 1em; margin-bottom: 8px; }
        .question-type-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px; }
        .type-mcq { background: #dbeafe; color: #1e40af; } .type-mrq { background: #e0e7ff; color: #3730a3; } .type-matching { background: #e0e7ff; color: #3730a3; }
        .type-gapText { background: #d1fae5; color: #065f46; } .type-string { background: #fef3c7; color: #92400e; }
        .type-frq { background: #fce7f3; color: #be185d; } .type-frq_ai { background: #fce7f3; color: #be185d; }
        .type-oq { background: #fef9c3; color: #854d0e; } .type-input_box { background: #f3e8ff; color: #6b21a8; } .type-unknown { background: #fee2e2; color: #991b1b; }
        .choice-item { padding: 8px 15px; margin: 5px 0; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; transition: all 0.2s ease; text-align: justify; }
        .part-preview[data-interactive="true"] .choice-item { cursor: pointer; }
        .part-preview[data-interactive="true"] .choice-item:hover { background: #f3f4f6; border-color: #4f46e5; }
        .choice-item.correct { background: #dcfce7; border-color: #16a34a; color: #15803d; font-weight: bold; }
        .choice-item.correct::before { content: '✔ '; color: #15803d; }
        .matching-preview { display: flex; gap: 20px; }
        .matching-column { flex: 1; }
        .matching-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
        .gapped-text-answers { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; }
        .gapped-text-answers strong { color: #4f46e5; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); }
        .stat-card h4 { color: #4f46e5; margin-bottom: 10px; font-size: 0.9em; }
        .stat-card span { font-size: 2em; font-weight: bold; color: #1f2937; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        .btn .spinner { width: 20px; height: 20px; margin: 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .message-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .message { padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); animation: slideIn 0.5s ease, fadeOut 0.5s ease 3.5s forwards; font-weight: 500; min-width: 300px; text-align: center; position: relative; }
        .message.error { background: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .message.success { background: #dcfce7; color: #065f46; border: 1px solid #a7f3d0; }
        .message.warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .message .close-x { position: absolute; top: 6px; left: 8px; cursor: pointer; font-weight: bold; opacity: .6; }
        @keyframes slideIn { from { transform: translateY(-50px) translateX(-50%); opacity: 0; } to { transform: translateY(0) translateX(-50%); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-20px) translateX(-50%); } }
        #csvModalBg, #aiTemplateModalBg, #subjectTemplateModalBg, #generationModalBg {
            display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25); z-index: 3000; align-items: center; justify-content: center;
        }
        #csvModal, #aiTemplateModal, #subjectTemplateModal {
            background: white; border-radius: 16px; max-width: 1200px; width: 95vw; padding: 32px 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); position: relative; min-height: 600px; min-width: 900px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #csvModal .hot-container, #aiTemplateModal .hot-container { margin-bottom: 18px; width: 100%; }
        #csvModal .btn, #aiTemplateModal .btn, #subjectTemplateModal .btn { min-width: 120px; }
        #csvModal .csv-warning { color: #dc2626; font-weight: bold; margin-bottom: 10px; }
        
        math-field {
            border: 1px solid #ddd; padding: 2px 5px; border-radius: 4px; font-size: 1.1em; 
            display: inline-block; background: #f9f9f9;
            min-width: 20px;
            vertical-align: -0.25em;
        }
        math-field:focus-within {
            background-color: #eef2ff;
            box-shadow: 0 0 0 2px #4f46e5;
            outline: none;
        }

        /* --- Tags Modal --- */
        #tagsModal {
            display: none;
            position: fixed;
            top: 150px;
            left: 150px;
            width: 380px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 4000;
            border: 1px solid #ccc;
        }
        #tagsModalHeader {
            padding: 12px 15px;
            cursor: move;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #475569;
        }
        #tags-modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #64748b;
            line-height: 1;
        }
        #tagsModalBody {
            padding: 15px;
        }
        .tags-section h4 {
            font-size: 1em;
            color: #4f46e5;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e0e7ff;
        }
        .tags-grid {
             display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .tag-btn {
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .tag-btn:hover {
            background: #e0e7ff;
            border-color: #4f46e5;
            color: #4f46e5;
        }
        
        /* --- Generation Modal --- */
        #generationModal {
            background: white; border-radius: 16px; max-width: 1200px; width: 95vw; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); position: relative; 
            display: flex; flex-direction: column;
            max-height: 90vh;
        }
        .generation-header {
            padding: 1.25rem 1.5rem; border-bottom: 1px solid #e5e7eb;
        }
        .generation-header h2 { color: #4f46e5; }
        .generation-content {
            display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;
            padding: 1.5rem; overflow-y: auto;
        }
        .generation-column h4 { margin-bottom: 1rem; color: #4338ca; }
        .generation-footer {
            padding: 1rem 1.5rem; border-top: 1px solid #e5e7eb; text-align: left;
        }
        #gen-image-drop-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 2rem; text-align: center;
            color: #64748b; cursor: pointer; transition: all 0.2s ease;
        }
        #gen-image-drop-zone.dragover { background: #eef2ff; border-color: #4f46e5; }
        #gen-image-preview { margin-top: 1rem; max-width: 100%; max-height: 150px; border-radius: 8px; }
        .gen-q-type-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .gen-q-type-row label { font-weight: 500; }
        .gen-q-type-row input { width: 60px; padding: 5px 8px; border-radius: 6px; border: 1px solid #d1d5db; text-align: center; }
        #gen-multi-part-types { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #d1d5db; margin-top: 5px; }


        @media (max-width: 1200px) { .content { grid-template-columns: 1fr 1fr; } }
        @media (max-width: 768px) {
            body { padding: 10px; } .content { grid-template-columns: 1fr; padding: 20px; }
            .header h1 { font-size: 2em; } .header p { font-size: 1em; }
            .controls { flex-direction: column; } .btn { width: 100%; } .question-type-selector { grid-template-columns: 1fr 1fr; }
            .generation-content { grid-template-columns: 1fr; }
        }


        .noto-naskh-arabic { font-family: "Noto Naskh Arabic", serif; font-optical-sizing: auto; font-style: normal; font-size: 18px; }

        
    </style>
    
</head>
<body>
    <div id="messageContainer" class="message-container"></div>
    <div class="container">
        <div class="header">
            <div class="ai-badge">🤖 AI Powered</div>
            <h1 id="main-title">🚀 معالج الأسئلة</h1>
            <p id="main-subtitle">حوّل نصوص الأسئلة إلى صيغة JSON متقدمة بضغطة زر</p>
        </div>
        <div class="content">
            <!-- Input Panel -->
            <div class="panel ">
                <h3 id="panel-title-1"><span style="font-size: 1.5em; line-height: 1;">①</span> اختر نوع السؤال (للنص البسيط)</h3>
                <div id="questionTypeSelector" class="question-type-selector"></div>
                <h3 id="panel-title-2" style="margin-top: 20px;"><span style="font-size: 1.5em; line-height: 1;">②</span> أدخل النص</h3>
                <div class="input-section">
                    <textarea id="questionInput" class="noto-naskh-arabic" placeholder="أدخل محتوى السؤال هنا...
سيتم تجاهل أي بيانات وصفية مثل id أو language (ما عدا type الذي سيضاف تلقائيًا).
استخدم الوسوم مثل @STEM و @CHOICES لتحديد أجزاء السؤال.
افصل بين كل سؤال بـ ---
"></textarea>
                </div>
                <div class="api-key-section">
                    <select id="aiProviderSelect">
                        <option value="gemini" selected>Google Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                    <div id="gemini-key-container">
                        <input type="password" id="geminiApiKey" placeholder="🔑 أدخل مفتاح Gemini API هنا">
                    </div>
                    <div id="openai-key-container" style="display: none;">
                        <input type="password" id="openaiApiKey" placeholder="🔑 أدخل مفتاح OpenAI API هنا">
                    </div>
                </div>
                <div class="controls">
                    <button id="generate-questions-btn" class="btn btn-primary" aria-label="توليد أسئلة">🚀 توليد أسئلة</button>
                    <button id="smart-analyze-btn" class="btn btn-primary" aria-label="تحليل ذكي">🤖 تحليل ذكي</button>
                </div>
                 <div class="controls">
                    <button id="clean-format-btn" class="btn btn-secondary" aria-label="تنظيف وتنسيق">✨ تنظيف وتنسيق</button>
                    <button id="aiEnhanceBtn" class="btn btn-ai" aria-label="تحسين بالذكاء الاصطناعي">💎 تحسين بالـ AI</button>
                </div>
                <div class="controls">
                    <button id="convert-json-btn" class="btn btn-success" aria-label="تحويل إلى JSON">🔄 تحويل لـ JSON</button>
                    <button id="customizeBtn" class="btn btn-secondary" aria-label="تخصيص">⚙️ تخصيص</button>
                    <button id="tagsBtn" class="btn btn-secondary" aria-label="إدراج وسم">🏷️ Tags</button>
                    <button id="clear-all-btn" class="btn btn-secondary" aria-label="مسح الكل">🗑️ مسح الكل</button>
                    <button id="langSwitchBtn" class="btn btn-warning" aria-label="تبديل اللغة">🌐 English</button>
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p id="loading-text">جاري التحليل...</p>
                </div>
            </div>
            <!-- Analysis & Output Panel -->
            <div class="panel">
                <h3 id="panel-title-3">🔍 تحليل ومخرجات</h3>
                <div class="analysis-section" id="analysisSection">
                    <div class="analysis-item"><span id="analysis-label-1">جودة الكشف:</span><div class="confidence-bar"><div id="detectionQuality" class="confidence-fill" style="width: 0%"></div></div></div>
                    <div class="analysis-item"><span id="analysis-label-2">دقة التصنيف:</span><div class="confidence-bar"><div id="classificationAccuracy" class="confidence-fill" style="width: 0%"></div></div></div>
                    <div class="analysis-item"><span id="analysis-label-3">اكتمال البيانات:</span><div class="confidence-bar"><div id="dataCompleteness" class="confidence-fill" style="width: 0%"></div></div></div>
                </div>
                <div class="stats" id="stats">
                    <div class="stat-card"><h4 id="stats-label-1">إجمالي الأسئلة</h4><span id="totalQuestions">0</span></div>
                    <div class="stat-card"><h4 id="stats-label-2">معدل الثقة</h4><span id="confidenceScore">0%</span></div>
                </div>
                <div class="json-output" id="jsonOutput" style="display: none;"></div>
                <div class="controls" style="margin-top: auto;">
                    <button id="copyBtn" class="btn btn-secondary" disabled aria-label="نسخ JSON">📋 نسخ JSON</button>
                    <button id="downloadBtn" class="btn btn-warning" disabled aria-label="تحميل JSON">💾 تحميل</button>
                    <button id="downloadZipBtn" class="btn btn-warning" disabled aria-label="تحميل ZIP">🗜️ تحميل كـ ZIP</button>
                    <button id="csvBtn" class="btn btn-secondary" disabled aria-label="CSV">📄 CSV</button>
                </div>
            </div>
            <!-- Preview Panel -->
            <div class="panel">
                <h3 id="panel-title-4">👁️ معاينة الأسئلة</h3>
                <div id="questionsPreview">
                    <div id="preview-placeholder" style="text-align: center; color: #6b7280; padding: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="font-size: 3em; margin-bottom: 20px;">📋</div>
                        <p>ستظهر معاينة الأسئلة هنا بعد التحليل</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Customize Modal -->
    <div id="customizeModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;" role="dialog" aria-modal="true" aria-labelledby="customize-title">
        <div style="background:white; border-radius:16px; max-width:400px; width:90vw; padding:32px 24px; box-shadow:0 8px 32px rgba(0,0,0,0.15); position:relative;">
            <button id="customize-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="customize-title" style="text-align:center; margin-bottom:24px; color:#4f46e5;">تخصيص الإعدادات</h2>
            <div style="margin-bottom:18px;">
                <label for="categorySelect" style="font-weight:bold;">Category</label>
                <select id="categorySelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="lesson" selected>lesson</option>
                    <option value="exam">exam</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="directionSelect" style="font-weight:bold;">اتجاه الترتيب (OQ)</label>
                <select id="directionSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="vertical" selected>Vertical (عمودي)</option>
                    <option value="horizontal">Horizontal (أفقي)</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="langSelect" style="font-weight:bold;">Lang</label>
                <select id="langSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="ar" selected>ar</option>
                    <option value="en">en</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="countrySelect" style="font-weight:bold;">Country</label>
                <select id="countrySelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="eg" selected>eg</option>
                    <option value="sa">sa</option>
                    <option value="ae">ae</option>
                    <option value="kw">kw</option>
                    <option value="qa">qa</option>
                    <option value="bh">bh</option>
                    <option value="om">om</option>
                </select>
            </div>
            <div style="margin-bottom:18px;">
                <label for="sourceIdSelect" style="font-weight:bold;">Source ID (Name)</label>
                <select id="sourceIdSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="qa">qa</option>
                    <option value="bh">bh</option>
                    <option value="om">om</option>
                </select>
            </div>
            <div style="margin-bottom:24px;">
                <label for="dialectSelect" style="font-weight:bold;">Dialect</label>
                <select id="dialectSelect" style="width:100%; padding:10px; border-radius:8px; border:1px solid #e5e7eb; margin-top:6px;">
                    <option value="Modern_standard" selected>Modern_standard</option>
                </select>
            </div>
            <button id="aiTemplateBtn" class="btn btn-secondary" style="width:100%; margin-top: 10px;">AI Template ID</button>
            <button id="subjectTemplateBtn" class="btn btn-secondary" style="width:100%; margin-top: 10px;">Subject Template ID</button>
            <button id="customize-save-btn" class="btn btn-primary" style="width:100%; margin-top: 10px;">حفظ</button>
        </div>
    </div>
    <!-- Tags Modal -->
    <div id="tagsModal">
        <div id="tagsModalHeader">
            <span>إدراج وسم (Tag)</span>
            <button id="tags-modal-close-btn" aria-label="إغلاق">×</button>
        </div>
        <div id="tagsModalBody">
             <div class="tags-section" id="templates-section">
                <h4>إدراج قالب جاهز</h4>
                <div class="tags-grid"></div>
            </div>
            <div class="tags-section" id="tags-section">
                <h4>إدراج وسم</h4>
                <div class="tags-grid"></div>
            </div>
        </div>
    </div>
    <!-- Generation Modal -->
    <div id="generationModalBg">
        <div id="generationModal">
            <div class="generation-header">
                <h2>🚀 توليد أسئلة بالذكاء الاصطناعي</h2>
            </div>
            <div class="generation-content">
                <div class="generation-column">
                    <h4>① أدخل المحتوى</h4>
                    <textarea id="gen-text-input" placeholder="الصق محتوى الدرس هنا..." style="width:100%; height: 200px; border-radius: 8px; border: 1px solid #d1d5db; padding: 10px; margin-bottom: 1rem;"></textarea>
                    <input type="file" id="gen-image-input" accept="image/*" style="display:none;">
                    <div id="gen-image-drop-zone">
                        <p>اسحب وأفلت صورة هنا، أو انقر للاختيار</p>
                        <img id="gen-image-preview" style="display:none;">
                    </div>
                </div>
                <div class="generation-column">
                    <h4>② حدد الإعدادات</h4>
                    <div id="gen-q-types-container"></div>
                    <hr style="margin: 1rem 0;">
                    <div class="gen-q-type-row">
                        <label for="gen-multi-part-count">سؤال متعدد الأجزاء</label>
                        <input type="number" id="gen-multi-part-count" min="0" value="0">
                    </div>
                    <input type="text" id="gen-multi-part-types" placeholder="أنواع الأجزاء (مثال: mcq, string)">
                    <hr style="margin: 1rem 0;">
                    <h4>③ (اختياري) أضف توجيهات خاصة</h4>
                    <textarea id="gen-custom-prompt" placeholder="مثال: ركز على المفاهيم الرئيسية، اجعل الأسئلة للمرحلة الإعدادية..." style="width:100%; height: 100px; border-radius: 8px; border: 1px solid #d1d5db; padding: 10px;"></textarea>
                </div>
            </div>
            <div class="generation-footer">
                <button id="modal-generate-btn" class="btn btn-primary">توليد الأسئلة</button>
                <button id="modal-cancel-btn" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>
    <!-- Handsontable CSV Modal -->
    <div id="csvModalBg" role="dialog" aria-modal="true" aria-labelledby="csv-title">
        <div id="csvModal">
            <button id="csv-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="csv-title" style="text-align:center; margin-bottom:18px; color:#4f46e5;">CSV Editor</h2>
            <div class="csv-warning" id="csvWarning" style="display:none;"></div>
            <div id="hotTable" class="hot-container"></div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                <button id="csv-save-btn" class="btn btn-success">💾 حفظ</button>
                <button id="csv-close-btn" class="btn btn-secondary">❌ إغلاق</button>
            </div>
        </div>
    </div>
    <!-- AI Template ID Modal -->
    <div id="aiTemplateModalBg" role="dialog" aria-modal="true" aria-labelledby="ai-template-title">
        <div id="aiTemplateModal">
            <button id="ai-template-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="ai-template-title" style="text-align:center; margin-bottom:18px; color:#4f46e5;">Set AI Template IDs</h2>
            <div id="hotAiTemplateTable" class="hot-container"></div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                <button id="ai-template-save-btn" class="btn btn-success">💾 حفظ</button>
                <button id="ai-template-close-btn" class="btn btn-secondary">❌ إغلاق</button>
            </div>
        </div>
    </div>
    <!-- Subject Template ID Modal -->
    <div id="subjectTemplateModalBg" role="dialog" aria-modal="true" aria-labelledby="subject-template-title">
        <div id="subjectTemplateModal">
            <button id="subject-template-modal-close-btn" style="position:absolute; top:12px; left:12px; background:none; border:none; font-size:1.5em; cursor:pointer;" aria-label="إغلاق">×</button>
            <h2 id="subject-template-title" style="text-align:center; margin-bottom:18px; color:#4f46e5;">اختر المادة لتطبيق Template ID</h2>
            <div style="margin-bottom: 20px;">
                <label for="subjectSelect" style="font-weight:bold; display:block; margin-bottom:10px;">المادة / Subject:</label>
                <select id="subjectSelect" style="width:100%; padding:12px; border-radius:8px; border:2px solid #e5e7eb; font-size:14px;">
                    <option value="">-- اختر المادة --</option>
                    <option value="الأحياء">الأحياء</option>
                    <option value="الرياضيات">الرياضيات</option>
                    <option value="العلوم">العلوم</option>
                    <option value="العلوم المتكاملة">العلوم المتكاملة</option>
                    <option value="الفيزياء">الفيزياء</option>
                    <option value="الكيمياء">الكيمياء</option>
                    <option value="اللغة العربية">اللغة العربية</option>
                    <option value="اكتشف">اكتشف</option>
                    <option value="التاريخ">التاريخ</option>
                    <option value="الجغرافيا">الجغرافيا</option>
                    <option value="الدراسات الاجتماعية">الدراسات الاجتماعية</option>
                    <option value="الفلسفة والمنطق">الفلسفة والمنطق</option>
                    <option value="علم النفس والاجتماع">علم النفس والاجتماع</option>
                    <option value="Biologie">Biologie</option>
                    <option value="Biology">Biology</option>
                    <option value="Chemistry">Chemistry</option>
                    <option value="Connect Plus">Connect Plus</option>
                    <option value="Discover">Discover</option>
                    <option value="English">English</option>
                    <option value="Integrated Science">Integrated Science</option>
                    <option value="Mathematics">Mathematics</option>
                    <option value="Physics">Physics</option>
                    <option value="Science">Science</option>
                    <option value="Sciences">Sciences</option>
                </select>
            </div>
            <div id="subjectQuestionsPreview" style="margin-bottom:20px; max-height:300px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:8px; padding:15px; background:#f8fafc;">
                <p style="text-align:center; color:#6b7280;">ستظهر الأسئلة المؤهلة هنا بعد اختيار المادة</p>
            </div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:18px;">
                <button id="subject-template-save-btn" class="btn btn-success">💾 تطبيق</button>
                <button id="subject-template-close-btn" class="btn btn-secondary">❌ إغلاق</button>
            </div>
        </div>
    </div>
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/handsontable@14.3.0/dist/handsontable.min.js"></script>
    <script src="https://unpkg.com/mathlive"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        class AIQuestionConverter {
            // Source ID data
            sourceIdData = [
                { source_id: 314104834603, name: 'abdelrahman.taha@nagwa.com' }, { source_id: 743127867978, name: 'abdelrahman.toraya@nagwa.com' },
                    { source_id: 915157263490, name: 'ahmed.abdullah@nagwa.com' }, { source_id: 582103718642, name: 'ahmed.mansour@nagwa.com' },
                    { source_id: 852152386193, name: 'amal.abdelwahaab@nagwa.com' }, { source_id: 363101910619, name: 'amira.ahmad@nagwa.com' },
                    { source_id: 969141357647, name: 'amira.mohsen@nagwa.com' }, { source_id: 495183190468, name: 'aya.elshaheny@nagwa.com' },
                    { source_id: 734172083271, name: 'eman.farouk@nagwa.com' }, { source_id: 186142928704, name: 'abdalrahman.mohamed@nagwa.com' },
                    { source_id: 670149460968, name: 'abdellatif.meshref@nagwa.com' }, { source_id: 798193794391, name: 'abdullah.omar@nagwa.com' },
                    { source_id: 320146508191, name: 'ahmed.abdelghaffar@nagwa.com' }, { source_id: 568172629218, name: 'ahmed.ginidi@nagwa.com' },
                    { source_id: 939194952908, name: 'ahmed.magraalneel@nagwa.com' }, { source_id: 904175235414, name: 'ahmed.mohamed@nagwa.com' },
                    { source_id: 813189691358, name: 'ahmed.ragab@nagwa.com' }, { source_id: 309107619576, name: 'ahmed.rahmy@nagwa.com' },
                    { source_id: 198132915098, name: 'ahmed.shoeib@nagwa.com' }, { source_id: 810104279180, name: 'alaa.elgallab@nagwa.com' },
                    { source_id: 976157364031, name: 'alessandra.battistelli@nagwa.com' }, { source_id: 367187313289, name: 'alex.collins@nagwa.com' },
                    { source_id: 962123745478, name: 'alzahraa.elsayed@nagwa.com' }, { source_id: 630126405463, name: 'amanda.winn@nagwa.com' },
                    { source_id: 387160951260, name: 'amany.hassan@nagwa.com' }, { source_id: 567182705230, name: 'amira.doghaiem@nagwa.com' },
                    { source_id: 658131209030, name: 'amira.elsaady@nagwa.com' }, { source_id: 753136182320, name: 'amira.rashad@nagwa.com' },
                    { source_id: 540175279150, name: 'amr.abdelhakim@nagwa.com' }, { source_id: 660341756260, name: 'amr.khattab@nagwa.com' },
                    { source_id: 456170383670, name: 'amr.sobhy@nagwa.com' }, { source_id: 802165404853, name: 'amy.obrien@nagwa.com' },
                    { source_id: 498148235147, name: 'andre.pegeron@nagwa.com' }, { source_id: 938189854643, name: 'andrew.catanese@nagwa.com' },
                    { source_id: 978107247356, name: 'anita.piatek@nagwa.com' }, { source_id: 168170145619, name: 'anna.gilbert@nagwa.com' },
                    { source_id: 810178027057, name: 'anne-claire.dupuis@nagwa.com' }, { source_id: 389194237254, name: 'aryeh.krischer@nagwa.com' },
                    { source_id: 360528767742, name: 'ashraf.omara@nagwa.com' }, { source_id: 583151471710, name: 'aya.emam@nagwa.com' },
                    { source_id: 789171397037, name: 'aya.khaled@nagwa.com' }, { source_id: 438153757180, name: 'aya.mohamed@nagwa.com' },
                    { source_id: 939153820125, name: 'bailey.miller@nagwa.com' }, { source_id: 819120860581, name: 'beejal.parbhoo@nagwa.com' },
                    { source_id: 314185910980, name: 'benjamin.milnes@nagwa.com' }, { source_id: 680128161730, name: 'cara.sullivan@nagwa.com' },
                    { source_id: 285176950135, name: 'catherine.carney@nagwa.com' }, { source_id: 236136940914, name: 'claire.piochon@nagwa.com' },
                    { source_id: 380156798067, name: 'dahlia.hesham@nagwa.com' }, { source_id: 304840675231, name: 'dalia.frag@nagwa.com' },
                    { source_id: 197107685076, name: 'dalia.saber@nagwa.com' }, { source_id: 934103738395, name: 'damien.jefferies@nagwa.com' },
                    { source_id: 907175717841, name: 'dan.brittain@nagwa.com' }, { source_id: 576123059865, name: 'darius.garewal@nagwa.com' },
                    { source_id: 127168617029, name: 'david.arnold@nagwa.com' }, { source_id: 818145323631, name: 'debasmita.ojha@nagwa.com' },
                    { source_id: 136138626589, name: 'debra.karhson@nagwa.com' }, { source_id: 762127275840, name: 'diaa.ashraf@nagwa.com' },
                    { source_id: 350120505319, name: 'digby.chappell@nagwa.com' }, { source_id: 348191246181, name: 'ed.burdette@nagwa.com' },
                    { source_id: 732174681402, name: 'eman.abdelhamid@nagwa.com' }, { source_id: 878162694042, name: 'eman.muhammad@nagwa.com' },
                    { source_id: 428175626765, name: 'eman.salah@nagwa.com' }, { source_id: 604185853180, name: 'emily.moseley@nagwa.com' },
                    { source_id: 535120818246, name: 'emily.taylor@nagwa.com' }, { source_id: 316138139028, name: 'enas.elmohammady@nagwa.com' },
                    { source_id: 259124985854, name: 'enas.elsobhy@nagwa.com' }, { source_id: 804149018179, name: 'fallon.simpson@nagwa.com' },
                    { source_id: 673102459730, name: 'fathia.sobhi@nagwa.com' }, { source_id: 636163252185, name: 'fatma.mahmoud@nagwa.com' },
                    { source_id: 897154523715, name: 'flavia.hodel@nagwa.com' }, { source_id: 214123842049, name: 'francesca.childs@nagwa.com' },
                    { source_id: 658191560261, name: 'gabriel.martin@nagwa.com' }, { source_id: 905156363236, name: 'gabrielle.malo@nagwa.com' },
                    { source_id: 703145379267, name: 'ehab.mahmud@nagwa.com' }, { source_id: 328158489094, name: 'ahmed.sayed@nagwa.com' },
                    { source_id: 808120576893, name: 'fatma.roshdy@nagwa.com' }, { source_id: 914130708535, name: 'geraldine.bourgeon@nagwa.com' },
                    { source_id: 309176585370, name: 'ghada.osam@nagwa.com' }, { source_id: 404123129714, name: 'ghadeer.mostafa@nagwa.com' },
                    { source_id: 819145047216, name: 'dina.ali@nagwa.com' }, { source_id: 894176946498, name: 'amira.elkholy@nagwa.com' },
                    { source_id: 175196786128, name: 'ahmed.sabra@nagwa.com' }, { source_id: 719130548578, name: 'fatema.samy@nagwa.com' },
                    { source_id: 318148214878, name: 'ahmed.salem@nagwa.com' }, { source_id: 937145789737, name: 'esraa.shahien@nagwa.com' },
                    { source_id: 746172148370, name: 'aya.shaaban@nagwa.com' }, { source_id: 965154318280, name: 'aya.eltwancy@nagwa.com' },
                    { source_id: 326106398487, name: 'eman.omar@nagwa.com' }, { source_id: 365138267632, name: 'ahmed.raafat@nagwa.com' },
                    { source_id: 708176801247, name: 'alaa.emary@nagwa.com' }, { source_id: 212194986282, name: 'ahmed.elbanna@nagwa.com' },
                    { source_id: 317150941798, name: 'amaal.abdelaziz@nagwa.com' }, { source_id: 803134190189, name: 'bedour.zahran@nagwa.com' },
                    { source_id: 643164068106, name: 'aya.abulmagd@nagwa.com' }, { source_id: 337614157860, name: 'ayat.tamim@nagwa.com' },
                    { source_id: 474164583535, name: 'abeer.fouad@nagwa.com' }, { source_id: 387162583986, name: 'ahmed.medra@nagwa.com' },
                    { source_id: 120171982460, name: 'ahmed.alhefny@nagwa.com' }, { source_id: 895127097864, name: 'gordonjoel.meyer@nagwa.com' },
                    { source_id: 793186820985, name: 'graham.ely@nagwa.com' }, { source_id: 802176327015, name: 'hadeer.abdelhay@nagwa.com' },
                    { source_id: 752104714650, name: 'hala.nasouh@nagwa.com' }, { source_id: 619137128302, name: 'hanan.iesa@nagwa.com' },
                    { source_id: 208127196157, name: 'harry.shuttleworth@nagwa.com' }, { source_id: 915143059179, name: 'hasnaa.aitbaha@nagwa.com' },
                    { source_id: 960171705257, name: 'heather.drewett@nagwa.com' }, { source_id: 564148628625, name: 'heather.jezorek@nagwa.com' },
                    { source_id: 142147919414, name: 'heba.elsherif@nagwa.com' }, { source_id: 989145183086, name: 'heba.sadek@nagwa.com' },
                    { source_id: 742173813751, name: 'hisham.reda@nagwa.com' }, { source_id: 216170252391, name: 'hoda.shawky@nagwa.com' },
                    { source_id: 839103931392, name: 'hossam.mohamed@nagwa.com' }, { source_id: 579152932527, name: 'hussein.magdy@nagwa.com' },
                    { source_id: 254108313537, name: 'ibrahim.anwar@nagwa.com' }, { source_id: 286182381245, name: 'ibrahim.elbagoury@nagwa.com' },
                    { source_id: 504130932870, name: 'islam.magdy@nagwa.com' }, { source_id: 607194519759, name: 'israa.kotb@nagwa.com' },
                    { source_id: 329186759405, name: 'jaillan.elrafey@nagwa.com' }, { source_id: 718130607823, name: 'james.gudge@nagwa.com' },
                    { source_id: 452143830658, name: 'joseph.mcnulty@nagwa.com' }, { source_id: 436156380571, name: 'joylyn.weikum@nagwa.com' },
                    { source_id: 505104272417, name: 'julie.haviland@nagwa.com' }, { source_id: 264146849363, name: 'juliet.perry@nagwa.com' },
                    { source_id: 959157375383, name: 'kathryn.kingham@nagwa.com' }, { source_id: 415156093421, name: 'kelly.fringer@nagwa.com' },
                    { source_id: 745102051694, name: 'kerolis.shehata@nagwa.com' }, { source_id: 865190945914, name: 'khadija.abdelfattah@nagwa.com' },
                    { source_id: 462158197608, name: 'kylee.long@nagwa.com' }, { source_id: 910165421706, name: 'lara.amusan@nagwa.com' },
                    { source_id: 918190346401, name: 'lauren.mcnaughten@nagwa.com' }, { source_id: 147146249089, name: 'levi.klankowski@nagwa.com' },
                    { source_id: 703150291949, name: 'lloyd.connellan@nagwa.com' }, { source_id: 832103128745, name: 'luke.hatfield@nagwa.com' },
                    { source_id: 495128347429, name: 'mae.saafan@nagwa.com' }, { source_id: 839134018180, name: 'maha.abdelmoneim@nagwa.com' },
                    { source_id: 427148783504, name: 'mahmoud.mohammed@nagwa.com' }, { source_id: 324187235816, name: 'mahmoud.salheen@nagwa.com' },
                    { source_id: 642163674058, name: 'mai.farouk@nagwa.com' }, { source_id: 498157574297, name: 'marcus.taylor@nagwa.com' },
                    { source_id: 169159894032, name: 'mariam.khaled@nagwa.com' }, { source_id: 347130890658, name: 'mariam.tarek@nagwa.com' },
                    { source_id: 243159695028, name: 'marwa.shehata@nagwa.com' }, { source_id: 952120140364, name: 'marwa.taha@nagwa.com' },
                    { source_id: 518141904047, name: 'michael.halim@nagwa.com' }, { source_id: 674125024324, name: 'miriam.carterfraser@nagwa.com' },
                    { source_id: 495103549506, name: 'mirna.yasser@nagwa.com' }, { source_id: 635160624265, name: 'mohamad.gamal@nagwa.com' },
                    { source_id: 392124142656, name: 'mohamed.abdelrhman@nagwa.com' }, { source_id: 510124020952, name: 'mohamed.amin@nagwa.com' },
                    { source_id: 654169891374, name: 'mohamed.darwish@nagwa.com' }, { source_id: 215151528545, name: 'mohamed.ezzeldin@nagwa.com' },
                    { source_id: 407152960816, name: 'mohamed.fathy@nagwa.com' }, { source_id: 127196204513, name: 'mohamed.fawzy@nagwa.com' },
                    { source_id: 249159575865, name: 'mohamed.ibrahim@nagwa.com' }, { source_id: 872185621013, name: 'mohamed.khalil@nagwa.com' },
                    { source_id: 865187829357, name: 'mohamed.magdy@nagwa.com' }, { source_id: 930168206797, name: 'gehad.mahmoud@nagwa.com' },
                    { source_id: 709186750268, name: 'gerges.yousef@nagwa.com' }, { source_id: 619153120948, name: 'lamis.saeed@nagwa.com' },
                    { source_id: 408143460578, name: 'marwa.hany@nagwa.com' }, { source_id: 280127867580, name: 'ismaiel.gamaleldin@nagwa.com' },
                    { source_id: 583191979837, name: 'maram.khater@nagwa.com' }, { source_id: 736103401087, name: 'moaaz.hagag@nagwa.com' },
                    { source_id: 627181736159, name: 'mohamed.elwakeel@nagwa.com' }, { source_id: 136154282452, name: 'israa.abdelkarim@nagwa.com' },
                    { source_id: 376109834614, name: 'hanady.gamal@nagwa.com' }, { source_id: 135103962931, name: 'mohamed.nabil@nagwa.com' },
                    { source_id: 757140165893, name: 'mohamed.talaat@nagwa.com' }, { source_id: 318178172082, name: 'mohammed.ramadan@nagwa.com' },
                    { source_id: 973134316315, name: 'mohammed.kamal@nagwa.com' }, { source_id: 918161628616, name: 'mohamed.elshaka@nagwa.com' },
                    { source_id: 546129780836, name: 'mariam.kotb@nagwa.com' }, { source_id: 967191273406, name: 'mahinour.tawfik@nagwa.com' },
                    { source_id: 168190608585, name: 'mohmmad.qenawy@nagwa.com' }, { source_id: 215104534508, name: 'morgan.taveras@nagwa.com' },
                    { source_id: 594158694782, name: 'mostafa.abdelsabour@nagwa.com' }, { source_id: 736198678340, name: 'mostafa.mahmoud@nagwa.com' },
                    { source_id: 464168263468, name: 'magdy.younis@nagwa.com' }, { source_id: 959153294685, name: 'mohamed.mahmoudy@nagwa.com' },
                    { source_id: 747185926028, name: 'mariam.yahia@nagwa.com' }, { source_id: 757101691847, name: 'marina.zaki@nagwa.com' },
                    { source_id: 698165698458, name: 'heba.eltarabishy@nagwa.com' }, { source_id: 676130390838, name: 'hussein.mahmoud@nagwa.com' },
                    { source_id: 517162017961, name: 'marwah.ahmad.helaly@nagwa.com' }, { source_id: 345171316462, name: 'ghada.elashry@nagwa.com' },
                    { source_id: 368142801213, name: 'mahmoud.aboelmagd@nagwa.com' }, { source_id: 127196862036, name: 'mohammad.hossein@nagwa.com' },
                    { source_id: 617126437323, name: 'mohamed.eid@nagwa.com' }, { source_id: 985124920590, name: 'mazen.gad@nagwa.com' },
                    { source_id: 952139328620, name: 'kareem.nashat@nagwa.com' }, { source_id: 475149294140, name: 'gehan.khaled@nagwa.com' },
                    { source_id: 945145262849, name: 'marie.maccaig@nagwa.com' }, { source_id: 849836164084, name: 'muhammad.farouk@nagwa.com' },
                    { source_id: 752198519039, name: 'hend.abdelmalek@nagwa.com' }, { source_id: 504190958067, name: 'heba.ghoneim@nagwa.com' },
                    { source_id: 284108073840, name: 'mai.sherif@nagwa.com' }, { source_id: 709169689048, name: 'muhammad.hashem@nagwa.com' },
                    { source_id: 352171762824, name: 'nada.amr@nagwa.com' }, { source_id: 309190625604, name: 'nada.hassaneen@nagwa.com' },
                    { source_id: 905125258656, name: 'nada.kamal@nagwa.com' }, { source_id: 768169353638, name: 'nadin.hassan@nagwa.com' },
                    { source_id: 708195163726, name: 'namrata.olimattel@nagwa.com' }, { source_id: 109120608408, name: 'nancy.lotfy@nagwa.com' },
                    { source_id: 873140659245, name: 'naomi.holland@nagwa.com' }, { source_id: 214153025202, name: 'neveen.abdelhakim@nagwa.com' },
                    { source_id: 832128021242, name: 'noha.mostafa@nagwa.com' }, { source_id: 796130127979, name: 'nohayr.ali@nagwa.com' },
                    { source_id: 862191709297, name: 'nourhan.gamil@nagwa.com' }, { source_id: 987190350914, name: 'nourhan.younis@nagwa.com' },
                    { source_id: 519179193151, name: 'oliver.rigg@nagwa.com' }, { source_id: 427135275809, name: 'omar.elshazly@nagwa.com' },
                    { source_id: 39054475743, name: 'omnia.hussein@nagwa.com' }, { source_id: 595147048923, name: 'omnia.ibrahim@nagwa.com' },
                    { source_id: 953192613695, name: 'osama.abdelmoez@nagwa.com' }, { source_id: 584154879674, name: 'pam.jones@nagwa.com' },
                    { source_id: 472186274352, name: 'parth.gharfalkar@nagwa.com' }, { source_id: 254107473215, name: 'paul.wrangles@nagwa.com' },
                    { source_id: 134160965931, name: 'philippa.crick@nagwa.com' }, { source_id: 716138671536, name: 'rachel.george@nagwa.com' },
                    { source_id: 175101587891, name: 'rachel.oosthuizen@nagwa.com' }, { source_id: 32127148021, name: 'radwa.ali@nagwa.com' },
                    { source_id: 309164035618, name: 'rahma.tarek@nagwa.com' }, { source_id: 504132724329, name: 'rana.ashraf@nagwa.com' },
                    { source_id: 503159060958, name: 'rania.fahmy@nagwa.com' }, { source_id: 743136248085, name: 'rania.wahdan@nagwa.com' },
                    { source_id: 462158042576, name: 'rasha.mohsen@nagwa.com' }, { source_id: 758137924974, name: 'rebecca.corden@nagwa.com' },
                    { source_id: 658169564058, name: 'rebecca.keller@nagwa.com' }, { source_id: 236140486914, name: 'reham.elkholy@nagwa.com' },
                    { source_id: 580178428347, name: 'rhodri.jones@nagwa.com' }, { source_id: 579197481213, name: 'riham.saleh@nagwa.com' },
                    { source_id: 745172160404, name: 'robert.ellmore@nagwa.com' }, { source_id: 328140493832, name: 'robert.russell@nagwa.com' },
                    { source_id: 192145305197, name: 'sahar.samir@nagwa.com' }, { source_id: 690121534014, name: 'sally.christmas@nagwa.com' },
                    { source_id: 280146452943, name: 'sarah.farouk@nagwa.com' }, { source_id: 752109649258, name: 'sarah.garry@nagwa.com' },
                    { source_id: 946185974395, name: 'sean.lauber@nagwa.com' }, { source_id: 594168692017, name: 'seungly.oh@nagwa.com' },
                    { source_id: 847120158758, name: 'shaimaa.malek@nagwa.com' }, { source_id: 472182053407, name: 'shannon.monks@nagwa.com' },
                    { source_id: 360169565672, name: 'shereen.osman@nagwa.com' }, { source_id: 563153963712, name: 'sherif.khalil@nagwa.com' },
                    { source_id: 526108432725, name: 'simeon.every@nagwa.com' }, { source_id: 424167960140, name: 'sneha.krishnamurthy@nagwa.com' },
                    { source_id: 724163101078, name: 'sohaila.mohsen@nagwa.com' }, { source_id: 929179241308, name: 'stephen.currie@nagwa.com' },
                    { source_id: 302175157840, name: 'tarek.monir@nagwa.com' }, { source_id: 907139471258, name: 'tim.burnham@nagwa.com' },
                    { source_id: 145129517432, name: 'timothy.sit@nagwa.com' }, { source_id: 837194975726, name: 'usamah.khalid@nagwa.com' },
                    { source_id: 947175758914, name: 'wageih.soliman@nagwa.com' }, { source_id: 234143262138, name: 'warda.mokhtar@nagwa.com' },
                    { source_id: 269150537947, name: 'william.hornbrook@nagwa.com' }, { source_id: 179124692670, name: 'yara.abdelaal@nagwa.com' },
                    { source_id: 963156357525, name: 'yasmeen.elaraby@nagwa.com' }, { source_id: 738163182548, name: 'yasser.selim@nagwa.com' },
                    { source_id: 342147278040, name: 'youssef.abdelmaksoud@nagwa.com' }, { source_id: 468105976487, name: 'enas.mahdy@nagwa.com' },
                    { source_id: 485136431282, name: 'ahmed.hindawi@nagwa.com' }, { source_id: 602123625931, name: 'noha.abdelrazik@nagwa.com' },
                    { source_id: 987456719712, name: 'mohamed.abdelalem@nagwa.com' }, { source_id: 568105165059, name: 'sara.abdelaziz@nagwa.com' },
                    { source_id: 828137430379, name: 'shorouk.khaled@nagwa.com' }, { source_id: 608151093040, name: 'hagar.ali@nagwa.com' },
                    { source_id: 673139040161, name: 'neveen.helmy@nagwa.com' }, { source_id: 792180794127, name: 'fatma.sultan@nagwa.com' },
                    { source_id: 264184518383, name: 'andrew.kitchin@nagwa.com' }, { source_id: 268152904956, name: 'mohammed.saad@nagwa.com' },
                    { source_id: 354135052858, name: 'kamal.mostafa@nagwa.com' }, { source_id: 510159583735, name: 'mahmoud.elneweshy@nagwa.com' },
                    { source_id: 867159606861, name: 'rehab.fawzy@nagwa.com' }, { source_id: 270160860196, name: 'shereen.fouad@nagwa.com' },
                    { source_id: 537148319827, name: 'dalia.kamal@nagwa.com' }, { source_id: 705107850630, name: 'eman.salem@nagwa.com' },
                    { source_id: 249173189630, name: 'mohamed.emadeldin@nagwa.com' }, { source_id: 876179218756, name: 'basma.sherif@nagwa.com' },
                    { source_id: 105126414395, name: 'monia.elwakeel@nagwa.com' }, { source_id: 590173795378, name: 'sammar.zakaria@nagwa.com' },
                    { source_id: 190183287598, name: 'soha.nasreldin@nagwa.com' }, { source_id: 698648148076, name: 'sarah.hassan@nagwa.com' },
                    { source_id: 894168289463, name: 'nagwa.reda@nagwa.com' }, { source_id: 209168454958, name: 'ramy.magdy@nagwa.com' },
                    { source_id: 723147417356, name: 'sara.ramadan@nagwa.com' }, { source_id: 894128580787, name: 'yomna.bayoumi@nagwa.com' },
                    { source_id: 634194140283, name: 'samah.abdelfattah@nagwa.com' }, { source_id: 272128153864, name: 'mahmoud.elzomor@nagwa.com' },
                    { source_id: 618146184254, name: 'yara.sobhy@nagwa.com' }, { source_id: 364164635329, name: 'nourhan.saied@nagwa.com' },
                    { source_id: 710158723939, name: 'noha.ezzat@nagwa.com' }, { source_id: 439168676721, name: 'rasha.basha@nagwa.com' },
                    { source_id: 476107574235, name: 'rabie.eldoha@nagwa.com' }, { source_id: 698106520137, name: 'salma.zaki@nagwa.com' },
                    { source_id: 978128962893, name: 'nihal.essmat@nagwa.com' }, { source_id: 154106968213, name: 'zeina.elsheikh@nagwa.com' },
                    { source_id: 310134129623, name: 'reda.jebril@nagwa.com' }, { source_id: 927169194769, name: 'salma.hafez@nagwa.com' },
                    { source_id: 872103252787, name: 'heba.adel@nagwa.com' }, { source_id: 873179621316, name: 'samaa.eltanawy@nagwa.com' },
                    { source_id: 916174061960, name: 'sara.soliman@nagwa.com' }, { source_id: 853106948071, name: 'mohamed.tarek@nagwa.com' },
                    { source_id: 123456789012, name: 'fatma.habib@nagwa.com' }, { source_id: 258147369789, name: 'enas.mohamed@nagwa.com' },
                    { source_id: 259159095185, name: 'toka.aly@nagwa.com' }, { source_id: 760130128289, name: 'abdelazim.beidas@nagwa.com' },
                    { source_id: 415151639694, name: 'shaker.hamdi@nagwa.com' }, { source_id: 784191574927, name: 'ayman.elsibaie@nagwa.com' },
                    { source_id: 302194323261, name: 'abdelmonem.mohamed@nagwa.com' }, { source_id: 760174692735, name: 'alaa.ahmed@nagwa.com' },
                    { source_id: 148108285685, name: 'attya.attya@nagwa.com' }, { source_id: 429107598090, name: 'amr.ramadan@nagwa.com' },
                    { source_id: 593109319363, name: 'lobna.ahmed@nagwa.com' }, { source_id: 718176767987, name: 'khadija.saad@nagwa.com' },
                    { source_id: 340171769083, name: 'ayman.farag@nagwa.com' }, { source_id: 492194298907, name: 'abdelrahman.elsadek@nagwa.com' },
                    { source_id: 380165418413, name: 'khadija.muhammad@nagwa.com' }, { source_id: 325167372908, name: 'mohamed.hegazy@nagwa.com' },
                    { source_id: 647178381548, name: 'heba.mahmoud@nagwa.com' }, { source_id: 809182160679, name: 'nelly.nasser@nagwa.com' },
                    { source_id: 258164501610, name: 'amany.fergany@nagwa.com' }, { source_id: 928106378980, name: 'ehab.elgawady@nagwa.com' },
                    { source_id: 286128939638, name: 'aya.abdelrahman@nagwa.com' }, { source_id: 723194238792, name: 'hanan.saad@nagwa.com' },
                    { source_id: 785102157610, name: 'antwan.rizk@nagwa.com' }, { source_id: 689120234340, name: 'nouthayla.magdy@nagwa.com' },
                    { source_id: 367124216873, name: 'hossam.hassan@nagwa.com' }, { source_id: 359193429068, name: 'mohamed.sayed@nagwa.com' },
                    { source_id: 486193781754, name: 'mariam.zaki@nagwa.com' }, { source_id: 963149619723, name: 'moataz.mohamed@nagwa.com' },
                    { source_id: 805183060731, name: 'wafaa.yehia@nagwa.com' }, { source_id: 202162942982, name: 'ahmed.abdelmoniem@nagwa.com' },
                    { source_id: 183147396259, name: 'huda.twfik@nagwa.com' }, { source_id: 784103283656, name: 'marina.toma@nagwa.com' },
                    { source_id: 865150974316, name: 'hussam.salah@nagwa.com' }, { source_id: 125143418905, name: 'mohamed.sallam@nagwa.com' },
                    { source_id: 146124021718, name: 'mohamed.hamdi@nagwa.com' }, { source_id: 315163104517, name: 'rody.samy@nagwa.com' },
                    { source_id: 432131578531, name: 'ameer.omar@nagwa.com' }, { source_id: 480168626860, name: 'dina.amin@nagwa.com' },
                    { source_id: 637108501093, name: 'nora.mostafa@nagwa.com' }, { source_id: 364142760518, name: 'salma.tarek@nagwa.com' },
                    { source_id: 656186570875, name: 'nada.salama@nagwa.com' }, { source_id: 863140923782, name: 'zeinab.adel@nagwa.com' },
                    { source_id: 934195097582, name: 'hagar.elbatal@nagwa.com' }, { source_id: 0, name: 'hoda.ayoub@nagwa.com' },
                    { source_id: 424174364659, name: 'hadeer.hussein@nagwa.com' }, { source_id: 714152985297, name: 'ahmad.saeed@nagwa.com' },
                    { source_id: 548127510737, name: 'zeinab.nabih@nagwa.com' }, { source_id: 587170578520, name: 'huda.tawfik@nagwa.com' },
                    { source_id: 637157279691, name: 'mazen.emad@nagwa.com' }, { source_id: 570104968128, name: 'dina.kamal@nagwa.com' },
                    { source_id: 315135204893, name: 'kerolouse.franciess@nagwa.com' }, { source_id: 803172646718, name: 'rasha.bekhit@nagwa.com' },
                    { source_id: 360197039043, name: 'sofana.albahi@nagwa.com' }, { source_id: 715125986801, name: 'badr.oraby@nagwa.com' },
                    { source_id: 590189895847, name: 'madonna.milad@nagwa.com' }, { source_id: 105108603275, name: 'khaled.saeed@nagwa.com' },
                    { source_id: 857103641397, name: 'ahmed.shaarawy@nagwa.com' }, { source_id: 389176391532, name: 'mahmoud.elashry@nagwa.com' },
                    { source_id: 315135204892, name: 'shimaa.mahmoud@nagwa.com' }, { source_id: 973103243124, name: 'rehab.medhat@nagwa.com' },
                    { source_id: 958165085253, name: 'aya.gaber@nagwa.com' }, { source_id: 964126973921, name: 'nadine.raafat@nagwa.com' },
                    { source_id: 734130434960, name: 'ahmed.hatem@nagwa.com' }, { source_id: 174181235606, name: 'zeyad.aql@nagwa.com' },
                    { source_id: 412472830111, name: 'kawthar.mohamed@nagwa.com' }, { source_id: 320170709096, name: 'essam.omar@nagwa.com' },
                    { source_id: 760154814164, name: 'heba.youssef@nagwa.com' }, { source_id: 935140803730, name: 'ahmed.morsi@nagwa.com' },
                    { source_id: 853152057854, name: 'esther.villegasdelatorre@nagwa.com' }, { source_id: 746191310389, name: 'cds.tscript.sub.rev.1@nagwa.com' },
                    { source_id: 905187850275, name: 'heba.yehia@nagwa.com' }, { source_id: 939167341860, name: 'reem.metwally@nagwa.com' },
                    { source_id: 652137698435, name: 'hagar.mohsen@nagwa.com' }, { source_id: 878159013086, name: 'ahmed.ramadan@nagwa.com' },
                    { source_id: 120187615309, name: 'mohamed.younnes@nagwa.com' }, { source_id: 267176825827, name: 'mohamed.araby@nagwa.com' },
                    { source_id: 415190915306, name: 'ibrahim.ali@nagwa.com' }, { source_id: 160181941723, name: 'ameera.mohamed@nagwa.com' },
                    { source_id: 570464765580, name: 'mohamed.genaidy@nagwa.com' }, { source_id: 294102508567, name: 'asmaa.ahmed@nagwa.com' },
                    { source_id: 130196195493, name: 'mahmoud.sayed@nagwa.com' }, { source_id: 954134694753, name: 'hosam.kassem@nagwa.com' },
                    { source_id: 218127341740, name: 'sayed.mohamed@nagwa.com' }, { source_id: 687101641397, name: 'rahma.ashraf@nagwa.com' },
                    { source_id: 840193238059, name: 'ghada.elewa@nagwa.com' }, { source_id: 819178319024, name: 'monica.sidhom@nagwa.com' },
                    { source_id: 769164617401, name: 'mohammed.elsayed.ramadan@nagwa.com' }, { source_id: 670136979720, name: 'moaz.saleh@nagwa.com' },
                    { source_id: 593148528191, name: 'mohamed.hosny@nagwa.com' }, { source_id: 794169383606, name: 'mostafa.abdelhalim@nagwa.com' },
                    { source_id: 769145326739, name: 'nourhan.alaaeldin@nagwa.com' }, { source_id: 927109361075, name: 'nader.atef@nagwa.com' },
                    { source_id: 732107039548, name: 'mohamed.elhamouly@nagwa.com' }, { source_id: 424182093137, name: 'mostafa.alaa@nagwa.com' },
                    { source_id: 605173125053, name: 'eslam.mohamed@nagwa.com' }, { source_id: 856196980834, name: 'asmaa.yousry@nagwa.com' },
                    { source_id: 936185082745, name: 'zeinab.zaki@nagwa.com' }, { source_id: 180120387643, name: 'emily.postles@nagwa.com' },
                    { source_id: 616193818038, name: 'soria.ibrahim@nagwa.com' }, { source_id: 123450987654, name: 'amira.mohamed@nagwa.com' },
                    { source_id: 186162343817, name: 'eman.sawabi@nagwa.com' }, { source_id: 436193847890, name: 'hanaa.fouad@nagwa.com' },
                    { source_id: 603178979628, name: 'noha.mousa@nagwa.com' }, { source_id: 934148451632, name: 'hanna.hodgson@nagwa.com' },
                    { source_id: 418123749852, name: 'rebecca.clifton@nagwa.com' }, { source_id: 814149845184, name: 'ahmed.alaa@nagwa.com' },
                    { source_id: 879158194074, name: 'nour.bahgat@nagwa.com' }, { source_id: 478179147017, name: 'kerolous.amged@nagwa.com' },
                    { source_id: 740102957170, name: 'mohamed.elsayed@nagwa.com' }, { source_id: 923137697053, name: 'salma.farag@nagwa.com' },
                    { source_id: 628147168986, name: 'mostafa.taha@nagwa.com' }, { source_id: 496137370693, name: 'dsfsdfd@nagwa.com' },
                    { source_id: 692132635438, name: 'stephanie.mauro@nagwa.com' }, { source_id: 349139419030, name: 'gabriela.hallas@nagwa.com' },
                    { source_id: 972186956519, name: 'abdallah.hassan@nagwa.com' }, { source_id: 125162830402, name: 'ahmed.yahya@nagwa.com' },
                    { source_id: 393154181873, name: 'shrouk.samir@nagwa.com' }, { source_id: 705185973512, name: 'salma.hatem@nagwa.com' },
                    { source_id: 216143404140, name: 'aliaa.adel@nagwa.com' }, { source_id: 254108051897, name: 'tarek.sleem@nagwa.com' },
                    { source_id: 424185975219, name: 'marwa.mohie@nagwa.com' }, { source_id: 232192545124, name: 'erin.wilson@nagwa.com' },
                    { source_id: 805189370751, name: 'hend.elhusseiny@nagwa.com' }, { source_id: 484168062929, name: 'kamel.sayed@nagwa.com' },
                    { source_id: 809124795010, name: 'mohamed.abdelfattah@nagwa.com' }, { source_id: 807134254237, name: 'mohamed.mourad@nagwa.com' },
                    { source_id: 840195406328, name: 'radwa.sabry@nagwa.com' }, { source_id: 740123086282, name: 'sss@nagwa.com' },
                    { source_id: 931108264346, name: 'maii.sameh@nagwa.com' }, { source_id: 295197069742, name: 'madonna.metry@nagwa.com' },
                    { source_id: 174160521690, name: 'aya.medhat@nagwa.com' }, { source_id: 147184646738, name: 'taher.abdelhady@nagwa.com' },
                    { source_id: 635167537939, name: 'ahmed.abdellatif@nagwa.com' }, { source_id: 185102681686, name: 'mohamed.emam@nagwa.com' },
                    { source_id: 307125819138, name: 'shady.khaled@nagwa.com' }, { source_id: 753132639563, name: 'sameh.sadek@nagwa.com' },
                    { source_id: 737106793085, name: 'omar.essam@nagwa.com' }, { source_id: 743179752514, name: 'heba.ghazaly@nagwa.com' },
                    { source_id: 427130104357, name: 'nourelhoda.abdelaziz@nagwa.com' }, { source_id: 367182925949, name: 'zeinab.elshenawy@nagwa.com' },
                    { source_id: 963163430437, name: 'shady.donia@nagwa.com' }, { source_id: 145172635718, name: 'yasmine.nasr@nagwa.com' },
                    { source_id: 185198317034, name: 'sara.mohamed@nagwa.com' }, { source_id: 215178624531, name: 'rana.hassan@nagwa.com' },
                    { source_id: 626137830726, name: 'nourhan.hassan@nagwa.com' }, { source_id: 413176194352, name: 'noha.elghoniemy@nagwa.com' },
                    { source_id: 864123085261, name: 'salma.ayman@nagwa.com' }, { source_id: 375135763692, name: 'mohamed.ismail@nagwa.com' },
                    { source_id: 235120752920, name: 'joumana.farag@nagwa.com' }, { source_id: 986197167612, name: 'karima.mahmoud@nagwa.com' },
                    { source_id: 147104760597, name: 'rana.antar@nagwa.com' }, { source_id: 168124952185, name: 'alice.herridge@nagwa.com' },
                    { source_id: 679180375094, name: 'abdallah.mohamed@nagwa.com' }, { source_id: 725162564962, name: 'nicolo.bazzi@nagwa.com' },
                    { source_id: 509142545710, name: 'hebtollah.mosa@nagwa.com' }, { source_id: 694164363692, name: 'samar.bahaaeldin@nagwa.com' },
                    { source_id: 617180919760, name: 'nourhan.hashad@nagwa.com' }, { source_id: 137105142619, name: 'esraa.saeed@nagwa.com' },
                    { source_id: 942130798452, name: 'aiat.saied@nagwa.com' }, { source_id: 404194328764, name: 'mohamed.hedeya@nagwa.com' },
                    { source_id: 172130285640, name: 'mohamed.hani@nagwa.com' }, { source_id: 630190153019, name: 'howaida.saber@nagwa.com' },
                    { source_id: 289150706195, name: 'yomna.gameel@nagwa.com' }, { source_id: 653101624283, name: 'taher.abdelhadyddddd@nagwa.com' },
                    { source_id: 749135848015, name: 'ingi.radwan@nagwa.com' }, { source_id: 896129153294, name: 'doha.fahmy@nagwa.com' },
                    { source_id: 174152535791, name: 'radwa.muhammad@nagwa.com' }, { source_id: 673167025619, name: 'haytham.mahmoud@nagwa.com' },
                    { source_id: 564143962161, name: 'nour.elborno@nagwa.com' }, { source_id: 534107915239, name: 'noha.mokhtar@nagwa.com' },
                    { source_id: 604169348956, name: 'menna.hamdy@nagwa.com' }, { source_id: 424192489189, name: 'hady.nabil@nagwa.com' },
                    { source_id: 473181014731, name: 'ramy.farouk@nagwa.com' }, { source_id: 834104670309, name: 'medhat.ali@nagwa.com' },
                    { source_id: 475136389247, name: 'mohamed.ahmed.kamal@nagwa.com' }, { source_id: 592153108121, name: 'cds.tscript.qa.1@nagwa.com' },
                    { source_id: 456157376139, name: 'maria.martinez@nagwa.com' }, { source_id: 906195414769, name: 'ahmed.hamad@nagwa.com' },
                    { source_id: 458131045164, name: 'cds.tscript.ce.1@nagwa.com' }, { source_id: 825167819068, name: 'benedicte.barrett@nagwa.com' },
                    { source_id: 346102987238, name: 'amany.talaat@nagwa.com' }, { source_id: 534193284374, name: 'sara.gamal@nagwa.com' },
                    { source_id: 725149525389, name: 'israa.ibrahim@nagwa.com' }, { source_id: 570106179431, name: 'sara.badwy@nagwa.com' },
                    { source_id: 906134617686, name: 'menna.ayman@nagwa.com' }, { source_id: 168174573895, name: 'malak.aliwy@nagwa.com' },
                    { source_id: 835193040729, name: 'cds.tscript.rev.1@nagwa.com' }, { source_id: 262184039598, name: 'taha.hassan@nagwa.com' },
                    { source_id: 583147318469, name: 'abeer.abdelaziz@nagwa.com' }, { source_id: 304105618950, name: 'faten.sayed@nagwa.com' },
                    { source_id: 182136230818, name: 'mariam.ghonaim@nagwa.com' }, { source_id: 865190148085, name: 'menna.elsanhoury@nagwa.com' },
                    { source_id: 925171517156, name: 'lobna.adel@nagwa.com' }, { source_id: 523153132509, name: 'haya.khaled@nagwa.com' },
                    { source_id: 562196032364, name: 'sherry.sawires@nagwa.com' }, { source_id: 862172412125, name: 'mayar.fathy@nagwa.com' },
                    { source_id: 183197425670, name: 'mirna.atef@nagwa.com' }, { source_id: 494153106570, name: 'ibrahim.eldahan@nagwa.com' },
                    { source_id: 826154029457, name: 'eman.hamdi@nagwa.com' }, { source_id: 312126191387, name: 'aya.ramadan@nagwa.com' },
                    { source_id: 786124121423, name: 'test_dahan@nagwa.com' }, { source_id: 969143627625, name: 'sameh.elsayed@nagwa.com' },
                    { source_id: 746121902861, name: 'walid.rahoma@nagwa.com' }, { source_id: 418125715718, name: 'abdualeem.hosny@nagwa.com' },
                    { source_id: 896170732925, name: 'test@nagwa.com' }, { source_id: 796184759657, name: 'ahmed.dawoud@nagwa.com' },
                    { source_id: 865190276198, name: 'hussein.mostafa@nagwa.com' }, { source_id: 762197039686, name: 'eriene.samir@nagwa.com' },
                    { source_id: 168196964239, name: 'georgette.rizk@nagwa.com' }, { source_id: 798157985869, name: 'ahmed.tolba@nagwa.com' },
                    { source_id: 480146765805, name: 'rehab.atia@nagwa.com' }, { source_id: 293106707912, name: 'kyrillos.khairy@nagwa.com' },
                    { source_id: 549158576383, name: 'mohamed.elgharabawi@nagwa.com' }, { source_id: 135147615340, name: 'zaynab.abdulsattar@nagwa.com' },
                    { source_id: 759178931095, name: 'bouthyna.tarek@nagwa.com' }, { source_id: 238173260548, name: 'cds.system@nagwa.com' },
                    { source_id: 147127372052, name: 'khaled.ghaly@nagwa.com' }, { source_id: 540185395059, name: 'mariam.elaasser@nagwa.com' },
                    { source_id: 243194710465, name: 'aliaa.fikry@nagwa.com' }
            ];
            
            constructor() {
                // --- 1. CONFIGURATION ---
                this.config = Object.freeze({
                    api: {
                        geminiEndpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=',
                        openaiEndpoint: 'https://api.openai.com/v1/chat/completions'
                    },
                    defaults: {
                        country: 'eg',
                        category: 'lesson',
                        dialect: 'Modern_standard',
                        sourceId: 182136230818,
                        lang: 'ar',
                        direction: 'vertical' // Default direction for OQ
                    },
                    flags: {
                        convertArabicLatex: false
                    },
                    ARABIC_LATEX_MAP: {
                        "F(x)": "\\dotlessqaft (\\seen)", "Q'": "\\dotlessnoont \\prime", 'N': '\\tah', 'Z': '\\sadt',
                        'Q': '\\dotlessnoont', 'X': '\\seent', 'Y': '\\sadt', 'x': '\\seen', 'y': '\\sad',
                        'z': '\\ain', 'A': '\\alt{\\alef}', 'B': '\\beh', 'C': '\\jeemi', 'D': '\\dal',
                        'E': '\\hehi', 'F': '\\waw', 'M': '\\meem', 'n': '\\noon', 'K': '\\kaf',
                        'L': '\\lam', 's': '\\feh', 'O': '\\waw', 'R': '\\haht', 'r': '\\aint',
                    }
                });
                // --- 2. ENUMS & CONSTANTS ---
                this.QuestionType = Object.freeze({
                    MCQ: "mcq", MRQ: "mrq", STRING: "string", OQ: "oq", GAP_TEXT: "gapText",
                    MATCHING: "matching", INPUT_BOX: "input_box", FRQ: "frq", FRQ_AI: "frq_ai", UNKNOWN: "unknown"
                });
                this.Language = Object.freeze({ ARABIC: "ar", ENGLISH: "en" });
                // --- 3. UTILITIES ---
                this.logger = {
                    info: (message) => console.log(`[INFO] ✨: ${message}`),
                    warn: (message) => console.warn(`[WARN] ⚠️: ${message}`),
                    error: (message, errorObj = '') => console.error(`[ERROR] ❌: ${message}`, errorObj)
                };
                // --- 4. STATE INITIALIZATION ---
                this.questions = [];
                this.isAIProcessing = false;
                this.jsonForExport = '';
                this.activeQuestionType = this.QuestionType.MCQ; // Default for simple text
                this.userExplicitlySelectedType = false;
                this.customization = { ...this.config.defaults };
                this.apiKeys = { gemini: '', openai: '' };
                this.aiProvider = 'gemini';
                this.csvData = [];
                this.hotInstance = null;
                this.aiTemplateHotInstance = null;
                this.language = this.config.defaults.lang;
                this.aiAbortController = null;
                this.validationTimeout = null;
                this.autoSaveTimeout = null;
                this.uploadedImageBase64 = null;
                this.subjectTemplateMap = {
                    "الأحياء": "352108393701",
                    "الرياضيات": "357135867402",
                    "العلوم": "352108393701",
                    "العلوم المتكاملة": "352108393701",
                    "الفيزياء": "352108393701",
                    "الكيمياء": "352108393701",
                    "اللغة العربية": "248170436092",
                    "اكتشف": "248170436092",
                    "التاريخ": "750162567617",
                    "الجغرافيا": "257121690289",
                    "الدراسات الاجتماعية": "738178680941",
                    "الفلسفة والمنطق": "186183541809",
                    "علم النفس والاجتماع": "457197047804",
                    "Biologie": "352108393701",
                    "Biology": "352108393701",
                    "Chemistry": "352108393701",
                    "Connect Plus": "892167914601",
                    "Discover": "352108393701",
                    "English": "328173624946",
                    "Integrated Science": "352108393701",
                    "Mathematics": "357135867402",
                    "Physics": "352108393701",
                    "Science": "352108393701",
                    "Sciences": "352108393701"
                };
                // --- 5. APP BOOTSTRAP ---
                this.loadSettings();
                this.loadApiKeys();
                // FIX: Initialize question type configs BEFORE loading content that depends on it.
                this.renderQuestionTypeButtons();
                this.loadAutoSavedContent();
                this.populateTagsModal();
                this.populateGenerationModal();
                this.setActiveQuestionType(this.activeQuestionType);
                this.updateInterfaceLanguage();
                this.bindEvents();
                this._updateApiProviderUI();
                this.populateSourceIdDropdown();
                this.logger.info("Application initialized successfully.");
            }
            // Safe HTML setter (global sanitizer)
            setSafeHTML(el, html) {
                const safe = DOMPurify.sanitize(html, {
                    ALLOW_DATA_ATTR: true,
                    ALLOW_CUSTOM_ELEMENTS: true,
                    // ADD 'u' to allowed tags for underline
                    ADD_TAGS: ['math-field','span','p','div','strong','ul', 'u', 'li', 'h4', 'h5', 'br', 'b'],
                    ADD_ATTR: ['value','locale','lang','class','dir','style','data-node-type','data-node-variation', 'title', 'aria-label', 'data-question-id', 'data-part-index', 'data-field-type', 'data-choice-index', 'data-math-index', 'default-mode', 'data-tag', 'data-interactive']
                });
                el.innerHTML = safe;
            }
            setLoading(isLoading, textAr = 'جاري التحليل...', textEn = 'Analyzing...') {
                const loading = document.getElementById('loading');
                const loadingText = document.getElementById('loading-text');
                loading.style.display = isLoading ? 'block' : 'none';
                loadingText.textContent = this.language === this.Language.ARABIC ? textAr : textEn;
            }
            bindEvents() {
                document.getElementById('smart-analyze-btn').addEventListener('click', () => this.smartAnalyze());
                document.getElementById('clean-format-btn').addEventListener('click', () => this.cleanAndFormat());
                document.getElementById('aiEnhanceBtn').addEventListener('click', () => this.enhanceWithAI());
                document.getElementById('convert-json-btn').addEventListener('click', () => this.convertToJSON());
                document.getElementById('clear-all-btn').addEventListener('click', () => this.clearAll());
                document.getElementById('langSwitchBtn').addEventListener('click', () => this.toggleLanguage());
                document.getElementById('copyBtn').addEventListener('click', () => this.copyJSON());
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadJSON());
                document.getElementById('downloadZipBtn').addEventListener('click', () => this.downloadZip());
                document.getElementById('csvBtn').addEventListener('click', () => this.openCSVModal());
                document.getElementById('csv-modal-close-btn').addEventListener('click', () => this.closeCSVModal());
                document.getElementById('csv-save-btn').addEventListener('click', () => this.saveCSVData());
                document.getElementById('csv-close-btn').addEventListener('click', () => this.closeCSVModal());
                
                // API Provider and Keys
                document.getElementById('aiProviderSelect').addEventListener('change', (e) => this.setAIProvider(e.target.value));
                document.getElementById('geminiApiKey').addEventListener('input', (e) => this.saveApiKeys('gemini', e.target.value));
                document.getElementById('openaiApiKey').addEventListener('input', (e) => this.saveApiKeys('openai', e.target.value));
                
                // Customize Modal Events
                document.getElementById('customizeBtn').addEventListener('click', () => this.openCustomizeModal());
                document.getElementById('customize-modal-close-btn').addEventListener('click', () => this.closeCustomizeModal());
                document.getElementById('customize-save-btn').addEventListener('click', () => this.saveCustomization());
                document.getElementById('aiTemplateBtn').addEventListener('click', () => this.openAiTemplateModal());
                document.getElementById('subjectTemplateBtn').addEventListener('click', () => this.openSubjectTemplateModal());
                
                // Tags Modal Events
                document.getElementById('tagsBtn').addEventListener('click', () => this.toggleTagsModal());
                document.getElementById('tags-modal-close-btn').addEventListener('click', () => this.toggleTagsModal(false));
                this.makeModalDraggable();

                // Generation Modal Events
                document.getElementById('generate-questions-btn').addEventListener('click', () => this.openGenerationModal());
                document.getElementById('modal-cancel-btn').addEventListener('click', () => this.closeGenerationModal());
                document.getElementById('modal-generate-btn').addEventListener('click', () => this.generateQuestionsWithAI());
                this.setupImageDropZone();

                // Auto-Save and Live Validation Event
                document.getElementById('questionInput').addEventListener('input', () => {
                    clearTimeout(this.autoSaveTimeout);
                    this.autoSaveTimeout = setTimeout(() => this.autoSaveContent(), 1000);
                    
                    clearTimeout(this.validationTimeout);
                    this.validationTimeout = setTimeout(() => this.runLiveValidation(), 500);
                });

                // AI Template ID Modal Events
                document.getElementById('ai-template-modal-close-btn').addEventListener('click', () => this.closeAiTemplateModal());
                document.getElementById('ai-template-save-btn').addEventListener('click', () => this.saveAiTemplateData());
                document.getElementById('ai-template-close-btn').addEventListener('click', () => this.closeAiTemplateModal());

                // Subject Template ID Modal Events
                document.getElementById('subject-template-modal-close-btn').addEventListener('click', () => this.closeSubjectTemplateModal());
                document.getElementById('subject-template-save-btn').addEventListener('click', () => this.saveSubjectTemplateData());
                document.getElementById('subject-template-close-btn').addEventListener('click', () => this.closeSubjectTemplateModal());
                document.getElementById('subjectSelect').addEventListener('change', () => this.updateSubjectQuestionsPreview());

                // Modal ESC close
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (document.getElementById('csvModalBg').style.display === 'flex') this.closeCSVModal();
                        if (document.getElementById('customizeModal').style.display === 'flex') this.closeCustomizeModal();
                        if (document.getElementById('aiTemplateModalBg').style.display === 'flex') this.closeAiTemplateModal();
                        if (document.getElementById('subjectTemplateModalBg').style.display === 'flex') this.closeSubjectTemplateModal();
                        if (document.getElementById('tagsModal').style.display === 'block') this.toggleTagsModal(false);
                        if (document.getElementById('generationModalBg').style.display === 'flex') this.closeGenerationModal();
                    }
                });
                document.getElementById('questionsPreview').addEventListener('click', (event) => {
                    const actionTarget = event.target.closest('.action-btn, .btn-save-edit, .btn-cancel-edit');
                    if (actionTarget) {
                        const questionPreview = actionTarget.closest('.question-preview');
                        if (!questionPreview) return;
                        const questionId = questionPreview.dataset.id;
                        if (actionTarget.classList.contains('delete-btn')) this.deleteQuestion(questionId);
                        else if (actionTarget.classList.contains('edit-btn')) this.startEditQuestion(questionId);
                        else if (actionTarget.classList.contains('btn-save-edit')) this.saveEditQuestion(questionId);
                        else if (actionTarget.classList.contains('btn-cancel-edit')) this.cancelEditQuestion(questionId);
                        return;
                    }

                    const choiceTarget = event.target.closest('.choice-item');
                    const partPreview = event.target.closest('.part-preview');
                    if (choiceTarget && partPreview && partPreview.dataset.interactive === 'true') {
                         this.handleChoiceClick(choiceTarget);
                    }
                });
                
                document.getElementById('questionsPreview').addEventListener('input', (e) => {
                    if (e.target.tagName.toLowerCase() === 'math-field') {
                        this.handleMathFieldInput(e);
                    }
                });
            }
            renderQuestionTypeButtons() {
                const container = document.getElementById('questionTypeSelector');
                if (!container) return;
                container.innerHTML = '';
                const configs = {
                    [this.QuestionType.MCQ]: { label: 'MCQ', jsonType: 'mcq' },
                    [this.QuestionType.MRQ]: { label: 'MRQ', jsonType: 'mrq' },
                    [this.QuestionType.MATCHING]: { label: 'Matching', jsonType: 'matching' },
                    [this.QuestionType.GAP_TEXT]: { label: 'Gapped Text', jsonType: 'gapText' },
                    [this.QuestionType.STRING]: { label: 'String', jsonType: 'string' },
                    [this.QuestionType.FRQ]: { label: 'Free Response', jsonType: 'frq' },
                    [this.QuestionType.OQ]: { label: 'Ordering (OQ)', jsonType: 'oq' },
                    [this.QuestionType.FRQ_AI]: { label: 'FRQ (AI)', jsonType: 'frq_ai' },
                    [this.QuestionType.INPUT_BOX]: { label: 'Input Box', jsonType: 'input_box' },
                    [this.QuestionType.UNKNOWN]: { label: 'Unknown', jsonType: 'unknown' } // FIX: Added Unknown type
                };
                this.questionTypeConfigs = configs;
                for (const typeKey in configs) {
                    const config = configs[typeKey];
                    if (typeKey === this.QuestionType.UNKNOWN) continue; // Don't create a button for it
                    const button = document.createElement('button');
                    button.className = 'q-type-btn';
                    button.textContent = config.label;
                    button.dataset.type = typeKey;
                    button.onclick = () => this.setActiveQuestionType(typeKey);
                    container.appendChild(button);
                }
            }
            setActiveQuestionType(typeKey) {
    // --- بداية الجزء الجديد: منطق إلغاء التفعيل ---
    // التحقق مما إذا كان المستخدم يضغط على الزر النشط حاليًا بالفعل
    if (this.activeQuestionType === typeKey && this.userExplicitlySelectedType) {
        
        // إذا كان الأمر كذلك، قم بإلغاء تنشيطه والعودة إلى وضع "الكشف التلقائي"
        this.userExplicitlySelectedType = false;
        
        // إعادة التعيين إلى النوع الافتراضي للاتساق
        this.activeQuestionType = this.QuestionType.MCQ; 

        // إزالة فئة 'active' من جميع الأزرار ليعكس التغيير بصريًا
        document.querySelectorAll('.q-type-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        return; // الخروج من الدالة لأن مهمتنا انتهت هنا
    }
    // --- نهاية الجزء الجديد ---

    // الجزء القديم: يعمل عندما يتم الضغط على زر جديد
    this.userExplicitlySelectedType = true;
    this.activeQuestionType = typeKey;

    // تحديث النمط المرئي لجميع الأزرار
    document.querySelectorAll('.q-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === typeKey);
    });
}
            // ***************************************************************
            // ** ID & VALIDATION LOGIC **
            // ***************************************************************
            extractDummyIds(content) {
                const dummyIds = [];
                const blocks = content.split(/\n---\n/).filter(block => block.trim());
                blocks.forEach(block => {
                    const lines = block.trim().split('\n');
                    for (const line of lines) {
                        const match = line.match(/^id:\s*(new\w+)/);
                        if (match) { dummyIds.push(match[1]); break; }
                    }
                });
                return [...new Set(dummyIds)];
            }
            async promptForOfficialIds(dummyIds) {
                return new Promise((resolve) => {
                    const modal = document.createElement('div');
                    modal.style.cssText = `position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); z-index: 9999; display: flex; align-items: center; justify-content: center;`;
                    const dialog = document.createElement('div');
                    dialog.style.cssText = `background: white; padding: 30px; border-radius: 15px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);`;
                    const isAr = this.language === this.Language.ARABIC;
                    dialog.innerHTML = `
                        <h3 style="margin-bottom: 20px; color: #4f46e5;">${isAr ? `تم العثور على ${dummyIds.length} معرف وهمي` : `Found ${dummyIds.length} dummy IDs`}</h3>
                        <p style="margin-bottom: 20px;">${isAr ? 'الرجاء إدخال المعرفات الرسمية (12 رقم لكل معرف):' : 'Please enter official IDs (12 digits each):'}</p>
                        <div id="idInputs" style="margin-bottom: 20px;"></div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="cancelIds" class="btn btn-secondary">${isAr ? 'إلغاء' : 'Cancel'}</button>
                            <button id="confirmIds" class="btn btn-primary">${isAr ? 'تأكيد' : 'Confirm'}</button>
                        </div>
                    `;
                    const inputsContainer = dialog.querySelector('#idInputs');
                    dummyIds.forEach((dummyId, index) => {
                        const inputDiv = document.createElement('div');
                        inputDiv.style.cssText = 'margin-bottom: 15px; display: flex; align-items: center; gap: 10px;';
                        inputDiv.innerHTML = `<label style="min-width: 100px; font-weight: bold;">${dummyId}:</label>
                            <input type="text" id="officialId_${index}" placeholder="123456789012" maxlength="12" style="flex: 1; padding: 8px; border: 2px solid #e5e7eb; border-radius: 6px;">`;
                        inputsContainer.appendChild(inputDiv);
                    });
                    modal.appendChild(dialog);
                    document.body.appendChild(modal);
                    const cleanup = () => document.body.removeChild(modal);
                    dialog.querySelector('#confirmIds').onclick = () => {
                        const mapping = {}; let valid = true; const usedIds = new Set();
                        dummyIds.forEach((dummyId, index) => {
                            const input = document.getElementById(`officialId_${index}`);
                            const value = input.value.trim();
                            if (!/^\d{12}$/.test(value)) { input.style.borderColor = '#ef4444'; valid = false; }
                            else if (usedIds.has(value)) { input.style.borderColor = '#f59e0b'; valid = false; this.showMessage(isAr ? 'معرفات مكررة!' : 'Duplicate IDs!', 'error'); }
                            else { input.style.borderColor = '#10b981'; mapping[dummyId] = value; usedIds.add(value); }
                        });
                        if (valid) { cleanup(); resolve(mapping); }
                    };
                    dialog.querySelector('#cancelIds').onclick = () => { cleanup(); resolve(null); };
                });
            }
            // ***************************************************************
            // ** PARSING & AI LOGIC **
            // ***************************************************************
            buildAdvancedFormattingPrompt(rawText, forcedType = null) {
                const isArabic = this.language === this.Language.ARABIC;
                
                const examples = `
مثال MCQ (نجمة واحدة فقط):
type: mcq
@STEM
ما عاصمة فرنسا؟
@CHOICES
- لندن
* باريس
- مدريد
---
مثال صواب أم خطأ:
type: mcq
@STEM
هل باريس عاصمة فرنسا؟ صواب أم خطأ؟
@CHOICES
* صواب
- خطأ
---
مثال MRQ (أكثر من نجمة):
type: mrq
@STEM
اختر كل اللغات البرمجية:
@CHOICES
* Python
- HTML
* JavaScript
---
مثال Matching:
type: matching
@STEM
صل الدول بعواصمها:
@MATCHING_PAIRS
فرنسا | باريس
ألمانيا | برلين
---
مثال GapText:
type: gapText
@STEM
الكوكب @BLANK هو الأكبر وله @BLANK قمراً.
@GAPS
المشتري
79
---
مثال معادلة معقدة:
type: string
@STEM
أوجد حل النظام التالي:
\`\`
\\begin{cases} x+y=5 \\\\ x-y=1 \\end{cases}
\`\`
@ANSWER
x=3, y=2
`;
                let typeInstruction = '1.  **حدد نوع** كل سؤال بناءً على محتواه.'; // دي الجملة الافتراضية
if (forcedType && forcedType !== 'unknown') {
    typeInstruction = `مهمتك هي تنسيق النص التالي **كنوع سؤال ${forcedType}** بشكل إلزامي. لا تحاول تخمين أو اكتشاف أي نوع آخر.`;
}
                
                const basePromptAr = `
أنت أداة دقيقة لتحويل النصوص إلى تنسيق محدد. مهمتك الوحيدة هي تحديد أجزاء النص (السؤال، الاختيارات، الإجابة.. إلخ) ووضع الوسوم (Tags) المناسبة حولها.

**مهم جدًا: لا تقم بتغيير، أو تصحيح، أو إضافة، أو حذف أي جزء من النص الأصلي إطلاقًا.** حافظ على الكلمات والمحتوى الأصلي تمامًا كما هو. وظيفتك هي فقط تطبيق هيكل التنسيق المطلوب.

**التعليمات الأساسية:**
${typeInstruction}

2.  **أخرج كل سؤال بالتنسيق التالي دون أي تغيير في المحتوى:**
    -   سطر بيانات وصفية في الأعلى، مثال: \`type: mcq\`
    -   وسم \`@STEM\` لنص السؤال الرئيسي.
    -   وسوم المحتوى حسب نوع السؤال (\`@CHOICES\`, \`@MATCHING_PAIRS\`, \`@GAPS\`, \`@ANSWER\`).
    -   استخدم \`---\` للفصل بين كل سؤال وآخر.

**قواعد أنواع الأسئلة (مهم):**
-   **MCQ/MRQ:** استخدم \`*\` قبل الإجابة الصحيحة و \`-\` قبل الخاطئة. **MCQ** يجب أن يحتوي على نجمة واحدة فقط، بينما **MRQ** يمكن أن يحتوي على نجمة واحدة أو أكثر.
-   **أسئلة الصواب والخطأ:** الأسئلة التي تحتوي على "صواب أم خطأ"، "خطأ أم صواب"، "true or false"، "false or true" يجب تنسيقها كـ MCQ مع وضع "صواب" أو "True" كأول اختيار.
-   **Matching:** يجب أن تكون الأزواج في \`@MATCHING_PAIRS\` مفصولة بـ \`|\`.
-   **GapText:** استخدم \`@BLANK\` في نص السؤال لكل فجوة، وضع الإجابات بالترتيب في \`@GAPS\`.
-   **Input Box:** يجب أن تكون الإجابة في \`@ANSWER\` بصيغة \`القيمة | الوحدة\` أو \`القيمة\` فقط إذا لم تكن هناك وحدة.

**قواعد الرياضيات (مهمة للغاية ويجب اتباعها بدقة):**
-   **لا تقم أبدًا بتعديل** محتوى أو صيغة أي كود LaTeX.
-   **حوّل المحددات السطرية (inline):** أي نص محاط بـ \`\$...\$\` أو \`\\(...\\)\` يجب لفه بـ \`...\` (backtick فردية).
-   **حوّل المحددات العرض (display):** أي نص محاط بـ \`\$\$...\$\$\` أو \`\\[...\\]\` يجب لفه بـ \`\`...\`\` (backticks مزدوجة).
-   **حوّل البيئات المعقدة:** أي كتلة LaTeX تبدأ بـ \`\\begin{...}\` وتنتهي بـ \`\\end{...}\` يجب أن تُعامل **دائمًا** كمعادلة عرض وتُلف بـ \`\`...\`\` (backticks مزدوجة).

لا تخترع أي محتوى. اتبع القواعد بدقة.


**نماذج:**
${examples}

**النص المطلوب تحويله:**
${rawText}

**الناتج المنسق:**
`;
                const basePromptEn = `
You are an expert question formatter and a meticulous academic assistant. Your task is to convert unstructured text into a standardized, structured format.

**Core Instructions:**
1.  **Detect** every question in the text.
2.  **Auto-detect** the type for each question from: mcq, mrq, oq, gapText, matching, string, frq, frq_ai, input_box.
3.  **Format each question as follows:**
    -   A metadata line at the top, e.g., \`type: mcq\`
    -   A \`@STEM\` tag for the main question text.
    -   Content tags based on the question type (\`@CHOICES\`, \`@MATCHING_PAIRS\`, \`@GAPS\`, \`@ANSWER\`).
    -   Use \`---\` to separate each question.

**Question Type Rules (Important):**
-   **MCQ/MRQ:** Use \`*\` before a correct answer and \`-\` before an incorrect one. **MCQ** must have exactly one star, while **MRQ** can have one or more.
-   **True/False Questions:** Questions containing "true or false", "false or true", "صواب أم خطأ", "خطأ أم صواب" should be formatted as MCQ with "True" or "صواب" as the first choice.
-   **Matching:** Pairs under \`@MATCHING_PAIRS\` must be separated by \`|\`.
-   **GapText:** Use \`@BLANK\` in the stem for each gap, and place the ordered answers under \`@GAPS\`.
-   **Input Box:** The answer under \`@ANSWER\` should be in the format \`value | unit\` or just \`value\` if there is no unit.

**Mathematics Rules (Crucial and must be followed precisely):**
-   **Never modify** the content or syntax of any LaTeX code.
-   **Convert inline delimiters:** Any text surrounded by \`\$...\$\` or \`\\(...\\)\` must be wrapped with \`...\` (single backticks).
-   **Convert display delimiters:** Any text surrounded by \`\$\$...\$\$\` or \`\\[...\\]\` must be wrapped with \`\`...\`\` (double backticks).
-   **Convert complex environments:** Any LaTeX block that starts with \`\\begin{...}\` and ends with \`\\end{...}\` must **always** be treated as display math and wrapped with \`\`...\`\` (double backticks).

Do not invent any content. Follow the rules precisely.

**Examples:**
${examples}

**Input Text to Convert:**
${rawText}

**Formatted Output:**
`;
                return isArabic ? basePromptAr : basePromptEn;
            }
            cleanFormattedText(t) {
                if (!t) return '';
                let s = t.trim();
                const fence = s.match(/```[a-zA-Z0-9]*\s*\n([\s\S]*?)\n```/);
                if (fence) s = fence[1].trim();
                s = s.replace(/^\s*(Here's the formatted text:|إليك النص المُنسق:|The formatted text is:)\s*/gmi, '');
                s = s.replace(/\n{3,}/g, '\n\n');
                return s.trim();
            }
            
            convertDollarMathToBackticks(text) {
                if (!text) return text;
                return text
                    .replace(/\$\$([\s\S]*?)\$\$/g, '``$1``')
                    .replace(/\$([^\$\n]+?)\$/g, '`$1`')
                    .replace(/```math\s*\n([\s\S]*?)\n```/g, '``$1``')
                    .replace(/\\\(([\s\S]*?)\\\)/g, '`$1`');
            }
            
            autoDetectTypeFromContent(block) {
                const hasChoices = /@CHOICES/i.test(block);
                const hasAnswer = /@ANSWER/i.test(block);
                const hasGaps = /@GAPS/i.test(block) || /@BLANK/i.test(block);
                const hasMatching = /@MATCHING_PAIRS/i.test(block) || /^\s*.+\s*\|\s*.+$/m.test(block);
                const starCount = (block.match(/^\s*\*/gm) || []).length;
                
                // Check for True/False questions
                const isTrueFalse = this.isTrueFalseQuestion(block);
                if (isTrueFalse) return this.QuestionType.MCQ;
                
                if (hasMatching) return this.QuestionType.MATCHING;
                if (hasGaps) return this.QuestionType.GAP_TEXT;
                if (hasChoices && starCount > 1) return this.QuestionType.MRQ;
                if (hasChoices && starCount === 1) return this.QuestionType.MCQ;
                if (hasChoices && starCount === 0) return this.QuestionType.OQ;
                if (hasAnswer) {
                    const ans = (block.match(/@ANSWER([\s\S]*)$/i) || [, ''])[1].trim();
                    if (/\|/.test(ans)) return this.QuestionType.INPUT_BOX;
                    return ans.split(/\s+/).length > 12 ? this.QuestionType.FRQ : this.QuestionType.STRING;
                }
                return this.QuestionType.STRING;
            }
            
            isTrueFalseQuestion(block) {
                const stem = (block.match(/@STEM([\s\S]*?)(?=@|$)/i) || [, ''])[1].trim();
                const trueFalsePatterns = [
                    /^.*صواب\s+أم\s+خطأ.*$/i,
                    /^.*خطأ\s+أم\s+صواب.*$/i,
                    /^.*true\s+or\s+false.*$/i,
                    /^.*false\s+or\s+true.*$/i,
                    /^.*صحيح\s+أم\s+خطأ.*$/i,
                    /^.*خطأ\s+أم\s+صحيح.*$/i
                ];
                return trueFalsePatterns.some(pattern => pattern.test(stem));
            }
            
    organizeTrueFalseChoices(choices, originalAnswers) {
    // FIX: Removed the '$' from the regex to allow for trailing punctuation like periods.
    const trueChoices = choices.filter(choice => /^(صواب|true|صحيح)/i.test(choice.trim()));
    const falseChoices = choices.filter(choice => /^(خطأ|false|غلط)/i.test(choice.trim()));
    
    // Always put True/صواب first, then False/خطأ
    return [...trueChoices, ...falseChoices];
}

            normalizeOneBlock(block) {
                // Ensure @STEM
                if (!/@STEM/i.test(block)) {
                    const lines = block.split('\n').filter(l => l.trim() !== '');
                    const first = lines.shift() || '';
                    block = `@STEM\n${first}\n` + (lines.length ? lines.join('\n') : '');
                }
                // Ensure type header
                if (!/^type:\s*/im.test(block)) {
                    const detected = this.autoDetectTypeFromContent(block);
                    block = `type: ${detected}\n` + block;
                }
                return block.trim();
            }

            postProcessAIFormatted(text) {
                let s = this.cleanFormattedText(text || '');
                s = this.convertDollarMathToBackticks(s);
                s = s.replace(/\n---\n(?:\n---\n)+/g, '\n---\n');
                let blocks = s.split(/\n---\n/).map(b => b.trim()).filter(Boolean);
                blocks = blocks.map(b => this.normalizeOneBlock(b));
                return blocks.join('\n---\n');
            }
            
            async smartAnalyze() {
                this.logger.info("Starting smart analysis...");
                const inputEl = document.getElementById('questionInput');
                const rawText = inputEl.value;
                if (!rawText.trim()) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء إدخال نص للتحليل' : 'Please enter text to analyze', 'warning');
                    return;
                }
                this.setLoading(true);
                try {
                    let textToParse = this.convertDollarMathToBackticks(rawText);
                    
                    const dummyIds = this.extractDummyIds(textToParse);
                    let idMapping = {};
                    if (dummyIds.length > 0) {
                        idMapping = await this.promptForOfficialIds(dummyIds);
                        if (!idMapping) {
                            this.showMessage(this.language === this.Language.ARABIC ? 'تم إلغاء العملية' : 'Operation cancelled', 'warning');
                            this.setLoading(false);
                            return;
                        }
                    }

                    const questionBlocks = textToParse.trim().split(/\n---\n/);

                    this.questions = questionBlocks.filter(block => block.trim()).map((block, index) => {
                        const q = this._parseQuestionBlock(block, index);
                        if (idMapping[q.metadata.id]) q.metadata.id = idMapping[q.metadata.id];
                        return q;
                    });

                    this.updateUIAfterChange(this.language === this.Language.ARABIC ? 'تم التحليل بنجاح.' : 'Analysis successful.');
                    this.logger.info(`Analysis complete. Found ${this.questions.length} questions.`);

                } catch (error) {
                    this.logger.error("Smart Analysis Error:", error);
                    this.showMessage(`${this.language === this.Language.ARABIC ? 'حدث خطأ أثناء التحليل: ' : 'Error during analysis: '}${error.message}`, 'error');
                } finally {
                    this.setLoading(false);
                }
            }
            _parseQuestionBlock(block, index) {
                const lines = block.trim().split('\n');
                const metadata = {};
                let contentStartIndex = 0;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const metaMatch = line.match(/^([a-z_]+):\s*(.*)/i);
                    if (metaMatch && !line.startsWith('[')) {
                        metadata[metaMatch[1].trim().toLowerCase()] = metaMatch[2].trim();
                    } else {
                        contentStartIndex = i;
                        break;
                    }
                }
                if (contentStartIndex === lines.length && Object.keys(metadata).length > 0) {
                    contentStartIndex = 0;
                    for (const key in metadata) { delete metadata[key]; }
                }
                const contentStr = lines.slice(contentStartIndex).join('\n').trim();
                const metaHeader = lines.slice(0, contentStartIndex).join('\n') + (contentStartIndex > 0 ? '\n' : '');
                metadata.id = metadata.id || `temp_${Date.now()}_${index}`;
                const questionData = {
                    metadata: metadata,
                    statement: null,
                    parts: [],
                    _metaHeader: metaHeader,
                    _contentBlock: contentStr,
                    _editing: false
                };
                if (/@STATEMENT/i.test(contentStr) && /@PART/i.test(contentStr)) {
                    const statementMatch = contentStr.match(/@STATEMENT([\s\S]*?)(?=@PART)/i);
                    if (statementMatch) { questionData.statement = statementMatch[1].trim(); }
                    const partRegex = /@PART([\s\S]*?)(?=@PART|$)/gi;
                    const partMatches = contentStr.match(partRegex);
                    if (partMatches) {
                        questionData.parts = partMatches.map(partMatch => {
                            const partContent = partMatch.replace(/^@PART/i, '').trim();
                            return this._parsePartWithTags(partContent, metadata);
                        });
                    }
                    return questionData;
                }
                const hasTags = /@(STEM|CHOICES|ANSWER|GAPS|MATCHING_PAIRS)/i.test(contentStr);
                if (hasTags) {
                    questionData.parts.push(this._parsePartWithTags(contentStr, metadata));
                    return questionData;
                }
                questionData.parts.push(this._parsePartSimple(contentStr, metadata));
                return questionData;
            }
            _parsePartWithTags(partBlock, globalMetadata) {
                const partMetadata = { ...globalMetadata };
                const content = {};
                const mainTags = ['STEM', 'CHOICES', 'ANSWER', 'GAPS', 'MATCHING_PAIRS'];
                let remainingBlock = partBlock.trim();
                const lines = remainingBlock.split('\n');
                let contentStartIndex = 0;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    const metaMatch = line.match(/^([a-z_]+):\s*(.*)/i);
                    if (metaMatch && !line.startsWith('[')) {
                        partMetadata[metaMatch[1].trim().toLowerCase()] = metaMatch[2].trim();
                        contentStartIndex = i + 1;
                    } else {
                        break;
                    }
                }
                remainingBlock = lines.slice(contentStartIndex).join('\n');
                const tagPositions = [];
                mainTags.forEach(tag => {
                    const regex = new RegExp(`@${tag}`, 'gi');
                    let match;
                    while ((match = regex.exec(remainingBlock)) != null) {
                        tagPositions.push({ tag: tag, index: match.index });
                    }
                });
                tagPositions.sort((a, b) => a.index - b.index);
                for (let i = 0; i < tagPositions.length; i++) {
                    const currentTag = tagPositions[i];
                    const nextTag = tagPositions[i + 1];
                    const start = currentTag.index + `@${currentTag.tag}`.length;
                    const end = nextTag ? nextTag.index : remainingBlock.length;
                    const tagContent = remainingBlock.substring(start, end).trim();
                    content[currentTag.tag] = tagContent;
                }
                const part = {
                    type: (partMetadata.type || globalMetadata.type || this.QuestionType.UNKNOWN),
                    stem: content.STEM || '',
                    metadata: partMetadata
                };
                this._processTaggedContent(part, content);
                return part;
            }
           _processTaggedContent(part, content) {
    const stripBullet = (s) => s.replace(/^\s*(?:\d+[.)]|[A-Za-z\u0621-\u064A][.)]|[-•])\s+/, '');
    switch(part.type) {
        case this.QuestionType.OQ:
        case this.QuestionType.MCQ:
        case this.QuestionType.MRQ: {
            const lines = (content.CHOICES || '').split('\n');
            part.choices = [];
            const answers = [];
            lines.forEach((rawLine) => {
                let line = rawLine.trim();
                if (!line) return;
                const isCorrect = line.startsWith('*');
                if (isCorrect || line.startsWith('-')) line = line.slice(1).trim();
                line = stripBullet(line);
                const idx = part.choices.length;
                part.choices.push(line);
                if (isCorrect) answers.push(idx);
            });
            
            if (this.isTrueFalseQuestion(`@STEM\n${part.stem}`)) {
                part.choices = this.organizeTrueFalseChoices(part.choices, answers);
                if (part.type !== this.QuestionType.OQ) {
                    const trueIndex = part.choices.findIndex(choice => 
                        /^(صواب|true|صحيح)/i.test(choice.trim()) // FIX 1a: Made regex flexible
                    );
                    const falseIndex = part.choices.findIndex(choice => 
                        /^(خطأ|false|غلط)/i.test(choice.trim()) // FIX 1b: Made regex flexible
                    );
                    
                    if (trueIndex !== -1 && falseIndex !== -1) {
                        const originalTrueAnswer = answers.find(idx => 
                            /^(صواب|true|صحيح)/i.test(lines[idx]?.replace(/^[*-]\s*/, '').trim()) // FIX 2: Made regex flexible
                        );
                        part.answer = part.type === this.QuestionType.MCQ ? 
                            (originalTrueAnswer !== undefined ? trueIndex : falseIndex) : 
                            [originalTrueAnswer !== undefined ? trueIndex : falseIndex];
                    }
                }
            } else {
                if (part.type !== this.QuestionType.OQ) {
                    part.answer = part.type === this.QuestionType.MCQ ? answers[0] : answers;
                }
            }
            break;
        }
        case this.QuestionType.MATCHING: {
            const pairs = (content.MATCHING_PAIRS || '').split('\n')
                .map(line => line.trim())
                .filter(Boolean)
                .map(line => line.split('|').map(item => item.trim()))
                .filter(arr => arr.length === 2 && arr[0] && arr[1]);
            part.pairs = pairs;
            part.group1 = pairs.map(p => p[0]);
            part.group2 = pairs.map(p => p[1]);
            part.answer = pairs.map((_, i) => [i, i]);
            break;
        }
        case this.QuestionType.GAP_TEXT: {
            part.answers = (content.GAPS || '').split('\n').map(v => v.trim()).filter(Boolean).map((val, i) => ({ value: val, order: i + 1 }));
            break;
        }
        case this.QuestionType.STRING:
        case this.QuestionType.FRQ:
        case this.QuestionType.FRQ_AI:
            part.answer = (content.ANSWER || '').trim();
            break;
        case this.QuestionType.INPUT_BOX: {
            const answerParts = (content.ANSWER || '|').split('|');
            part.answer = { value: (answerParts[0] || '').trim(), unit: (answerParts[1] || '').trim() };
            break;
        }
    }
}
      _parsePartSimple(text, metadata) {
    const stripBullet = (s) => s.replace(/^\s*(?:\d+[.)]|[A-Za-z\u0621-\u064A][.)]|[-•])\s+/, '');
    const type = (metadata.type || this.activeQuestionType).toLowerCase();
    let part = { type: type, confidence: 0.85, metadata: metadata };
    const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
    if (lines.length === 0) {
        part.stem = text;
        part.confidence = 0.1;
        part.choices = [];
        part.answer = '';
        part.answers = [];
        part.group1 = [];
        part.group2 = [];
        return part;
    }
    part.stem = lines[0].trim();
    const remainingLines = lines.slice(1);
    switch(type) {
        case this.QuestionType.OQ:
        case this.QuestionType.MCQ:
        case this.QuestionType.MRQ: {
            part.choices = [];
            const answers = [];
            remainingLines.forEach((line) => {
                let choiceText = line.trim();
                if (!choiceText) return;
                const isCorrect = choiceText.startsWith('*');
                if (isCorrect || choiceText.startsWith('-')) choiceText = choiceText.slice(1).trim();
                choiceText = stripBullet(choiceText);
                const idx = part.choices.length;
                part.choices.push(choiceText);
                if (isCorrect) answers.push(idx);
            });
            
            if (this.isTrueFalseQuestion(`@STEM\n${part.stem}`)) {
                part.choices = this.organizeTrueFalseChoices(part.choices, answers);
                const trueIndex = part.choices.findIndex(choice => 
                    /^(صواب|true|صحيح)/i.test(choice.trim()) // FIX 1a: Made regex flexible
                );
                const falseIndex = part.choices.findIndex(choice => 
                    /^(خطأ|false|غلط)/i.test(choice.trim()) // FIX 1b: Made regex flexible
                );
                
                if (trueIndex !== -1 && falseIndex !== -1) {
                    const originalTrueAnswer = answers.find(idx => 
                        /^(صواب|true|صحيح)/i.test(remainingLines[idx]?.replace(/^[*-]\s*/, '').trim()) // FIX 2: Made regex flexible
                    );
                    if (type === this.QuestionType.MCQ) {
                        part.answer = originalTrueAnswer !== undefined ? trueIndex : falseIndex;
                    } else if (type === this.QuestionType.MRQ) {
                        part.answer = [originalTrueAnswer !== undefined ? trueIndex : falseIndex];
                    }
                }
            } else {
                if (type === this.QuestionType.MCQ) part.answer = answers[0];
                else if (type === this.QuestionType.MRQ) part.answer = answers;
            }
            break;
        }
        case this.QuestionType.STRING:
        case this.QuestionType.FRQ:
        case this.QuestionType.FRQ_AI:
            part.answer = remainingLines.join('\n').trim();
            break;
        case this.QuestionType.GAP_TEXT: {
            part.answers = remainingLines.map((val, i) => ({ value: val, order: i + 1 }));
            break;
        }
        case this.QuestionType.INPUT_BOX: {
            const answerLine = remainingLines.join(' ').trim();
            const answerParts = answerLine.split('|');
            part.answer = { value: (answerParts[0] || '').trim(), unit: (answerParts[1] || '').trim() };
            break;
        }
        case this.QuestionType.MATCHING: {
            const pairs = remainingLines
                .map(line => line.split('|').map(item => item.trim()))
                .filter(arr => arr.length === 2 && arr[0] && arr[1]);
            part.pairs = pairs;
            part.group1 = pairs.map(p => p[0]);
            part.group2 = pairs.map(p => p[1]);
            part.answer = pairs.map((_, i) => [i, i]);
            break;
        }
    }
    return part;
}
            async enhanceWithAI() {
                const apiKey = this._getApiKey();
                if (!apiKey) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء إدخال مفتاح API أولاً' : 'Please enter an API key first', 'warning');
                    return;
                }
                const rawText = document.getElementById('questionInput').value.trim();
                if (!rawText) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء إدخال النص أولاً' : 'Please enter text first', 'warning');
                    return;
                }
                if (this.isAIProcessing) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'جاري المعالجة بالذكاء الاصطناعي...' : 'AI processing in progress...', 'warning');
                    return;
                }
                this.isAIProcessing = true;
                const enhanceBtn = document.getElementById('aiEnhanceBtn');
                const originalText = enhanceBtn.innerHTML;
                enhanceBtn.innerHTML = `<div class="spinner"></div> ${this.language === this.Language.ARABIC ? 'جاري التنسيق...' : 'Formatting...'}`;
                enhanceBtn.disabled = true;
                try {
                    let forcedType = null;
if (this.userExplicitlySelectedType) {
    forcedType = this.activeQuestionType;
}
const prompt = this.buildAdvancedFormattingPrompt(rawText, forcedType);
                    const aiText = await this._callAI(prompt, apiKey);
                    const finalFormatted = this.postProcessAIFormatted(aiText || rawText);
                    if (finalFormatted) {
                        document.getElementById('questionInput').value = finalFormatted;
                        this.showMessage(this.language === this.Language.ARABIC ? 'تم تنسيق النص بنجاح! يمكنك الآن تحليله.' : 'Text formatted successfully! You can now analyze it.', 'success');
                    } else {
                        this.showMessage(this.language === this.Language.ARABIC ? 'فشل في تنسيق النص. حاول مرة أخرى.' : 'Failed to format text. Please try again.', 'error');
                    }
                } catch (error) {
                    this.logger.error('AI Formatting Error:', error);
                    this.showMessage(`${this.language === this.Language.ARABIC ? 'خطأ في التنسيق: ' : 'Formatting error: '}${error.message}`, 'error');
                } finally {
                    this.isAIProcessing = false;
                    enhanceBtn.innerHTML = originalText;
                    enhanceBtn.disabled = false;
                }
            }
            // ***************************************************************
            // ** HTML & JSON TRANSFORMATION LOGIC **
            // ***************************************************************
            convertToJSON() {
                if (this.questions.length === 0) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'لا توجد أسئلة لتحويلها.' : 'No questions to convert.', 'warning');
                    return;
                }
                // Validation check for empty choices and required AI template IDs
                for (let i = 0; i < this.questions.length; i++) {
                    const q = this.questions[i];
                    for (let j = 0; j < q.parts.length; j++) {
                        const p = q.parts[j];
                        const needsChoices = [this.QuestionType.OQ, this.QuestionType.MCQ, this.QuestionType.MRQ].includes(p.type);
                        if (needsChoices && (!p.choices || p.choices.length === 0)) {
                            const errorMsg = `Question ${i + 1}, Part ${j + 1} (${p.type}) must have choices.`;
                            const errorMsgAr = `السؤال ${i + 1}, الجزء ${j + 1} (من نوع ${p.type}) يجب أن يحتوي على اختيارات.`;
                            this.showMessage(this.language === this.Language.ARABIC ? errorMsgAr : errorMsg, 'error');
                            return; // Stop the conversion
                        }
                        if (p.type === this.QuestionType.FRQ_AI && !p.metadata.ai_template_id) {
                             const errorMsg = `Question ${i + 1}, Part ${j + 1} (frq_ai) requires an AI Template ID.`;
                             const errorMsgAr = `السؤال ${i + 1}, الجزء ${j + 1} (من نوع frq_ai) يتطلب معرف قالب AI.`;
                             this.showMessage(this.language === this.Language.ARABIC ? errorMsgAr : errorMsg, 'error');
                             return;
                        }
                    }
                }

                const advancedFormatQuestions = this.questions.map((q, index) => this.transformToAdvancedFormat(q, index));
                const jsonOutput = document.getElementById('jsonOutput');
                this.jsonForExport = JSON.stringify(advancedFormatQuestions.length === 1 ? advancedFormatQuestions[0] : advancedFormatQuestions, null, 2);
                this.setSafeHTML(jsonOutput, this.syntaxHighlight(this.jsonForExport));
                jsonOutput.style.display = 'block';
                document.getElementById('copyBtn').disabled = false;
                document.getElementById('downloadBtn').disabled = this.questions.length > 1;
                document.getElementById('downloadZipBtn').disabled = this.questions.length === 0;
                document.getElementById('csvBtn').disabled = false;
                this.showMessage(this.language === this.Language.ARABIC ? 'تم تحويل الأسئلة إلى الصيغة المتقدمة بنجاح' : 'Successfully converted to advanced format', 'success');
            }
            transformToAdvancedFormat(question, index) {
                const meta = question.metadata;
                const csvRow = this.csvData[index];
                const lang = meta.language || this.customization.lang;

                const csvId = (csvRow && csvRow['Question Id']) ? parseInt(csvRow['Question Id'], 10) : NaN;
                
                const finalId = !isNaN(csvId) ? csvId : (parseInt(meta.id, 10) || (Date.now() + index));

                const finalMetadata = {
                    id: finalId,
                    ...(!isNaN(finalId) && { mapped_id: finalId }),
                    category: this.customization.category,
                    language: this.customization.lang,
                    country: this.customization.country,
                    dialect: this.language === this.Language.ARABIC ? ['Modern_standard'] : ["american", "british"],
                    source_id: { value: meta.source_id || this.customization.sourceId || this.config.defaults.sourceId, page_number: null },
                    description: (question.parts[0]?.stem || question.statement || '').substring(0, 150),
                    example_id: null,
                    has_example: false,
                    parts_count: question.parts.length,
                    instances_count: 1,
                    publication_date: new Date().toISOString(),
                    schema_version: "1.0.0"
                };

                return {
                    parts: question.parts.map((p, partIndex) => this._transformPart(p, meta, partIndex)),
                    statement: question.statement ? this.processTextForHtml(question.statement, lang) : null,
                    instance_number: 1,
                    metadata: finalMetadata
                };
            }
            _transformPart(part, globalMetadata, index) {
                const lang = globalMetadata.language || this.customization.lang;
                let processedStem = part.stem;
                
                if (processedStem && processedStem.includes('@BLANK')) {
                    const spaceSpan = '<span data-node-type="blank-line" data-node-variation="space">&nbsp;</span>';
                    processedStem = processedStem.replace(/@BLANK/g, spaceSpan);
                }

                const partJson = {
                    n: index + 1,
                    type: this.questionTypeConfigs[part.type]?.jsonType || part.type,
                    subtype: null,
                    standalone: false,
                    stem: this.processTextForHtml(processedStem, lang)
                };
                switch (part.type) {
                    case this.QuestionType.MCQ:
                    case this.QuestionType.MRQ:
                        Object.assign(partJson, this._transformMCQ_MRQ_Part(part, lang));
                        break;
                    case this.QuestionType.OQ:
                        Object.assign(partJson, this._transformOQPart(part, lang));
                        break;
                    case this.QuestionType.MATCHING:
                        Object.assign(partJson, this._transformMatchingPart(part, lang));
                        break;
                    case this.QuestionType.GAP_TEXT:
                        Object.assign(partJson, this._transformGapTextPart(part, lang));
                        break;
                    case this.QuestionType.STRING:
                        Object.assign(partJson, this._transformStringPart(part, globalMetadata, lang));
                        break;
                    case this.QuestionType.FRQ:
                        Object.assign(partJson, this._transformFRQPart(part, lang));
                        break;
                    case this.QuestionType.FRQ_AI:
                        Object.assign(partJson, this._transformFRQ_AIPart(part, globalMetadata, lang));
                        break;
                    case this.QuestionType.INPUT_BOX:
                        Object.assign(partJson, this._transformInputBoxPart(part));
                        break;
                    default:
                        partJson.choices = [];
                }
                return partJson;
            }
            _transformMCQ_MRQ_Part(part, lang) {
                const correctAnswers = new Set(Array.isArray(part.answer) ? part.answer : [part.answer]);
                return {
                    choices: (part.choices || []).map((choice, i) => ({
                        type: correctAnswers.has(i) ? 'key' : 'distractor',
                        html_content: this.processTextForHtml(choice, lang),
                        values: [],
                        unit: null,
                        index: i,
                        fixed_order: i + 1,
                        last_order: false
                    }))
                };
            }
            _transformOQPart(part, lang) {
                const itemsToShuffle = (part.choices || []).map((choice, i) => ({
                    text: choice,
                    originalIndex: i
                }));

                const shuffledItems = this._shuffleArray(itemsToShuffle);

                return {
                    direction: this.customization.direction, // Use the customized direction
                    choices: shuffledItems.map((item, i) => ({
                        type: 'distractor',
                        html_content: this.processTextForHtml(item.text, lang),
                        correct_order: item.originalIndex + 1,
                        values: [],
                        unit: null,
                        index: i,
                        fixed_order: i + 1,
                        last_order: false
                    }))
                };
            }
            _transformMatchingPart(part, lang) {
                const choices = [];
                const group1Items = (part.group1 || []);
                const group1Length = group1Items.length;

                group1Items.forEach((item, i) => {
                    choices.push({ 
                        type: 'distractor', 
                        html_content: this.processTextForHtml(item, lang),
                        group: 1, 
                        correct_order: i + 1, 
                        values: [], 
                        unit: null, 
                        index: i, 
                        fixed_order: i + 1, 
                        last_order: false 
                    });
                });

                const group2ItemsToShuffle = (part.group2 || []).map((item, i) => ({
                    text: item,
                    originalIndex: i
                }));
                
                const shuffledGroup2Items = this._shuffleArray(group2ItemsToShuffle);
                
                shuffledGroup2Items.forEach((item, i) => {
                    choices.push({ 
                        type: 'distractor', 
                        html_content: this.processTextForHtml(item.text, lang),
                        group: 2, 
                        correct_order: item.originalIndex + 1,
                        values: [], 
                        unit: null, 
                        index: i + group1Length, 
                        fixed_order: i + 1 + group1Length, 
                        last_order: false 
                    });
                });

                return { choices };
            }
            _transformGapTextPart(part, lang) {
                const stem_html_gap = '<span data-node-type="blank-line" data-node-variation="gap"> </span>';
                const processedStem = (part.stem || '').replace(/@BLANK|_{3,}/g, stem_html_gap);
                return {
                    gap_text_keys: (part.answers || []).map(ans => ({ value: ans.value, correct_order: ans.order })),
                    stem: this.processTextForHtml(processedStem, lang),
                    choices: []
                };
            }
            _transformStringPart(part, globalMetadata, lang) {
                const result = {
                    choices: null,
                    answer: [part.answer]
                };
                const aiTemplateId = part.metadata.ai_template_id || globalMetadata.ai_template_id;
                if (aiTemplateId) {
                    result.ai = { "ai_template_id": Number(aiTemplateId) };
                }
                return result;
            }
            _transformFRQPart(part, lang) {
                return { choices: [], answer: this.processTextForHtml(part.answer, lang) };
            }
            _transformFRQ_AIPart(part, globalMetadata, lang) {
                const result = {
                    choices: [],
                    answer: this.processTextForHtml(part.answer, lang)
                };
                const aiTemplateId = part.metadata.ai_template_id || globalMetadata.ai_template_id;
                if (aiTemplateId) {
                    result.ai = { "ai_template_id": Number(aiTemplateId) };
                }
                return result;
            }
            _transformInputBoxPart(part) {
                const answer = {
                    value: part.answer.value,
                    constrains: { type: "integer" }
                };
                // Only add the unit key if it's a non-empty string.
                if (part.answer.unit) {
                    answer.unit = part.answer.unit;
                }
                return { choices: [], answer };
            }
            // ***************************************************************
            // ** UI, ACTIONS & UTILITIES **
            // ***************************************************************
            
            _shuffleArray(array) {
                let currentIndex = array.length, randomIndex;
                while (currentIndex > 0) {
                    randomIndex = Math.floor(Math.random() * currentIndex);
                    currentIndex--;
                    [array[currentIndex], array[randomIndex]] = [
                        array[randomIndex], array[currentIndex]];
                }
                return array;
            }
            
            clearAll() {
                document.getElementById('questionInput').value = '';
                this.questions = []; this.jsonForExport = ''; this.csvData = [];
                localStorage.removeItem('aiq_autosave_content');
                localStorage.removeItem('aiq_csv_data');
                localStorage.removeItem('aiq_ai_template_ids');
                this.updateUIAfterChange();
                const jsonOutput = document.getElementById('jsonOutput');
                jsonOutput.style.display = 'none'; jsonOutput.innerHTML = '';
                document.getElementById('copyBtn').disabled = true;
                document.getElementById('downloadBtn').disabled = true;
                document.getElementById('downloadZipBtn').disabled = true;
                document.getElementById('csvBtn').disabled = true;
                this.showMessage(this.language === this.Language.ARABIC ? 'تم مسح كل شيء' : 'Everything cleared', 'success');
                this.logger.info("All data has been cleared.");
            }
            
            processTextForHtml(text, language, questionId, partIndex, fieldType, choiceIndex = -1) {
                if (!text) return '';
                const direction = language === this.Language.ARABIC ? ' dir="rtl"' : '';
                
                // FIX: Changed from 5 or more underscores to 4 or more, per user request.
                let processedText = text.replace(/_{4,}/g, '<span data-node-type="blank-line" data-node-variation="space">&nbsp;</span>');

                const parts = processedText.split(/(``[\s\S]*?``|`[\s\S]*?`|<span data-node-type="blank-line" data-node-variation="gap"> <\/span>|<span data-node-type="blank-line" data-node-variation="space">&nbsp;<\/span>)/);
                let finalHtmlContent = "";
                
                let mathFieldIndex = 0;
                for (const part of parts) {
                    if (!part) continue;
                    if (part.startsWith('``') && part.endsWith('``')) {
                        finalHtmlContent += this.createMathField(part.slice(2, -2), language, true, questionId, partIndex, fieldType, choiceIndex, mathFieldIndex++);
                    } else if (part.startsWith('`') && part.endsWith('`')) {
                        finalHtmlContent += this.createMathField(part.slice(1, -1), language, false, questionId, partIndex, fieldType, choiceIndex, mathFieldIndex++);
                    } else if (part.includes('data-node-type="blank-line"')) {
                        finalHtmlContent += part;
                    } else {
                        let textPart = part;
                        // NEW: Handle underline tag [U]...[/U] before sanitizing
                        textPart = textPart.replace(/\[U\]([\s\S]+?)\[\/U\]/g, '<u>$1</u>');
                        finalHtmlContent += `<span style="white-space: pre-wrap;">${DOMPurify.sanitize(textPart)}</span>`;
                    }
                }
                return `<p class="LexicalTheme__paragraph" style="text-align: justify;" ${direction}>${finalHtmlContent}</p>`;
            }
            
            createMathField(equation, language, forceEn = false, questionId, partIndex, fieldType, choiceIndex, mathFieldIndex) {
                const isArabic = language === this.Language.ARABIC && !forceEn;
                let latexValue = equation.replace(/@BLANK/g, '\\textBlank');
                if (isArabic && this.config.flags.convertArabicLatex) {
                    latexValue = this.convertToArabicLatex(latexValue);
                }
                const localeAttrs = isArabic ? ' locale="ar" lang="ar"' : ' locale="en"';
                const processedValue = latexValue.replace(/"/g, '&quot;');

                const dataAttrs = `data-question-id="${questionId}" 
                                     data-part-index="${partIndex}" 
                                     data-field-type="${fieldType}" 
                                     data-choice-index="${choiceIndex}"
                                     data-math-index="${mathFieldIndex}"`;
                
                return `<span class="LexicalTheme__math--inline" data-node-type="math" data-node-variation="inline"><math-field ${dataAttrs} default-mode="inline-math" value="${processedValue}"${localeAttrs}></math-field></span>`;
            }

            handleMathFieldInput(event) {
                const mathField = event.target;
                const questionId = mathField.dataset.questionId;
                const partIndex = parseInt(mathField.dataset.partIndex, 10);
                const fieldType = mathField.dataset.fieldType;
                const choiceIndex = parseInt(mathField.dataset.choiceIndex, 10);
                const mathFieldIndex = parseInt(mathField.dataset.mathIndex, 10);
                const newLatexValue = mathField.value;

                const question = this.questions.find(q => q.metadata.id === questionId);
                if (!question) return;

                let partToUpdate;
                if (partIndex === -1) { 
                    partToUpdate = question;
                } else {
                    partToUpdate = question.parts[partIndex];
                }
                
                if (!partToUpdate) return;
                
                const updateRawText = (originalText) => {
                    if (isNaN(mathFieldIndex) || !originalText) return originalText;

                    const regex = /(``[\s\S]*?``|`[\s\S]*?`)/g;
                    let currentMathIndex = 0;
                    
                    const newText = originalText.replace(regex, (match) => {
                        if (currentMathIndex === mathFieldIndex) {
                            currentMathIndex++;
                            const delimiter = match.startsWith('``') ? '``' : '`';
                            return `${delimiter}${newLatexValue}${delimiter}`;
                        }
                        currentMathIndex++;
                        return match;
                    });
                    
                    return newText;
                };

                switch (fieldType) {
                    case 'statement':
                        partToUpdate.statement = updateRawText(partToUpdate.statement);
                        break;
                    case 'stem':
                        partToUpdate.stem = updateRawText(partToUpdate.stem);
                        break;
                    case 'choice':
                        if (choiceIndex > -1 && Array.isArray(partToUpdate.choices) && partToUpdate.choices[choiceIndex]) {
                           partToUpdate.choices[choiceIndex] = updateRawText(partToUpdate.choices[choiceIndex]);
                        }
                        break;
                    case 'answer':
                          partToUpdate.answer = updateRawText(partToUpdate.answer);
                          break;
                }
                
                this._regenerateQuestionContent(question);
                this.updateTextareaFromQuestions();
                if (document.getElementById('jsonOutput').style.display === 'block') {
                    this.convertToJSON();
                }
                
                this.logger.info(`Updated math field for Q:${questionId}, Part:${partIndex}, Type:${fieldType}`);
            }

            convertToArabicLatex(equation) {
                const commands = equation.match(/\\\w+/g) || [];
                commands.forEach((command, i) => { equation = equation.replace(command, `__CMD_PLACEHOLDER_${i}__`); });
                const parts = equation.split(' ');
                const processedParts = parts.map(part => this.config.ARABIC_LATEX_MAP[part] || part);
                equation = processedParts.join(' ');
                commands.forEach((command, i) => { equation = equation.replace(`__CMD_PLACEHOLDER_${i}__`, command); });
                return equation;
            }
            displayResults() {
                const previewContainer = document.getElementById('questionsPreview');
                previewContainer.innerHTML = '';
                const placeholder = document.getElementById('preview-placeholder');
                if (this.questions.length === 0) {
                    if (!placeholder) {
                        const newPlaceholder = document.createElement('div');
                        newPlaceholder.id = 'preview-placeholder';
                        newPlaceholder.style.cssText = "text-align: center; color: #6b7280; padding: 40px; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;";
                        previewContainer.appendChild(newPlaceholder);
                    }
                    const visiblePlaceholder = document.getElementById('preview-placeholder');
                    visiblePlaceholder.style.display = 'flex';
                    const msg = this.language === this.Language.ARABIC ? 'ستظهر معاينة الأسئلة هنا بعد التحليل' : 'Questions preview will appear here after analysis';
                    this.setSafeHTML(visiblePlaceholder, `<div style="font-size: 3em; margin-bottom: 20px;">📋</div><p>${msg}</p>`);
                    return;
                }
                if (placeholder) placeholder.style.display = 'none';
                this.questions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-preview';
                    questionDiv.dataset.id = q.metadata.id;
                    const html = q._editing ? this._renderEditView(q) : this._renderReadOnlyView(q, index);
                    this.setSafeHTML(questionDiv, html);
                    previewContainer.appendChild(questionDiv);
                });
            }
            
            _renderReadOnlyView(q, index) {
                const lang = q.metadata.language || this.customization.lang || 'ar';
                const csvRow = this.csvData[index];
                const questionIdText = (csvRow && csvRow['Question Id']) ? csvRow['Question Id'] : q.metadata.id;
                let html = `<div class="question-actions">
                    <button class="action-btn edit-btn" title="${this.language === this.Language.ARABIC ? 'تعديل' : 'Edit'}" aria-label="Edit">✏️</button>
                    <button class="action-btn delete-btn" title="${this.language === this.Language.ARABIC ? 'حذف' : 'Delete'}" aria-label="Delete">🗑️</button>
                </div>`;

                if(q.validationWarning) {
                    html += `<div class="validation-warning" title="${q.validationWarning}">⚠️</div>`;
                }

                if (q.statement) {
                    html += `<div class="statement-preview">${this.processTextForHtml(q.statement, lang, q.metadata.id, -1, 'statement')}</div>`;
                }
                q.parts.forEach((p, pIndex) => {
                    const isInteractive = p.type === this.QuestionType.MCQ || p.type === this.QuestionType.MRQ;
                    html += `<div class="part-preview" data-interactive="${isInteractive}" data-part-index="${pIndex}">`;
                    html += `<div class="question-type-badge type-${p.type}">${this.questionTypeConfigs[p.type]?.label || p.type} | ID: ${questionIdText}</div>`;
                    html += `<div>${this.processTextForHtml(p.stem, lang, q.metadata.id, pIndex, 'stem')}</div>`;
                    
                    if (p.type === 'oq' || p.type === 'mcq' || p.type === 'mrq') {
                        const correctAnswers = new Set(Array.isArray(p.answer) ? p.answer : [p.answer]);
                        html += (p.choices || []).map((choice, cIndex) =>
                            `<div class="choice-item ${correctAnswers.has(cIndex) ? 'correct' : ''}" data-question-id="${q.metadata.id}" data-choice-index="${cIndex}">${this.processTextForHtml(choice, lang, q.metadata.id, pIndex, 'choice', cIndex)}</div>`
                        ).join('');
                    } else if (p.type === 'matching') {
                        let g1Html = (p.group1 || []).map((item, i) => `<div class="matching-item">${i+1}. ${this.processTextForHtml(item, lang, q.metadata.id, pIndex, 'group1', i)}</div>`).join('');
                        let g2Html = (p.group2 || []).map((item, i) => `<div class="matching-item">${String.fromCharCode(65 + i)}. ${this.processTextForHtml(item, lang, q.metadata.id, pIndex, 'group2', i)}</div>`).join('');
                        html += `<div class="matching-preview"><div class="matching-column"><strong>${this.language === this.Language.ARABIC ? 'القائمة أ' : 'List A'}</strong>${g1Html}</div><div class="matching-column"><strong>${this.language === this.Language.ARABIC ? 'القائمة ب' : 'List B'}</strong>${g2Html}</div></div>`;
                    } else if (p.type === 'string' || p.type === 'frq' || p.type === 'frq_ai') {
                        html += `<div class="choice-item correct"><strong>${this.language === this.Language.ARABIC ? 'الإجابة:' : 'Answer:'}</strong> ${this.processTextForHtml(p.answer, lang, q.metadata.id, pIndex, 'answer')}</div>`;
                    } else if (p.type === 'gapText') {
                        html += `<div class="gapped-text-answers"><strong>${this.language === this.Language.ARABIC ? 'الإجابات بالترتيب:' : 'Answers in order:'}</strong><ul>${(p.answers || []).map((ans, aIndex) => (ans && ans.value) ? `<li>${this.processTextForHtml(ans.value, lang, q.metadata.id, pIndex, 'gap', aIndex)}</li>` : '').join('')}</ul></div>`;
                    } else if (p.type === 'input_box') {
                        if (p.answer && typeof p.answer.value !== 'undefined') {
                            html += `<div class="choice-item correct"><strong>${this.language === this.Language.ARABIC ? 'الإجابة:' : 'Answer:'}</strong> ${p.answer.value} ${p.answer.unit || ''}</div>`;
                        }
                    }
                    html += `</div>`;
                });
                return html;
            }
            
            _renderEditView(q) {
                const contentToEdit = q._contentBlock || '';
                let html = `<textarea class="edit-textarea" id="edit-q-text-${q.metadata.id}">${contentToEdit}</textarea>`;
                html += `<div style="margin-top:10px;display:flex;gap:10px;">
                    <button class="btn btn-success btn-save-edit">💾 ${this.language === this.Language.ARABIC ? 'حفظ' : 'Save'}</button>
                    <button class="btn btn-secondary btn-cancel-edit">❌ ${this.language === this.Language.ARABIC ? 'إلغاء' : 'Cancel'}</button>
                </div>`;
                return html;
            }
            startEditQuestion(id) {
                const qIndex = this.questions.findIndex(q => q.metadata.id === id);
                if (qIndex > -1) { this.questions[qIndex]._editing = true; this.displayResults(); }
            }
            saveEditQuestion(id) {
                const qIndex = this.questions.findIndex(q => q.metadata.id === id);
                if (qIndex > -1) {
                    const originalQuestion = this.questions[qIndex];
                    const newContent = document.getElementById(`edit-q-text-${id}`).value;
                    const newFullBlock = (originalQuestion._metaHeader || '') + newContent;
                    const newQuestionObject = this._parseQuestionBlock(newFullBlock, qIndex);
                    this.questions[qIndex] = newQuestionObject;
                    this.updateUIAfterChange(this.language === this.Language.ARABIC ? 'تم حفظ التعديلات.' : 'Changes saved.');
                }
            }
            cancelEditQuestion(id) {
                const q = this.questions.find(q => q.metadata.id === id);
                if (q) { q._editing = false; this.displayResults(); }
            }
            deleteQuestion(id) {
                const qIndex = this.questions.findIndex(q => q.metadata.id === id);
                if (qIndex > -1) {
                    this.questions.splice(qIndex, 1);
                    this.updateUIAfterChange(this.language === this.Language.ARABIC ? 'تم حذف السؤال.' : 'Question deleted.');
                }
            }
            updateUIAfterChange(message) {
                this.runLiveValidation();
                this.updateStatistics();
                this.displayResults();
                const jsonOutput = document.getElementById('jsonOutput');
                if (jsonOutput.style.display === 'block') { this.convertToJSON(); }
                document.getElementById('downloadZipBtn').disabled = this.questions.length === 0;
                if (message) { this.showMessage(message, 'success'); }
            }
            updateStatistics() {
                const total = this.questions.length;
                let totalConfidence = 0;
                this.questions.forEach(q => { totalConfidence += (q.metadata.confidence || 0.85); });
                document.getElementById('totalQuestions').textContent = total;
                const avgConfidence = total > 0 ? (totalConfidence / total) : 0;
                const confidencePercent = Math.round(avgConfidence * 100);
                document.getElementById('confidenceScore').textContent = `${confidencePercent}%`;
                document.getElementById('detectionQuality').style.width = `${confidencePercent}%`;
                document.getElementById('classificationAccuracy').style.width = `${Math.round(avgConfidence * 95)}%`;
                document.getElementById('dataCompleteness').style.width = `${Math.round(avgConfidence * 90)}%`;
            }
            showMessage(text, type = 'success') {
                const container = document.getElementById('messageContainer');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                this.setSafeHTML(messageDiv, `<span class="close-x" aria-label="Close">×</span>${text}`);
                messageDiv.querySelector('.close-x').onclick = () => messageDiv.remove();
                container.appendChild(messageDiv);
                setTimeout(() => { messageDiv.remove(); }, 4000);
            }
            async copyJSON() {
                if (!this.jsonForExport) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'لا يوجد شيء لنسخه' : 'Nothing to copy', 'warning');
                    return;
                }
                try {
                    await navigator.clipboard.writeText(this.jsonForExport);
                    this.showMessage(this.language === this.Language.ARABIC ? 'تم نسخ JSON إلى الحافظة' : 'JSON copied to clipboard', 'success');
                } catch (err) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'فشل النسخ' : 'Copy failed', 'error');
                }
            }
            downloadJSON() {
                if (!this.jsonForExport || this.questions.length > 1) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'يمكن تحميل سؤال واحد فقط بصيغة JSON. استخدم ZIP للتحميل المجمع.' : 'Only one question can be downloaded as JSON. Use ZIP for bulk download.', 'warning');
                    return;
                }
                const filename = `${this.questions[0].metadata.id}.json`;
                const blob = new Blob([this.jsonForExport], { type: 'application/json' });
                this.downloadBlob(blob, filename);
                this.showMessage(this.language === this.Language.ARABIC ? 'بدء تحميل الملف...' : 'Download starting...', 'success');
            }
            async downloadZip() {
                if (this.questions.length === 0) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'لا يوجد أسئلة لتحميلها' : 'No questions to download', 'warning');
                    return;
                }
                const randomName = `QuestionsExport_${Date.now()}_${Math.floor(Math.random() * 10000)}`;
                const jsonsZip = new JSZip();
                this.questions.forEach((q, idx) => {
                    const singleQuestionObject = this.transformToAdvancedFormat(q, idx);
                    const filename = `${singleQuestionObject.metadata.id}.json`;
                    const content = JSON.stringify(singleQuestionObject, null, 2);
                    jsonsZip.file(filename, content);
                });
                const jsonsZipBlob = await jsonsZip.generateAsync({ type: 'blob' });
                const mainZip = new JSZip();
                mainZip.file('JSONS.zip', jsonsZipBlob);
                mainZip.file('question_set_summary.csv', this.generateCSVContent());
                const blob = await mainZip.generateAsync({ type: 'blob' });
                this.downloadBlob(blob, `${randomName}.zip`);
                this.showMessage(this.language === this.Language.ARABIC ? `تم تحميل ${randomName}.zip بنجاح` : `${randomName}.zip downloaded successfully`, 'success');
            }
            downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(url);
            }
            toggleLanguage() {
                this.language = this.language === this.Language.ARABIC ? this.Language.ENGLISH : this.Language.ARABIC;
                this.updateInterfaceLanguage();
                this.saveSettings();
            }
            updateInterfaceLanguage() {
                const isAr = this.language === this.Language.ARABIC;
                document.documentElement.lang = isAr ? 'ar' : 'en';
                document.documentElement.dir = isAr ? 'rtl' : 'ltr';
                const translations = {
                    mainTitle: { ar: '🚀 معالج الأسئلة', en: '🚀 Advanced Smart Question Converter' },
                    mainSubtitle: { ar: 'حوّل نصوص الأسئلة إلى صيغة JSON متقدمة بضغطة زر', en: 'Convert question texts to advanced JSON format with one click' },
                    panelTitle1: { ar: '<span style="font-size: 1.5em; line-height: 1;">①</span> اختر نوع السؤال (للنص البسيط)', en: '<span style="font-size: 1.5em; line-height: 1;">①</span> Select Type (for Simple Text)' },
                    panelTitle2: { ar: '<span style="font-size: 1.5em; line-height: 1;">②</span> أدخل النص', en: '<span style="font-size: 1.5em; line-height: 1;">②</span> Enter Text' },
                    panelTitle3: { ar: '🔍 تحليل ومخرجات', en: '🔍 Analysis & Output' },
                    panelTitle4: { ar: '👁️ معاينة الأسئلة', en: '👁️ Questions Preview' },
                    generateBtn: { ar: '🚀 توليد أسئلة', en: '🚀 Generate Questions' },
                    analyzeBtn: { ar: '🤖 تحليل ذكي', en: '🤖 Smart Analyze' },
                    cleanBtn: { ar: '✨ تنظيف وتنسيق', en: '✨ Clean & Format' },
                    enhanceBtn: { ar: '💎 تحسين بالـ AI', en: '💎 Enhance with AI' },
                    convertBtn: { ar: '🔄 تحويل لـ JSON', en: '🔄 Convert to JSON' },
                    customizeBtn: { ar: '⚙️ تخصيص', en: '⚙️ Customize' },
                    tagsBtn: { ar: '🏷️ Tags', en: '🏷️ Tags' },
                    clearBtn: { ar: '🗑️ مسح الكل', en: '🗑️ Clear All' },
                    langBtn: { ar: '🌐 English', en: '🌐 العربية' },
                    copyBtn: { ar: '📋 نسخ JSON', en: '📋 Copy JSON' },
                    downloadBtn: { ar: '💾 تحميل', en: '💾 Download' },
                    downloadZipBtn: { ar: '🗜️ تحميل كـ ZIP', en: '🗜️ Download as ZIP' },
                    csvBtn: { ar: '📄 CSV', en: '📄 CSV' },
                    subjectTemplateBtn: { ar: '📚 Subject Template ID', en: '📚 Subject Template ID' },
                };
                
                document.getElementById('main-title').innerHTML = translations.mainTitle[this.language];
                document.getElementById('main-subtitle').innerHTML = translations.mainSubtitle[this.language];
                document.getElementById('panel-title-1').innerHTML = translations.panelTitle1[this.language];
                document.getElementById('panel-title-2').innerHTML = translations.panelTitle2[this.language];
                document.getElementById('panel-title-3').innerHTML = translations.panelTitle3[this.language];
                document.getElementById('panel-title-4').innerHTML = translations.panelTitle4[this.language];
                document.getElementById('generate-questions-btn').innerHTML = translations.generateBtn[this.language];
                document.getElementById('smart-analyze-btn').innerHTML = translations.analyzeBtn[this.language];
                document.getElementById('clean-format-btn').innerHTML = translations.cleanBtn[this.language];
                document.getElementById('aiEnhanceBtn').innerHTML = translations.enhanceBtn[this.language];
                document.getElementById('convert-json-btn').innerHTML = translations.convertBtn[this.language];
                document.getElementById('customizeBtn').innerHTML = translations.customizeBtn[this.language];
                document.getElementById('tagsBtn').innerHTML = translations.tagsBtn[this.language];
                document.getElementById('clear-all-btn').innerHTML = translations.clearBtn[this.language];
                document.getElementById('langSwitchBtn').innerHTML = translations.langBtn[this.language];
                document.getElementById('copyBtn').innerHTML = translations.copyBtn[this.language];
                document.getElementById('downloadBtn').innerHTML = translations.downloadBtn[this.language];
                document.getElementById('downloadZipBtn').innerHTML = translations.downloadZipBtn[this.language];
                document.getElementById('csvBtn').innerHTML = translations.csvBtn[this.language];
                document.getElementById('subjectTemplateBtn').innerHTML = translations.subjectTemplateBtn[this.language];
                this.displayResults();
            }
            openCustomizeModal() {
                const modal = document.getElementById('customizeModal');
                modal.style.display = 'flex';
                document.getElementById('categorySelect').value = this.customization.category;
                document.getElementById('langSelect').value = this.customization.lang;
                document.getElementById('countrySelect').value = this.customization.country;
                document.getElementById('dialectSelect').value = this.customization.dialect;
                document.getElementById('directionSelect').value = this.customization.direction;
                
                // Populate the source ID dropdown and set the value if available
                this.populateSourceIdDropdown();
                
                setTimeout(() => { modal.querySelector('#categorySelect')?.focus(); }, 0);
            }
            closeCustomizeModal() { document.getElementById('customizeModal').style.display = 'none'; }
            saveCustomization() {
                this.customization.category = document.getElementById('categorySelect').value;
                this.customization.lang = document.getElementById('langSelect').value;
                this.customization.country = document.getElementById('countrySelect').value;
                this.customization.dialect = document.getElementById('dialectSelect').value;
                this.customization.direction = document.getElementById('directionSelect').value;
                this.customization.sourceId = document.getElementById('sourceIdSelect').value;
                this.saveSettings(); this.closeCustomizeModal();
                this.showMessage(this.language === this.Language.ARABIC ? 'تم حفظ الإعدادات' : 'Settings saved', 'success');
                if (document.getElementById('jsonOutput').style.display === 'block') this.convertToJSON();
            }
            saveSettings() {
                localStorage.setItem('aiq_settings', JSON.stringify({ language: this.language, customization: this.customization }));
            }
            loadSettings() {
                try {
                    const settings = JSON.parse(localStorage.getItem('aiq_settings'));
                    if (settings) {
                        if (settings.language) this.language = settings.language;
                        if (settings.customization) this.customization = { ...this.config.defaults, ...settings.customization };
                    }
                } catch {}
            }
            
            populateSourceIdDropdown() {
                const select = document.getElementById('sourceIdSelect');
                if (!select) return;
                
                // Clear existing content and event listeners
                select.innerHTML = '';

                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = this.config.defaults.sourceId;
                defaultOption.textContent = "Default (mariam.ghonaim)";
                select.appendChild(defaultOption);

                // Add all options from the sourceIdData array
                this.sourceIdData.forEach(item => {
                    if (item.source_id !== this.config.defaults.sourceId.toString()) { // Avoid duplicating the default
                        const option = document.createElement('option');
                        option.value = item.source_id;
                        option.textContent = item.name;
                        select.appendChild(option);
                    }
                });

                // Set the saved value if available
                select.value = this.customization.sourceId || this.config.defaults.sourceId;
                
                // Add event listener directly to the select element
                select.addEventListener('change', (e) => {
                    this.customization.sourceId = e.target.value;
                    this.saveSettings();
                    if (document.getElementById('jsonOutput').style.display === 'block') {
                        this.convertToJSON();
                    }
                });
            }
            saveApiKeys(provider, value) {
                this.apiKeys[provider] = value.trim();
                localStorage.setItem('aiq_api_keys', JSON.stringify(this.apiKeys));
            }
            loadApiKeys() {
                try {
                    const keys = JSON.parse(localStorage.getItem('aiq_api_keys'));
                    if (keys) {
                        this.apiKeys = keys;
                        document.getElementById('geminiApiKey').value = this.apiKeys.gemini || '';
                        document.getElementById('openaiApiKey').value = this.apiKeys.openai || '';
                    }
                } catch {}
            }
            openCSVModal() {
                if (typeof Handsontable === 'undefined') { this.showMessage('Error: Table library not loaded.', 'error'); return; }
                if (this.questions.length === 0) { this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء تحليل الأسئلة أولاً.' : 'Please analyze questions first.', 'warning'); return; }
                const columns = [
                    { data: 'Question Id', type: 'text' },
                    { data: 'Lang', type: 'text', readOnly: true },
                    { data: 'Lesson Id', type: 'text' },
                    { data: 'Attributes', type: 'text', readOnly: true },
                    { data: 'Category', type: 'text', readOnly: true },
                    { data: 'Dialect', type: 'text', readOnly: true }
                ];
                const saved = localStorage.getItem('aiq_csv_data');
                let savedData = null;
                try {
                    savedData = JSON.parse(saved);
                    if (!Array.isArray(savedData) || savedData.length !== this.questions.length) savedData = null;
                } catch (e) { savedData = null; }
                if (savedData) {
                    this.csvData = savedData;
                } else {
                    this.csvData = this.questions.map((q) => ({
                        'Question Id': q.metadata.id,
                        'Lang': q.metadata.language || this.customization.lang,
                        'Lesson Id': '',
                        'Attributes': q.parts.map(p => this.questionTypeConfigs[p.type]?.jsonType || p.type).join(';'),
                        'Category': q.metadata.category || this.customization.category,
                        'Dialect': this.language === this.Language.ARABIC ? 'Modern_standard' : 'american, british'
                    }));
                }
                document.getElementById('csvModalBg').style.display = 'flex';
                if (this.hotInstance) this.hotInstance.destroy();
                this.hotInstance = new Handsontable(document.getElementById('hotTable'), {
                    data: this.csvData,
                    colHeaders: ['Question Id', 'Lang', 'Lesson Id', 'Attributes', 'Category', 'Dialect'],
                    columns: columns, rowHeaders: true, width: '100%', height: 500,
                    licenseKey: 'non-commercial-and-evaluation', manualColumnResize: true, stretchH: 'all'
                });
            }
            closeCSVModal() {
                document.getElementById('csvModalBg').style.display = 'none';
                if (this.hotInstance) { this.hotInstance.destroy(); this.hotInstance = null; }
            }
            saveCSVData() {
                if (this.hotInstance) {
                    const tableData = this.hotInstance.getData();
                    this.csvData = tableData.map(row => ({
                        'Question Id': row[0], 
                        'Lang': row[1], 
                        'Lesson Id': row[2], 
                        'Attributes': row[3], 
                        'Category': row[4], 
                        'Dialect': row[5]
                    }));
                    localStorage.setItem('aiq_csv_data', JSON.stringify(this.csvData));
                    this.showMessage(this.language === this.Language.ARABIC ? 'تم حفظ بيانات CSV' : 'CSV data saved successfully', 'success');
                    this.closeCSVModal();
                    this.displayResults();
                }
            }
            openAiTemplateModal() {
                if (typeof Handsontable === 'undefined') { this.showMessage('Error: Table library not loaded.', 'error'); return; }
                if (this.questions.length === 0) { this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء تحليل الأسئلة أولاً.' : 'Please analyze questions first.', 'warning'); return; }
                
                const columns = [
                    { data: 'Question Id', type: 'text', readOnly: true },
                    { data: 'AI Template ID', type: 'text' }
                ];
                
                const data = this.questions.map(q => ({
                    'Question Id': q.metadata.id,
                    'AI Template ID': q.metadata.ai_template_id || ''
                }));

                document.getElementById('aiTemplateModalBg').style.display = 'flex';
                if (this.aiTemplateHotInstance) this.aiTemplateHotInstance.destroy();
                
                this.aiTemplateHotInstance = new Handsontable(document.getElementById('hotAiTemplateTable'), {
                    data: data,
                    colHeaders: ['Question ID', 'AI Template ID'],
                    columns: columns,
                    rowHeaders: true,
                    width: '100%',
                    height: 500,
                    licenseKey: 'non-commercial-and-evaluation',
                    manualColumnResize: true,
                    stretchH: 'all'
                });
            }
            closeAiTemplateModal() {
                document.getElementById('aiTemplateModalBg').style.display = 'none';
                if (this.aiTemplateHotInstance) {
                    this.aiTemplateHotInstance.destroy();
                    this.aiTemplateHotInstance = null;
                }
            }
            saveAiTemplateData() {
                if (this.aiTemplateHotInstance) {
                    const tableData = this.aiTemplateHotInstance.getData();
                    tableData.forEach((row) => {
                        const originalId = row[0];
                        const aiTemplateId = row[1];
                        const question = this.questions.find(q => q.metadata.id === originalId);
                        if (question) {
                            question.metadata.ai_template_id = aiTemplateId || null;
                            question.parts.forEach(p => {
                                p.metadata.ai_template_id = aiTemplateId || null;
                            });
                        }
                    });
                    this.showMessage(this.language === this.Language.ARABIC ? 'تم حفظ معرفات قوالب AI بنجاح' : 'AI Template IDs saved successfully', 'success');
                    this.closeAiTemplateModal();
                    if (document.getElementById('jsonOutput').style.display === 'block') {
                        this.convertToJSON();
                    }
                }
            }
            _formatCsvCell(value) {
                if (value === null || value === undefined) {
                    return '';
                }
                let stringValue = String(value);
                if (/[",\n]/.test(stringValue)) {
                    stringValue = stringValue.replace(/"/g, '""');
                    return `"${stringValue}"`;
                }
                return stringValue;
            }
            generateCSVContent() {
                const header = ['Question Id', 'Lang', 'Lesson Id', 'Attributes', 'Category', 'Dialect'];
                if (this.csvData && this.csvData.length === this.questions.length) {
                    return this.getCSVString();
                }
                const csvRowsData = this.questions.map((q, idx) => {
                    const transformedQ = this.transformToAdvancedFormat(q, idx);
                    const firstType = q.parts && q.parts.length > 0 ? (this.questionTypeConfigs[q.parts[0].type]?.jsonType || q.parts[0].type) : "";
                    return [
                        transformedQ.metadata.id,
                        transformedQ.metadata.language,
                        '', 
                        firstType,
                        transformedQ.metadata.category,
                        Array.isArray(transformedQ.metadata.dialect) ? transformedQ.metadata.dialect.join(', ') : transformedQ.metadata.dialect
                    ];
                });

                const rows = csvRowsData.map(rowData =>
                    rowData.map(cell => this._formatCsvCell(cell)).join(',')
                );

                return header.join(',') + '\n' + rows.join('\n');
            }
            getCSVString() {
                const header = ['Question Id', 'Lang', 'Lesson Id', 'Attributes', 'Category', 'Dialect'];
                const rows = this.csvData.map(row => {
                    return header.map(col => this._formatCsvCell(row[col])).join(',');
                });
                return header.join(',') + '\n' + rows.join('\n');
            }
            
            // Subject Template ID Functions
            openSubjectTemplateModal() {
                if (this.questions.length === 0) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء تحليل الأسئلة أولاً.' : 'Please analyze questions first.', 'warning');
                    return;
                }
                
                document.getElementById('subjectTemplateModalBg').style.display = 'flex';
                document.getElementById('subjectSelect').value = '';
                this.updateSubjectQuestionsPreview();
            }
            
            closeSubjectTemplateModal() {
                document.getElementById('subjectTemplateModalBg').style.display = 'none';
            }
            
            updateSubjectQuestionsPreview() {
                const selectedSubject = document.getElementById('subjectSelect').value;
                const previewContainer = document.getElementById('subjectQuestionsPreview');
                
                if (!selectedSubject) {
                    this.setSafeHTML(previewContainer, '<p style="text-align:center; color:#6b7280;">ستظهر الأسئلة المؤهلة هنا بعد اختيار المادة</p>');
                    return;
                }
                
                const templateId = this.subjectTemplateMap[selectedSubject];
                if (!templateId) {
                    this.setSafeHTML(previewContainer, '<p style="text-align:center; color:#ef4444;">خطأ: لم يتم العثور على Template ID لهذه المادة</p>');
                    return;
                }
                
                const eligibleQuestions = this.questions.filter((q, index) => {
                    return q.parts.some(part => 
                        part.type === this.QuestionType.FRQ_AI || 
                        part.type === this.QuestionType.STRING
                    );
                });
                
                if (eligibleQuestions.length === 0) {
                    this.setSafeHTML(previewContainer, '<p style="text-align:center; color:#f59e0b;">لا توجد أسئلة من نوع frq_ai أو string لتطبيق Template ID عليها</p>');
                    return;
                }
                
                let html = `<div style="margin-bottom:15px; padding:10px; background:#dcfce7; border-radius:8px; border:1px solid #16a34a;">
                    <strong>المادة المختارة:</strong> ${selectedSubject}<br>
                    <strong>Template ID:</strong> ${templateId}<br>
                    <strong>عدد الأسئلة المؤهلة:</strong> ${eligibleQuestions.length}
                </div>`;
                
                html += '<div style="max-height:200px; overflow-y:auto;">';
                eligibleQuestions.forEach((q, index) => {
                    const questionId = q.metadata.id;
                    const parts = q.parts.filter(part => 
                        part.type === this.QuestionType.FRQ_AI || 
                        part.type === this.QuestionType.STRING
                    );
                    
                    html += `<div style="margin-bottom:10px; padding:8px; background:white; border-radius:6px; border:1px solid #e2e8f0;">
                        <strong>السؤال ${index + 1} (ID: ${questionId})</strong><br>
                        <small>الأجزاء المؤهلة: ${parts.map(p => p.type).join(', ')}</small>
                    </div>`;
                });
                html += '</div>';
                
                this.setSafeHTML(previewContainer, html);
            }
            
            saveSubjectTemplateData() {
                const selectedSubject = document.getElementById('subjectSelect').value;
                
                if (!selectedSubject) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء اختيار مادة أولاً' : 'Please select a subject first', 'warning');
                    return;
                }
                
                const templateId = this.subjectTemplateMap[selectedSubject];
                if (!templateId) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'خطأ: لم يتم العثور على Template ID لهذه المادة' : 'Error: Template ID not found for this subject', 'error');
                    return;
                }
                
                let appliedCount = 0;
                
                this.questions.forEach(q => {
                    q.parts.forEach(part => {
                        if (part.type === this.QuestionType.FRQ_AI || part.type === this.QuestionType.STRING) {
                            part.metadata.ai_template_id = templateId;
                            appliedCount++;
                        }
                    });
                    
                    if (q.parts.some(part => part.type === this.QuestionType.FRQ_AI || part.type === this.QuestionType.STRING)) {
                        q.metadata.ai_template_id = templateId;
                    }
                });
                
                this.showMessage(
                    this.language === this.Language.ARABIC 
                        ? `تم تطبيق Template ID (${templateId}) على ${appliedCount} جزء من الأسئلة` 
                        : `Applied Template ID (${templateId}) to ${appliedCount} question parts`, 
                    'success'
                );
                
                this.closeSubjectTemplateModal();
                
                if (document.getElementById('jsonOutput').style.display === 'block') {
                    this.convertToJSON();
                }
                
                this.displayResults();
            }

            // --- TAGS MODAL ---
            populateTagsModal() {
                const templates = [
                    { name: 'MCQ', hint: 'إدراج قالب سؤال اختيار من متعدد', content: 'type: mcq\n@STEM\n\n@CHOICES\n* \n- \n- \n- \n---\n' },
                    { name: 'Matching', hint: 'إدراج قالب سؤال توصيل', content: 'type: matching\n@STEM\n\n@MATCHING_PAIRS\n | \n | \n---\n' },
                    { name: 'Gap Text', hint: 'إدراج قالب سؤال ملء فراغات', content: 'type: gapText\n@STEM\n@BLANK\n@GAPS\n\n---\n' },
                ];

                const tags = [
                    { tag: '@STEM', hint: 'نص السؤال الرئيسي' },
                    { tag: '@CHOICES', hint: 'قائمة الاختيارات' },
                    { tag: '@ANSWER', hint: 'الإجابة الصحيحة (لأسئلة String, FRQ)' },
                    { tag: '@GAPS', hint: 'إجابات ملء الفراغات (كل إجابة في سطر)' },
                    { tag: '@MATCHING_PAIRS', hint: 'أزواج المطابقة (افصل بينها بـ |)' },
                    { tag: '@BLANK', hint: 'فجوة أو مسافة فارغة داخل النص' },
                    { tag: '@STATEMENT', hint: 'النص الاستهلالي الذي يسبق أجزاء السؤال' },
                    { tag: '@PART', hint: 'لتقسيم السؤال إلى أجزاء متعددة' },
                    { tag: '[U]', hint: 'لوضع خط تحت النص، استخدمه هكذا: [U]النص[/U]' },
                    { tag: '---', hint: 'خط فاصل بين الأسئلة' },
                ];
                
                const templatesContainer = document.querySelector('#templates-section .tags-grid');
                const tagsContainer = document.querySelector('#tags-section .tags-grid');
                
                templatesContainer.innerHTML = '';
                tagsContainer.innerHTML = '';

                templates.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn';
                    btn.textContent = t.name;
                    btn.title = t.hint;
                    btn.dataset.tag = t.content;
                    templatesContainer.appendChild(btn);
                });

                tags.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = 'tag-btn';
                    btn.textContent = t.tag;
                    btn.title = t.hint;
                    btn.dataset.tag = t.tag;
                    tagsContainer.appendChild(btn);
                });

                document.getElementById('tagsModalBody').addEventListener('click', (e) => {
                    if (e.target.classList.contains('tag-btn')) {
                        this.insertTag(e.target.dataset.tag);
                    }
                });
            }

            insertTag(tag) {
                const textarea = document.getElementById('questionInput');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                textarea.value = before + tag + after;
                textarea.selectionStart = textarea.selectionEnd = start + tag.length;
                textarea.focus();
            }

            toggleTagsModal(show) {
                const modal = document.getElementById('tagsModal');
                const isVisible = modal.style.display === 'block';
                modal.style.display = typeof show === 'boolean' ? (show ? 'block' : 'none') : (isVisible ? 'none' : 'block');
            }

            makeModalDraggable() {
                const modal = document.getElementById('tagsModal');
                const header = document.getElementById('tagsModalHeader');
                let isDragging = false;
                let offsetX, offsetY;

                header.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    offsetX = e.clientX - modal.offsetLeft;
                    offsetY = e.clientY - modal.offsetTop;
                    document.body.style.userSelect = 'none';
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        modal.style.left = `${e.clientX - offsetX}px`;
                        modal.style.top = `${e.clientY - offsetY}px`;
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                    document.body.style.userSelect = '';
                });
            }

            // --- NEW FEATURES ---
            cleanAndFormat() {
                const textarea = document.getElementById('questionInput');
                let text = textarea.value;
                
                // This is a very basic formatter and might not work for all cases.
                // It looks for a line of text followed by a numbered/lettered list.
                const questionRegex = /^(.*?)[\n\r]+((?:[a-zA-Z\u0623-\u064A0-9]+[.)]\s*.*[\n\r]*)+)/gm;
                
                const formattedText = text.replace(questionRegex, (match, stem, choices) => {
                    const choiceLines = choices.trim().split(/[\n\r]+/).map(line => {
                        // Remove the leading bullet/number (e.g., "a)", "1.", etc.)
                        return '- ' + line.replace(/^[a-zA-Z\u0623-\u064A0-9]+[.)]\s*/, '').trim();
                    }).join('\n');
                    
                    return `type: mcq\n@STEM\n${stem.trim()}\n@CHOICES\n${choiceLines}\n---`;
                });

                textarea.value = formattedText;
                this.showMessage('تمت محاولة تنظيف وتنسيق النص.', 'success');
                this.runLiveValidation();
            }

            runLiveValidation() {
                const text = document.getElementById('questionInput').value;
                const blocks = text.trim().split(/\n---\n/);
                
                this.questions = blocks.filter(block => block.trim()).map((block, index) => {
                    const q = this._parseQuestionBlock(block, index);
                    q.validationWarning = this.validateQuestion(q);
                    return q;
                });
                
                this.displayResults();
            }

            validateQuestion(q) {
                for (const part of q.parts) {
                    if (part.type === this.QuestionType.MCQ) {
                        if (!Array.isArray(part.answer) && part.answer === undefined) {
                            return 'سؤال الاختيار من متعدد يجب أن يحتوي على إجابة صحيحة واحدة (*).';
                        }
                    }
                    if (part.type === this.QuestionType.MATCHING) {
                        if (!part.pairs || part.pairs.some(p => p.length !== 2)) {
                            return 'كل سطر في سؤال التوصيل يجب أن يحتوي على عنصرين يفصل بينهما "|".';
                        }
                    }
                }
                return null; // No validation errors
            }

            autoSaveContent() {
                const content = document.getElementById('questionInput').value;
                localStorage.setItem('aiq_autosave_content', content);
                this.logger.info('Content auto-saved.');
            }
            
            loadAutoSavedContent() {
                const savedContent = localStorage.getItem('aiq_autosave_content');
                if (savedContent) {
                    document.getElementById('questionInput').value = savedContent;
                    this.showMessage('تم استعادة المحتوى المحفوظ تلقائيًا.', 'success');
                    this.runLiveValidation();
                }
            }

            handleChoiceClick(element) {
                const questionId = element.dataset.questionId;
                const choiceIndex = parseInt(element.dataset.choiceIndex, 10);
                const partIndex = parseInt(element.closest('.part-preview').dataset.partIndex, 10);

                const question = this.questions.find(q => q.metadata.id === questionId);
                if (!question || !question.parts[partIndex]) return;

                const part = question.parts[partIndex];

                if (part.type === this.QuestionType.MCQ) {
                    part.answer = choiceIndex;
                } else if (part.type === this.QuestionType.MRQ) {
                    if (!Array.isArray(part.answer)) part.answer = [];
                    const answerIndex = part.answer.indexOf(choiceIndex);
                    if (answerIndex > -1) {
                        part.answer.splice(answerIndex, 1);
                    } else {
                        part.answer.push(choiceIndex);
                    }
                }

                this._regenerateQuestionContent(question);
                this.updateTextareaFromQuestions();
                this.updateUIAfterChange();
            }

            _regenerateQuestionContent(question) {
                let newContentBlock = '';
                if (question.statement) {
                    newContentBlock += `@STATEMENT\n${question.statement}\n`;
                }

                question.parts.forEach(part => {
                    if (question.statement) {
                        newContentBlock += `@PART\n`;
                    }
                    newContentBlock += `type: ${part.type}\n`;
                    newContentBlock += `@STEM\n${part.stem}\n`;

                    if (part.type === 'mcq' || part.type === 'mrq' || part.type === 'oq') {
                        newContentBlock += `@CHOICES\n`;
                        const correctAnswers = new Set(Array.isArray(part.answer) ? part.answer : [part.answer]);
                        part.choices.forEach((choice, i) => {
                            const prefix = correctAnswers.has(i) ? '* ' : '- ';
                            newContentBlock += `${prefix}${choice}\n`;
                        });
                    }
                    // Add other types here if needed
                });
                question._contentBlock = newContentBlock.trim();
            }

            updateTextareaFromQuestions() {
                const fullText = this.questions.map(q => {
                    return (q._metaHeader + q._contentBlock).trim();
                }).join('\n---\n');
                document.getElementById('questionInput').value = fullText;
                this.autoSaveContent(); // Save changes after programmatic update
            }
            
            syntaxHighlight(json) {
                json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return json.replace(
                    /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
                    (match) => {
                        let cls = 'number';
                        if (/^"/.test(match)) {
                            cls = /:$/.test(match) ? 'key' : 'string';
                        } else if (/true|false/.test(match)) {
                            cls = 'boolean';
                        } else if (/null/.test(match)) {
                            cls = 'null';
                        }
                        return '<span class="' + cls + '">' + match + '</span>';
                    }
                );
            }

            // =================================================================
            // NEW AND REFACTORED AI & MODAL METHODS
            // =================================================================

            _getApiKey() {
                return this.aiProvider === 'gemini' 
                    ? document.getElementById('geminiApiKey').value.trim()
                    : document.getElementById('openaiApiKey').value.trim();
            }

            setAIProvider(provider) {
                this.aiProvider = provider;
                this._updateApiProviderUI();
            }

            _updateApiProviderUI() {
                document.getElementById('gemini-key-container').style.display = this.aiProvider === 'gemini' ? 'block' : 'none';
                document.getElementById('openai-key-container').style.display = this.aiProvider === 'openai' ? 'block' : 'none';
            }

            populateGenerationModal() {
                const container = document.getElementById('gen-q-types-container');
                if (!container) {
                    this.logger.error("Generation modal container #gen-q-types-container not found.");
                    return;
                }
                container.innerHTML = ''; // Clear existing content

                if (!this.questionTypeConfigs) {
                     this.logger.error("Question type configs not available for generation modal.");
                     return;
                }

                const orderedTypes = [
    this.QuestionType.MCQ, 
    this.QuestionType.MRQ, 
    this.QuestionType.MATCHING,
    this.QuestionType.OQ,          // <-- تمت إضافته
    this.QuestionType.GAP_TEXT,
    this.QuestionType.INPUT_BOX,  // <-- تمت إضافته
    this.QuestionType.STRING, 
    this.QuestionType.FRQ,
    this.QuestionType.FRQ_AI      // <-- تمت إضافته
];

                for (const typeKey of orderedTypes) {
                    if (!this.questionTypeConfigs[typeKey]) continue;

                    const config = this.questionTypeConfigs[typeKey];
                    const row = document.createElement('div');
                    row.className = 'gen-q-type-row';

                    const label = document.createElement('label');
                    label.htmlFor = `gen-q-count-${typeKey}`;
                    label.textContent = config.label;

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `gen-q-count-${typeKey}`;
                    input.min = '0';
                    input.value = (typeKey === this.QuestionType.MCQ) ? '5' : '0'; 
                    input.dataset.type = typeKey;

                    row.appendChild(label);
                    row.appendChild(input);
                    container.appendChild(row);
                }
            }

            openGenerationModal() {
                document.getElementById('generationModalBg').style.display = 'flex';
            }

            closeGenerationModal() {
                document.getElementById('generationModalBg').style.display = 'none';
                // Reset fields
                document.getElementById('gen-text-input').value = '';
                document.getElementById('gen-custom-prompt').value = '';
                document.getElementById('gen-image-preview').style.display = 'none';
                document.getElementById('gen-image-preview').src = '';
                this.uploadedImageBase64 = null;
            }

            setupImageDropZone() {
                const dropZone = document.getElementById('gen-image-drop-zone');
                const fileInput = document.getElementById('gen-image-input');
                const imagePreview = document.getElementById('gen-image-preview');

                const handleFile = (file) => {
                    if (file && file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreview.style.display = 'block';
                            this.uploadedImageBase64 = e.target.result.split(',')[1];
                        };
                        reader.readAsDataURL(file);
                    } else {
                        this.showMessage('Please drop an image file.', 'warning');
                    }
                };

                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    handleFile(e.dataTransfer.files[0]);
                });
            }

            async generateQuestionsWithAI() {
                const apiKey = this._getApiKey();
                if (!apiKey) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء إدخال مفتاح API أولاً' : 'Please enter an API key first', 'warning');
                    return;
                }

                const contextText = document.getElementById('gen-text-input').value.trim();
                if (!contextText && !this.uploadedImageBase64) {
                    this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء إدخال نص أو رفع صورة' : 'Please enter text or upload an image', 'warning');
                    return;
                }

                const generateBtn = document.getElementById('modal-generate-btn');
                const originalText = generateBtn.innerHTML;
                generateBtn.innerHTML = `<div class="spinner"></div> ${this.language === this.Language.ARABIC ? 'جاري التوليد...' : 'Generating...'}`;
                generateBtn.disabled = true;

                try {
                    const questionRequests = [];
                    document.querySelectorAll('#gen-q-types-container input').forEach(input => {
                        const count = parseInt(input.value, 10);
                        if (count > 0) {
                            questionRequests.push(`- ${count} ${input.dataset.type.toUpperCase()} questions`);
                        }
                    });

                    if (questionRequests.length === 0) {
                        this.showMessage(this.language === this.Language.ARABIC ? 'الرجاء تحديد عدد الأسئلة المراد توليدها' : 'Please specify the number of questions to generate', 'warning');
                        return;
                    }
                    
                    const customPrompt = document.getElementById('gen-custom-prompt').value.trim();
                    
                    const languageInstruction = this.language === this.Language.ARABIC
                        ? 'Generate the questions in Arabic.'
                        : 'Generate the questions in English.';

                    let prompt = `Based on the following context, generate questions in the specified format.
**${languageInstruction}**

Context:
${contextText}

Generate exactly these questions:
${questionRequests.join('\n')}

${customPrompt ? `Additional Instructions: ${customPrompt}` : ''}

**Mathematics Rules (Crucial and must be followed precisely):**
- Wrap inline math like $x^2$ with single backticks: \`x^2\`.
- Wrap display math like $$...$$ or LaTeX environments like \\begin{...} with double backticks: \`\`...\`\`.
- **Never** generate math with '$' delimiters. Always use backticks.

Strictly follow this formatting for each question:
- Start with 'type: [question_type]'.
- Use @STEM for the question text.
- Use @CHOICES for MCQ/MRQ options, with '*' for correct and '-' for incorrect answers.
- **For any list like @CHOICES or @GAPS, you MUST put each item on a new line.** // <<< أضف هذا السطر
- Use @ANSWER for string/frq answers.
- Use @MATCHING_PAIRS for matching questions, separated by '|'.
- Use @GAPS for gap-fill answers.
- Separate each complete question block with '---'.
`;

                    const aiResponse = await this._callAI(prompt, apiKey, this.uploadedImageBase64);
                    const formattedQuestions = this.postProcessAIFormatted(aiResponse);

                    const mainTextarea = document.getElementById('questionInput');
                    const separator = mainTextarea.value.trim() ? '\n---\n' : '';
                    mainTextarea.value += separator + formattedQuestions;

                    this.closeGenerationModal();
                    this.showMessage(this.language === this.Language.ARABIC ? 'تم توليد الأسئلة بنجاح!' : 'Questions generated successfully!', 'success');
                    await this.smartAnalyze();

                } catch (error) {
                    this.logger.error('AI Question Generation Error:', error);
                    this.showMessage(`${this.language === this.Language.ARABIC ? 'خطأ في التوليد: ' : 'Generation error: '}${error.message}`, 'error');
                } finally {
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                }
            }
            
            async _callAI(prompt, apiKey, imageBase64 = null) {
                this.aiAbortController?.abort();
                this.aiAbortController = new AbortController();
                const timer = setTimeout(() => this.aiAbortController.abort(), 60000); // 60s timeout

                try {
                    let endpoint, options;

                    if (this.aiProvider === 'gemini') {
                        endpoint = this.config.api.geminiEndpoint + encodeURIComponent(apiKey);
                        const parts = [{ text: prompt }];
                        if (imageBase64) {
                            parts.push({ inline_data: { mime_type: 'image/jpeg', data: imageBase64 } });
                        }
                        options = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ role: 'user', parts: parts }],
                                generationConfig: { temperature: 0.3, topK: 40, topP: 0.95, maxOutputTokens: 8192 }
                            }),
                            signal: this.aiAbortController.signal
                        };
                    } else { // openai
                        endpoint = this.config.api.openaiEndpoint;
                        const content = [{ type: 'text', text: prompt }];
                        if (imageBase64) {
                            content.push({ type: 'image_url', image_url: { url: `data:image/jpeg;base64,${imageBase64}` } });
                        }
                        options = {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey}`
                            },
                            body: JSON.stringify({
                                model: imageBase64 ? "gpt-4o" : "gpt-4-turbo",
                                messages: [{ role: 'user', content: content }],
                                temperature: 0.3,
                                max_tokens: 4096
                            }),
                            signal: this.aiAbortController.signal
                        };
                    }

                    const response = await fetch(endpoint, options);
                    clearTimeout(timer);

                    if (!response.ok) {
                        const txt = await response.text().catch(() => '');
                        throw new Error(`API Error ${response.status}: ${txt || response.statusText}`);
                    }

                    const data = await response.json();

                    if (this.aiProvider === 'gemini') {
                        if (data?.promptFeedback?.blockReason) {
                            throw new Error(`Blocked by safety: ${data.promptFeedback.blockReason}`);
                        }
                        return data?.candidates?.[0]?.content?.parts?.find(p => typeof p.text === 'string')?.text || '';
                    } else { // openai
                        return data?.choices?.[0]?.message?.content || '';
                    }

                } catch (error) {
                    clearTimeout(timer);
                    this.logger.error('API call failed:', error);
                    throw error;
                }
            }
        }
        const app = new AIQuestionConverter();
    });
    </script>
</body>
</html>
